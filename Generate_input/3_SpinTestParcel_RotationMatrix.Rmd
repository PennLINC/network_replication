---
title: "Spin Test Parcel Rotation Matrix"
author: "Audrey Luo"
date: "2022-06-01"
output: html_document
---

This Rmd file using rotate_parcellation to generate 10k rotated permutations of a parcellation, given the coordinates of left and right hemispheres of this parcellation on the sphere.

The output is a vector of 1:Number_of_parcels for each permutation which tries to conserve the relative position of each parcel

- Schaefer .annot files were downloaded from: https://github.com/ThomasYeoLab/CBIG/tree/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/FreeSurfer5.3/fsaverage/label

- glasser_spherical_coords.csv was downloaded from 
https://github.com/frantisekvasa/rotate_parcellation/blob/master/sphere_HCP.txt (and renamed)

```{r setup}
# rotate.parcellation.R and perm.sphere.p.R are downloaded from https://github.com/frantisekvasa/rotate_parcellation
source("/cbica/projects/network_replication/software/rotate.parcellation.R")
source("/cbica/projects/network_replication/software/perm.sphere.p.R")
```


# Extract parcel centroid coordinates on the fsaverage sphere from Schaefer .annot files
```{r}

library(freesurfer)
library(freesurferformats)

# load freesurfer fsaverage surface
lh <- read.fs.surface("/cbica/projects/network_replication/software/rotate_parcellation/lh.sphere") # downloaded from freesurfer/subjects/fsaverage/surf
rh <- read.fs.surface("/cbica/projects/network_replication/software/rotate_parcellation/rh.sphere")

extract_centroid_coords <- function(schaefer_atlas, network_parcellation) {
  lh.schaefer.annot <- read_annotation(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/annot/lh.Schaefer2018_%1$sParcels_%2$sNetworks_order.annot", schaefer_atlas, network_parcellation))
  rm <- which(lh.schaefer.annot$colortable$label=="Background+FreeSurfer_Defined_Medial_Wall")
  lhcoords <- t(sapply(c(1:length(lh.schaefer.annot$colortable$label))[-rm], function(x) colMeans(lh$vertices[which(lh.schaefer.annot$label==lh.schaefer.annot$colortable$code[x]),]) ))
  
  rh.schaefer.annot <- read_annotation(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/annot/rh.Schaefer2018_%1$sParcels_%2$sNetworks_order.annot", schaefer_atlas, network_parcellation))
  rm <- which(rh.schaefer.annot$colortable$label=="Background+FreeSurfer_Defined_Medial_Wall")
  rhcoords <- t(sapply(c(1:length(rh.schaefer.annot$colortable$label))[-rm], function(x) colMeans(rh$vertices[which(rh.schaefer.annot$label==rh.schaefer.annot$colortable$code[x]),]) ))
  
  schaefer.fsaverage.coords <- rbind(lhcoords,rhcoords)
  write.csv(schaefer.fsaverage.coords, sprintf("/cbica/projects/network_replication/software/rotate_parcellation/schaefer%1$sx%2$s_sphericalcoords.csv", schaefer_atlas, network_parcellation), row.names=F)
    
} 
 
extract_centroid_coords(200, 7) # schaefer200x7
extract_centroid_coords(200, 17) # schaefer200x17
extract_centroid_coords(400, 7) # schaefer400x7
extract_centroid_coords(400, 17) # schaefer400x17

 
```

```{r schaefer200x7}
schaefer200.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x7_sphericalcoords.csv") #coordinates of schaefer200.coords parcel centroids on the freesurfer sphere. 

lh.schaefer.annot <- read_annotation(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/annot/lh.Schaefer2018_%1$sParcels_%2$sNetworks_order.annot", 200, 7))
rh.schaefer.annot <- read_annotation(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/annot/rh.Schaefer2018_%1$sParcels_%2$sNetworks_order.annot", 200, 7))

label <- data.frame(c(lh.schaefer.annot$colortable[2:101,1], rh.schaefer.annot$colortable[2:101,1]))
schaefer200.coords <- cbind(label, schaefer200.coords)
names(schaefer200.coords)[1] <- "label" # Reorder this file in 2_parcelLabel_format.Rmd before going to next step

write.csv(schaefer200.coords, sprintf("/cbica/projects/network_replication/software/rotate_parcellation/schaefer%1$sx%2$s_sphericalcoords.csv", 200, 7), row.names=F)

######

schaefer200.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x7_sphericalcoords_reordered.csv") #coordinates of schaefer200.coords parcel centroids on the freesurfer sphere, now reordered


perm.id.full <- rotate.parcellation(coord.l = as.matrix(schaefer200.coords[1:100,3:5]), coord.r = as.matrix(schaefer200.coords[101:200,3:5]), nrot = 10000) #rotate the schaefer200.coords parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 
 
saveRDS(perm.id.full, "/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x7.coords_sphericalrotations_N10k.rds")

```

```{r schaefer200x17}
schaefer200.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x17_sphericalcoords.csv") #coordinates of schaefer200.coords parcel centroids on the freesurfer sphere

perm.id.full <- rotate.parcellation(coord.l = as.matrix(schaefer200.coords[1:100,1:3]), coord.r = as.matrix(schaefer200.coords[101:200,1:3]), nrot = 10000) #rotate the schaefer200.coords parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 
 
saveRDS(perm.id.full, "/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x17.coords_sphericalrotations_N10k.rds")
```

```{r schaefer400x7}
schaefer400.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/schaefer400x7_sphericalcoords.csv") #coordinates of schaefer400.coords parcel centroids on the freesurfer sphere. Reordered in 2_parcelLabel_format.Rmd.
lh.schaefer.annot <- read_annotation(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/annot/lh.Schaefer2018_%1$sParcels_%2$sNetworks_order.annot", 400, 7))
rh.schaefer.annot <- read_annotation(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/annot/rh.Schaefer2018_%1$sParcels_%2$sNetworks_order.annot", 400, 7))

label <- data.frame(c(lh.schaefer.annot$colortable[2:201,1], rh.schaefer.annot$colortable[2:201,1]))
schaefer400.coords <- cbind(label, schaefer400.coords)
names(schaefer400.coords)[1] <- "label" # Reorder this file in 2_parcelLabel_format.Rmd before going to next step

write.csv(schaefer400.coords, sprintf("/cbica/projects/network_replication/software/rotate_parcellation/schaefer%1$sx%2$s_sphericalcoords.csv", 400, 7), row.names=F)

######
schaefer400.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/schaefer400x7_sphericalcoords_reordered.csv") #coordinates of schaefer400.coords parcel centroids on the freesurfer sphere, now reordered


perm.id.full <- rotate.parcellation(coord.l = as.matrix(schaefer400.coords[1:200,3:5]), coord.r = as.matrix(schaefer400.coords[201:400,3:5]), nrot = 10000) #rotate the schaefer400.coords parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 

saveRDS(perm.id.full, "/cbica/projects/network_replication/software/rotate_parcellation/schaefer400x7.coords_sphericalrotations_N10k.rds")

```

```{r schaefer400x17}
schaefer400.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/schaefer400x17_sphericalcoords.csv") #coordinates of schaefer400.coords parcel centroids on the freesurfer sphere

perm.id.full <- rotate.parcellation(coord.l = as.matrix(schaefer400.coords[1:200,1:3]), coord.r = as.matrix(schaefer400.coords[201:400,1:3]), nrot = 10000) #rotate the schaefer400.coords parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 

saveRDS(perm.id.full, "/cbica/projects/network_replication/software/rotate_parcellation/schaefer400x17.coords_sphericalrotations_N10k.rds")
```

```{r glasser}
glasser.coords <- read.csv("/cbica/projects/network_replication/software/rotate_parcellation/glasser_spherical_coords.csv", header=F) #coordinates of glasser parcel centroids on the freesurfer sphere

perm.id.full <- rotate.parcellation(coord.l = as.matrix(glasser.coords[181:360,]), coord.r = as.matrix(glasser.coords[1:180,]), nrot = 10000) #rotate the glasser.coords parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 
 

saveRDS(perm.id.full, "/cbica/projects/network_replication/software/rotate_parcellation/glasser.coords_sphericalrotations_N10k.rds")
```

```{r gordon}
library(fabisearch) # load gordon atlas coordinates
gordon.coords <- gordatlas[2:4]  #coordinates of gordon.coords parcel centroids on the freesurfer sphere
 
perm.id.full <- rotate.parcellation(coord.l = as.matrix(gordon.coords[1:161,]), coord.r = as.matrix(gordon.coords[162:333,]), nrot = 10000) #rotate the gordon.coords parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 

saveRDS(perm.id.full, "/cbica/projects/network_replication/software/rotate_parcellation/gordon.coords_sphericalrotations_N10k.rds")
```

