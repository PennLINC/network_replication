---
title: "Makes Fig 1, 3, and 6"
author: "Audrey Luo"
output: html_document
---

Makes Figures 1, 3, and 6
```{r setup, include=FALSE}

library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggsegSchaefer)
library(ggsegGlasser)
library(ggsegGordon)
library(ggcorrplot)
library(viridis)
library(scales)
library(stringr)
library(tidyr)
library(ggpubr)
library(purrr)
library(pammtools)
 
library(gratia)

source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/DevEffect_Figures.R")
source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/netrep_spinTests.R")
source("/cbica/projects/network_replication/software/perm.sphere.p.R")

atlases_GBC <- c("glasser", "gordon", "schaefer200", "schaefer400")
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
```
 
 
 
# **Figure 1A** 
## Spatial correlation across all 4 datasets (for GBC in Schaefer200)
```{r corrplot, fig.height=3, fig.width=3}
library(ggcorrplot)
library(corrplot)
library(Hmisc)


PNC <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", "PNC", "GBC", "GBC.axis_schaefer200"))
NKI <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", "NKI", "GBC", "GBC.axis_schaefer200"))
HCPD <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", "HCPD", "GBC", "GBC.axis_schaefer200"))
HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", "HBN", "GBC", "GBC.axis_schaefer200"))

 
dat2 <- bind_cols(PNC$label, as.numeric(PNC$GAM.age.AdjRsq), NKI$GAM.age.AdjRsq, HCPD$GAM.age.AdjRsq, HBN$GAM.age.AdjRsq)
names(dat2) <- c("label", "PNC", "NKI", "HCPD", "HBN")
 
  
corr <- round(cor(dat2[,-1], use = "complete.obs"), 5)
  
 
# compute matrix of correlation p-values
p.mat <- cor_pmat(dat2[,-1])


#############
## figure ##
#############
# Visualize the correlation matrix
(correlation_matrix <- ggcorrplot(corr,  
   lab = FALSE, type = "lower",
   outline.col = "white",
   ggtheme = ggplot2::theme_void, lab_size = 4, 
   hc.order = FALSE, insig = "blank", p.mat=p.mat)  +
   scale_fill_gradient2(low = "white",
  mid = "#E5B9ADFF",
  high = "#A50026FF", midpoint=0.5,limit= c(0, 1)) + 
 theme(axis.text=element_text(size=20, color = "black")))  

 
schaefer200x17.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x17_regionlist_final.csv")
schaefer200.parcel.labels <- schaefer200x17.parcel.labels #gbc

# spin test
perm.id.full_schaefer200x17 <- readRDS("/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x17.coords_sphericalrotations_N10k.rds")
 
# GBC - make df.dev.spin_GBC_schaefer200 
parcel.labels <- schaefer200.parcel.labels$label
df.dev.spin_PNC <- rbind(PNC[1:c(length(parcel.labels)/2),], PNC[c(length(parcel.labels)/2+1):length(parcel.labels),]) 
df.dev.spin_NKI <- rbind(NKI[1:c(length(parcel.labels)/2),], NKI[c(length(parcel.labels)/2+1):length(parcel.labels),])
df.dev.spin_HCPD <- rbind(HCPD[1:c(length(parcel.labels)/2),], HCPD[c(length(parcel.labels)/2+1):length(parcel.labels),])
df.dev.spin_HBN <- rbind(HBN[1:c(length(parcel.labels)/2),], HBN[c(length(parcel.labels)/2+1):length(parcel.labels),])

# spatial correlation of GAM adjusted age Rsq between all pairs of datasets
corr.PNC_NKI <- cor.test(PNC$GAM.age.AdjRsq, NKI$GAM.age.AdjRsq, method=c("pearson"), exact=F)$estimate # r = 0.8804216 
corr.PNC_HCPD <- cor.test(PNC$GAM.age.AdjRsq, HCPD$GAM.age.AdjRsq, method=c("pearson"), exact=F)$estimate # r = 0.8279745  
corr.PNC_HBN <- cor.test(PNC$GAM.age.AdjRsq, HBN$GAM.age.AdjRsq, method=c("pearson"), exact=F)$estimate # r = 0.629025 

corr.NKI_HCPD <- cor.test(HCPD$GAM.age.AdjRsq, NKI$GAM.age.AdjRsq, method=c("pearson"), exact=F)$estimate # r = 0.6926665 
corr.NKI_HBN <- cor.test(HBN$GAM.age.AdjRsq, NKI$GAM.age.AdjRsq, method=c("pearson"), exact=F)$estimate # r = 0.4877164 
corr.HBN_HCPD <- cor.test(HBN$GAM.age.AdjRsq, HCPD$GAM.age.AdjRsq, method=c("pearson"), exact=F)$estimate # r = 0.7474711 
 
# do spin test for each pair of datasets' spatial correlation 
p_spin_PNC_NKI  <- perm.sphere.p(PNC$GAM.age.AdjRsq, NKI$GAM.age.AdjRsq, perm.id.full_schaefer200x17, corr.type='pearson') # pspin = 0
p_spin_PNC_HCPD <- perm.sphere.p(PNC$GAM.age.AdjRsq, HCPD$GAM.age.AdjRsq, perm.id.full_schaefer200x17, corr.type='pearson') # pspin = 0
p_spin_PNC_HBN  <- perm.sphere.p(PNC$GAM.age.AdjRsq, HBN$GAM.age.AdjRsq, perm.id.full_schaefer200x17, corr.type='pearson') # pspin = 0
p_spin_NKI_HCPD  <- perm.sphere.p(HCPD$GAM.age.AdjRsq, NKI$GAM.age.AdjRsq, perm.id.full_schaefer200x17, corr.type='pearson') # pspin = 0
p_spin_NKI_HBN  <- perm.sphere.p(HBN$GAM.age.AdjRsq, NKI$GAM.age.AdjRsq, perm.id.full_schaefer200x17, corr.type='pearson') # pspin = 0.00185
p_spin_HBN_HCPD  <- perm.sphere.p(HBN$GAM.age.AdjRsq, HCPD$GAM.age.AdjRsq, perm.id.full_schaefer200x17, corr.type='pearson') # pspin = 0

```
 

# **Figure 1C**
## Age-effect maps (parcels surviving FDR correction are colored)
```{r brain_surface}


PNC <- PNC %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
PNC$region <- PNC$label
PNC$region <- gsub("Network", "17Network", PNC$region)

PNC <- bind_cols(PNC$region, PNC$GAM.age.AdjRsq, PNC$significant.fdr)
names(PNC) <- c("region", "GAM.age.AdjRsq", "significant.fdr")
PNC$significant.fdr <- gsub("0", "Non_Sig", PNC$significant.fdr)
PNC$significant.fdr <- gsub("1", "Sig", PNC$significant.fdr)
 
  
 
NKI <- NKI %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
NKI$region <- NKI$label
NKI$region <- gsub("Network", "17Network", NKI$region)
NKI <- bind_cols(NKI$region, NKI$GAM.age.AdjRsq, NKI$significant.fdr)
names(NKI) <- c("region", "GAM.age.AdjRsq", "significant.fdr")
NKI$significant.fdr <- gsub("0", "Non_Sig", NKI$significant.fdr)
NKI$significant.fdr <- gsub("1", "Sig", NKI$significant.fdr)

 


HCPD <- HCPD %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
HCPD$region <- HCPD$label
HCPD$region <- gsub("Network", "17Network", HCPD$region)
HCPD <- bind_cols(HCPD$region, HCPD$GAM.age.AdjRsq, HCPD$significant.fdr)
names(HCPD) <- c("region", "GAM.age.AdjRsq", "significant.fdr")
HCPD$significant.fdr <- gsub("0", "Non_Sig", HCPD$significant.fdr)
HCPD$significant.fdr <- gsub("1", "Sig", HCPD$significant.fdr)

HBN <- HBN %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
HBN$region <- HBN$label
HBN$region <- gsub("Network", "17Network", HBN$region)
HBN <- bind_cols(HBN$region, HBN$GAM.age.AdjRsq, HBN$significant.fdr)
names(HBN) <- c("region", "GAM.age.AdjRsq", "significant.fdr")
HBN$significant.fdr <- gsub("0", "Non_Sig", HBN$significant.fdr)
HBN$significant.fdr <- gsub("1", "Sig", HBN$significant.fdr)
 


range(PNC$GAM.age.AdjRsq) # -0.0454746  0.1786336
range(NKI$GAM.age.AdjRsq) # -0.03423696  0.14100955
range(HCPD$GAM.age.AdjRsq) # -0.0884978  0.1574397
range(HBN$GAM.age.AdjRsq) # -0.07200049  0.08298452

ageEffect_surf.fig <- function(dataset_name){
  surf.fig <- ggplot() + geom_brain(data=get(dataset_name), 
                        atlas=schaefer17_200, 
                        mapping=aes(fill=GAM.age.AdjRsq, colour=significant.fdr, size=I(0.3)),
                        show.legend=FALSE, 
                        position = position_brain(hemi~side)) + scale_colour_manual(values = c(Sig = "black", Non_Sig = "grey84")) + 
      scale_fill_gradientn(colors= c("#8a0f63", "#FFFFFF","#f4b100"), limits = c(-0.05,0.15),  oob=squish,
                           values=rescale(c(-0.05,0,0.15))) +
      theme_void()
  return(surf.fig)
}
  
 
# PNC
ageEffect_surf_PNC <- ageEffect_surf.fig("PNC")
ageEffect_surf_PNC
  
# NKI
ageEffect_surf_NKI <- ageEffect_surf.fig("NKI")
ageEffect_surf_NKI
 
# HCPD
ageEffect_surf_HCPD <- ageEffect_surf.fig("HCPD")
ageEffect_surf_HCPD
 
# HBN
ageEffect_surf_HBN <- ageEffect_surf.fig("HBN")
ageEffect_surf_HBN
 

# get colorbar
ageEffect_surf_colorbar.fig <- function(dataset_name){
  surf.fig <- ggplot() + geom_brain(data=get(dataset_name), 
                        atlas=schaefer17_200, 
                        mapping=aes(fill=GAM.age.AdjRsq, colour=significant.fdr, size=I(0.3)),
                        show.legend=TRUE, 
                        position = position_brain(hemi~side)) + scale_colour_manual(values = c(Sig = "black", Non_Sig = "grey84")) + 
      scale_fill_gradientn(colors= c("#8a0f63", "#FFFFFF","#f4b100"), limits = c(-0.05,0.15),  oob=squish,
                           values=rescale(c(-0.05,0,0.15))) +
      theme_void()
  return(surf.fig)
}
  
ageEffect_surf_colorbar <- ageEffect_surf_colorbar.fig("PNC")
ageEffect_surf_colorbar
  
```

# **Figure 3: Include outliers**
## load figure df's - metric.axis_atlas
- loads the df's that were made in previous chunk. 
```{r load_figureDfs, include=FALSE, cache=TRUE}
 
GBC.axis_PNC <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", "PNC", "GBC", "GBC.axis_schaefer200"))
GBC.axis_NKI <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", "NKI", "GBC", "GBC.axis_schaefer200"))
GBC.axis_HCPD <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", "HCPD", "GBC", "GBC.axis_schaefer200"))
GBC.axis_HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", "HBN", "GBC", "GBC.axis_schaefer200"))

```


```{r make fig 3 w outliers, fig.height= 10, fig.width= 10}
gam_figure3_outliers <- function(dataset, axis, metric, atlas, r_text, x_pos, y_pos, ylim_lower, ylim_upper){
  axis <- axis %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
  AgeEffect_figure <- ggplot(axis, aes(x=SA.axis_rank, y=GAM.age.AdjRsq, fill = SA.axis_rank_signif)) + 
    geom_point(color = "gray", shape = 21, size=3.5) + 
    paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(axis$SA.axis_rank), max(axis$SA.axis_rank)), oob = squish) +
    paletteer::scale_color_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(axis$SA.axis_rank), max(axis$SA.axis_rank)), oob = squish) +
      labs(fill = "SA Axis Rank", x="\nSensorimotor-Association Axis Rank\n", y=expression(paste("Age Effect (Delta Adj", " R"^2, ")"))) +
      #ggtitle(paste(metric, "-", atlas)) + 
    
      geom_smooth(data = axis, method='lm', se=TRUE, fill=alpha(c("gray70"),.9), col="black") +
      theme(
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.line = element_line(color = "black"),
        axis.text=element_text(size=24, color = "black"),
        panel.background=element_blank(),  
        legend.position = "none",
        plot.title=element_text(hjust=0.5, size=24),
        plot.margin = margin(1, 1, 1, 1, "cm")) + scale_y_continuous(breaks = c(-0.05, 0, 0.05, 0.1, 0.15, 0.2), limits=c(ylim_lower, ylim_upper)) +     
     annotate(geom="text", x=x_pos, y=y_pos, label=r_text, color="black", size=7) + ggtitle(dataset)
  return(AgeEffect_figure)
}
 

# same corrs as in main analyses
r_text_GBC.schaefer200 <- expression(paste(italic("r"), " = -0.71, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200_PNC <- gam_figure3_outliers("PNC", GBC.axis_PNC, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                      x_pos= 140, y_pos=0.15, ylim_lower=-0.09, ylim_upper=0.18))


r_text_GBC.schaefer200 <- expression(paste(italic("r"), " = -0.56, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200_NKI <- gam_figure3_outliers("NKI", GBC.axis_NKI, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                      x_pos= 140, y_pos=0.15, ylim_lower=-0.09, ylim_upper=0.18))


r_text_GBC.schaefer200 <- expression(paste(italic("r"), " = -0.62, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200_HCPD <- gam_figure3_outliers("HCP-D", GBC.axis_HCPD, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                  x_pos= 140, y_pos=0.15, ylim_lower=-0.09, ylim_upper=0.18))


r_text_GBC.schaefer200 <- expression(paste(italic("r"), " = -0.72, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200_HBN <- gam_figure3_outliers("HBN", GBC.axis_HBN, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                  x_pos= 140, y_pos=0.15, ylim_lower=-0.09, ylim_upper=0.18))

plot_grid(GBC_schaefer200_PNC, GBC_schaefer200_HCPD, GBC_schaefer200_NKI, GBC_schaefer200_HBN, labels="auto", label_size=24)

```
 
  
 
# **Figure 6**
## Topographical surface plot 
```{r brain_surface}

SA.diff <- read.csv("/cbica/projects/network_replication/atlases/edge/SA.diff_schaefer200x7.csv")
make_double_age_df <- function(dataset) {
  if(dataset=="PNC" | dataset=="NKI") {
    gam.edge.age <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.schaefer200x7.RData", dataset, "edge"))
  } else {
    gam.edge.age <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.schaefer200x7_covbat.RData", dataset, "edge"))
  }
  
   
  age_SA.diff <- cbind(gam.edge.age, SA.diff)
  age_SA.diff <- sig_parcels(age_SA.diff) 

  # make a double df for symmetry - parcel1 and parcel2.SA.vec repeated in opposite ordering (see lines 500-510 in Adam's Edge-level-Age.md)
  age_SA.diff2 <- age_SA.diff 
  age_SA.diff2$parcel1.SA.vec <- age_SA.diff$parcel2.SA.vec
  age_SA.diff2$parcel2.SA.vec <- age_SA.diff$parcel1.SA.vec
  
  # "stacked" df
  double_age_SA.diff <- rbind(age_SA.diff2,age_SA.diff)
  print(paste0("double_age_SA.diff for ", dataset, " finished"))
   
  return(double_age_SA.diff)
}
  
 
double_age_SA.diff_PNC <- make_double_age_df("PNC")
double_age_SA.diff_NKI <- make_double_age_df("NKI")

double_age_SA.diff_HCPD <- make_double_age_df("HCPD")
double_age_SA.diff_HBN <- make_double_age_df("HBN")
 

range(double_age_SA.diff_PNC$GAM.age.AdjRsq) # -0.08405161  0.16685647
range(double_age_SA.diff_HCPD$GAM.age.AdjRsq) # -0.1178243  0.1875732
range(double_age_SA.diff_NKI$GAM.age.AdjRsq) # -0.1047854  0.1714589
range(double_age_SA.diff_HBN$GAM.age.AdjRsq) # -0.09254225  0.13344797


# visualize histograms of GAM.age.AdjRsq 
hist(double_age_SA.diff_PNC$GAM.age.AdjRsq)
hist(double_age_SA.diff_NKI$GAM.age.AdjRsq)
hist(double_age_SA.diff_HCPD$GAM.age.AdjRsq)
hist(double_age_SA.diff_HBN$GAM.age.AdjRsq)


```

 
```{r model_surface, fig.height= 12, fig.width= 8}

# find interval of GAM.age.AdjRsq that captures at least 65% of edges in each dataset (for plotting/visualizing purposes)
ll <- -0.014     ## lower bound of interval of interest
ul <- 0.015     ## upper bound of interval of interest

sum(double_age_SA.diff_PNC$GAM.age.AdjRsq > ll & double_age_SA.diff_PNC$GAM.age.AdjRsq < ul)/length(double_age_SA.diff_PNC$GAM.age.AdjRsq)
# 77%
sum(double_age_SA.diff_NKI$GAM.age.AdjRsq > ll & double_age_SA.diff_NKI$GAM.age.AdjRsq < ul)/length(double_age_SA.diff_NKI$GAM.age.AdjRsq)
# 76%
sum(double_age_SA.diff_HCPD$GAM.age.AdjRsq > ll & double_age_SA.diff_HCPD$GAM.age.AdjRsq < ul)/length(double_age_SA.diff_HCPD$GAM.age.AdjRsq)
# 66%
sum(double_age_SA.diff_HBN$GAM.age.AdjRsq > ll & double_age_SA.diff_HBN$GAM.age.AdjRsq < ul)/length(double_age_SA.diff_HBN$GAM.age.AdjRsq)
# 82%


# model the surface

make_surface_plot_datasets <- function(dataset) {
  double_age_SA.diff <- get(paste0("double_age_SA.diff_", dataset))
  g2 <- gam(GAM.age.AdjRsq ~ te(parcel2.SA.vec,parcel1.SA.vec,k=3),data = double_age_SA.diff)
 
  surface.plot.fig <- gg_tensor(g2)+theme_classic() +
    theme(
      axis.title.x=element_text(size=24, color = "black"),
      axis.title.y=element_text(size=24, color = "black"),
      axis.line = element_line(color = "black"),
      axis.text=element_text(size=24, color = "black")) + 
   scale_fill_gradientn(colors= c("#8a0f63", "#FFFFFF","#f4b100"), limits = c(-0.014,0.015), oob=squish, 
                           values=rescale(c(-0.014,0,0.015))) +
    xlab("Parcel SA Rank") + 
    ylab("Parcel SA Rank") + 
    geom_vline(xintercept = mean(range(double_age_SA.diff$parcel1.SA.vec)),
               linetype='dashed',size=1) + 
    geom_hline(yintercept = mean(range(double_age_SA.diff$parcel1.SA.vec)),
               linetype='dashed',size=1) +
    theme(legend.position='none')
  return(surface.plot.fig)
}
 
 
surfacePlot_PNC <- make_surface_plot_datasets("PNC")
surfacePlot_NKI <- make_surface_plot_datasets("NKI")

surfacePlot_HCPD <- make_surface_plot_datasets("HCPD")
surfacePlot_HBN <- make_surface_plot_datasets("HBN")

plot_grid(surfacePlot_PNC, surfacePlot_NKI, surfacePlot_HCPD, surfacePlot_HBN)
 

```

 
 