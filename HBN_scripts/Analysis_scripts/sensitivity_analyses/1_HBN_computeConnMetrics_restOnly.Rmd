---
title: "HBN Compute Functional Connectivity Metrics"
author: "Audrey Luo"
date: "2022-08-02"
output: html_document
---


```{r setup, include=FALSE}

library(dplyr)
#source("/cbica/projects/network_replication/Rscripts/functions/sensitivity_analyses/computeConnectivityMetrics_restOnly.R") # # note that this line may need to be commented out for running through this Rmd file. computeConnectivityMetrics.R is optimized for cubic job submission and has lib.loc specified for R packages. Lib.loc will throw an error if running this Rmd file locally. 
dataset="HBN"
knitr::opts_chunk$set(include = FALSE, eval = TRUE, echo = FALSE, warning = FALSE, message = FALSE) 
```


```{r loadParticipants}
# load participants
 
participants <- read.csv("/cbica/projects/network_replication/input/HBN/sample_selection/HBN_demographics_finalsample_restOnly_20230629.csv")
participants <- participants$sub

 
```


# GBC was computed on cubic as jobs. The following code chunk consolidates all the steps that were executed. 
For computeGBC, /cbica/projects/network_replication/Rscripts/HBN_scripts/Analysis_scripts/connMetrics_scripts/sensitivity_computeGBC_HBN_restOnly.sh was submitted as a job. 
This shell script uses the following Rscript to execute R code: /cbica/projects/network_replication/Rscripts/functions/sensitivity_analyses/computeGBC_restOnly.R 
Note that computeGBC_restOnly.R uses functions from /cbica/projects/network_replication/Rscripts/functions/sensitivity_analyses/computeConnectivityMetrics_restOnly.R. 

```{r computeGBC}
# make output dfs: 
## GBC.subxparcel.matrix.schaefer200 
atlases <-  "schaefer200" # only include schaefer200 for sensitivity analysis in supplement
metric = "GBC"

for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".subxparcel.matrix.", atlases[i])
  assign(df_name, make_output_dfs(participants, atlases[i]))
}
  
 
# compute GBC
for(sub in c(1:length(participants))){
  for(i in c(1:length(atlases))){
    subjectID=as.character(participants[sub])
    HBNid.data <- computeGBC(subjectID, atlases[i], "HBN")
    dataname <- sprintf("%s.%s.%s", metric, "subxparcel.matrix", atlases[i]) 
    df_toUpdate <- get(dataname)
    df_toUpdate[sub,] <- cbind(subjectID, t(HBNid.data)) #update the name of the df every iteration to GBC.subxparcel.matrix.[atlas]
    assign(dataname, df_toUpdate)  
    print(paste(sub, "/", length(participants), "-", subjectID, atlases[i]))
  }
}
  
write.csv(GBC.subxparcel.matrix.schaefer200, "/cbica/projects/network_replication/output/HBN/sensitivity_analyses/GBC/GBC_subxparcel_matrix_schaefer200.csv", row.names=F, quote=F)
    
```


# Perform CovBat Harmonization on GBC


```{r setup_covbat, include=FALSE}

#install.packages("/cbica/projects/network_replication/software/covBat_gam/ComBatFamily_0.1.0.tar.gz", repos=NULL, type='source')

library(ComBatFamily)
library(dplyr)
library(mgcv)

atlases_GBC <-  "schaefer200" # only include schaefer200 for sensitivity analysis in supplement
dataset <- "HBN"
 
  
```


# Do Covbat on rest only connectivity matrices

```{r load_subxparcel}
participants <- read.csv("/cbica/projects/network_replication/input/HBN/sample_selection/HBN_demographics_finalsample_restOnly_20230629.csv")
 
 
#GBC - loads GBC_subxparcel_schaefer200 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0(metric, "_", "subxparcel_", atlases_GBC[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/sensitivity_analyses/%2$s/%2$s_subxparcel_matrix_%3$s.csv", dataset, metric, atlases_GBC[i])))
  assign(df_name, data.frame(get(df_name)[,-1]))
  print(df_name)
} 
 
row.names(GBC_subxparcel_schaefer200) <- participants$sub

 
 
```


```{r run_covbat}


age_vec <- participants$age 
sex_vec <- as.factor(participants$sex)
 
meanFD_avgSes_vec <- participants$meanFD_avgSes
 
covar_df <- bind_cols(participants$sub, as.numeric(age_vec), as.factor(sex_vec), as.numeric(meanFD_avgSes_vec))
covar_df <- dplyr::rename(covar_df, sub=...1,
                          age = ...2,
                          sex = ...3,
                          meanFD_avgSes = ...4)
#batch <- participants$ses 
 
# Harmonize GBC
data.harmonized_GBC <- covfam(data=GBC_subxparcel_schaefer200, bat = as.factor(participants$ses), covar = covar_df, gam, y ~ s(age, k=3, fx=T) + as.factor(sex) + as.numeric(meanFD_avgSes))
```


```{r save_out}

#GBC - save out covbat harmonized connectivity metrics 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0(metric, "_", "subxparcel_", atlases_GBC[i], "_covbat")
  assign(df_name, data.frame(data.harmonized_GBC$dat.covbat))
  write.csv(get(df_name), sprintf("/cbica/projects/network_replication/output/%1$s/sensitivity_analyses/%2$s/%2$s_subxparcel_matrix_%3$s_covbat_restOnly.csv", dataset, metric, atlases_GBC[i]))
  print(df_name)
}  
 
```
