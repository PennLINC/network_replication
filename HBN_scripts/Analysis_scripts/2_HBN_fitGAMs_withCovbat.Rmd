---
title: "HBN fit GAMs"
author: "Audrey Luo"
output: html_document
---

```{r setup, include=FALSE}

library(dplyr)
source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/GAM_functions.R")
source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/fitGAMs.R") 
 
dataset = "HBN"
```

# make connectivityMetric-demographics .csv's
```{r connMetric_demographics, include=FALSE}

demographics <- read.csv(sprintf("/cbica/projects/network_replication/input/%1$s/sample_selection/%1$s_demographics_finalsample_20230629.csv", dataset))
names(demographics)[c(which(names(demographics) == "sub"))] <- "subject"
demographics <- demographics[,c(which(names(demographics) == "subject"), which(names(demographics) == "sex"), which(names(demographics)=="age"), which(names(demographics) =="meanFD_avgSes"))] 
 
 
# GBC
## the following lines of code make GBC.glasser.HBN, GBC.gordon.HBN, GBC.schaefer200.HBN, GBC.schaefer400.HBN
atlases <- c("glasser", "gordon", "schaefer200", "schaefer400")
metric = "GBC"

for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".", atlases[i], ".", dataset)
  assign(df_name, make_connMetricsDemog_covbat(atlases[i], metric, demographics, "subject", dataset))
}

 
 
# BNC
## make BNC.gordon.HBN, BNC.schaefer200x7.HBN, BNC.schaefer200x17.HBN, BNC.schaefer400x7.HBN, BNC.schaefer400x17.HBN
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".", atlases[i], ".", dataset)
  assign(df_name, make_connMetricsDemog_covbat(atlases[i], metric, demographics, "subject", dataset))
}

# WNC
## make WNC.gordon.HBN, WNC.schaefer200x7.HBN, WNC.schaefer200x17.HBN, WNC.schaefer400x7.HBN, WNC.schaefer400x17.HBN
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
metric = "WNC"

for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".", atlases[i], ".", dataset)
  assign(df_name, make_connMetricsDemog_covbat(atlases[i], metric, demographics, "subject", dataset))
} 

  
# edge 
## edge.schaefer200x7.HBN
edge.schaefer200x7.HBN <- make_EdgeDemog_covbat("schaefer200x7", demographics, "subject", dataset)
  
```


 

# load connectivityMetric-demographics .csv's (which was just made in previous code chunk)
```{r load_connectivity, include=TRUE}

GBC.glasser.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/GBC/GBCglasser_demographics_finalsample_covbat.csv", dataset)) 
GBC.gordon.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/GBC/GBCgordon_demographics_finalsample_covbat.csv", dataset)) 
 
GBC.schaefer200.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/GBC/GBCschaefer200_demographics_finalsample_covbat.csv", dataset)) 
names(GBC.schaefer200.HBN) <- gsub('X17Networks', "Networks", names(GBC.schaefer200.HBN))


GBC.schaefer400.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/GBC/GBCschaefer400_demographics_finalsample_covbat.csv", dataset)) 
names(GBC.schaefer400.HBN) <- gsub('X17Networks', "Networks", names(GBC.schaefer400.HBN)) 
  

# BNC
BNC.gordon.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/BNC/BNCgordon_demographics_finalsample_covbat.csv", dataset))   
BNC.schaefer200x7.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/BNC/BNCschaefer200x7_demographics_finalsample_covbat.csv", dataset)) 
names(BNC.schaefer200x7.HBN) <- gsub("X7", "", names(BNC.schaefer200x7.HBN))

BNC.schaefer200x17.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/BNC/BNCschaefer200x17_demographics_finalsample_covbat.csv", dataset))    
names(BNC.schaefer200x17.HBN) <- gsub("X17", "", names(BNC.schaefer200x17.HBN))

BNC.schaefer400x7.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/BNC/BNCschaefer400x7_demographics_finalsample_covbat.csv", dataset))
names(BNC.schaefer400x7.HBN) <- gsub("X7", "", names(BNC.schaefer400x7.HBN))

BNC.schaefer400x17.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/BNC/BNCschaefer400x17_demographics_finalsample_covbat.csv", dataset))   
names(BNC.schaefer400x17.HBN) <- gsub("X17", "", names(BNC.schaefer400x17.HBN))

# WNC
WNC.gordon.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/WNC/WNCgordon_demographics_finalsample_covbat.csv", dataset))    
WNC.schaefer200x7.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/WNC/WNCschaefer200x7_demographics_finalsample_covbat.csv", dataset))
names(WNC.schaefer200x7.HBN) <- gsub("X7", "", names(WNC.schaefer200x7.HBN))

WNC.schaefer200x17.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/WNC/WNCschaefer200x17_demographics_finalsample_covbat.csv", dataset)) 
names(WNC.schaefer200x17.HBN) <- gsub("X17", "", names(WNC.schaefer200x17.HBN))

WNC.schaefer400x7.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/WNC/WNCschaefer400x7_demographics_finalsample_covbat.csv", dataset)) 
names(WNC.schaefer400x7.HBN) <- gsub("X7", "", names(WNC.schaefer400x7.HBN))

WNC.schaefer400x17.HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/WNC/WNCschaefer400x17_demographics_finalsample_covbat.csv", dataset))  
names(WNC.schaefer400x17.HBN) <- gsub("X17", "", names(WNC.schaefer400x17.HBN))
 

  
edge.schaefer200x7.HBN <- readRDS("/cbica/projects/network_replication/output/HBN/edge/schaefer200x7_demographics_finalsample_covbat.RData")
 
# make sex a factor
class(GBC.glasser.HBN$sex)
GBC.glasser.HBN$sex <- as.factor(GBC.glasser.HBN$sex)
GBC.gordon.HBN$sex <- as.factor(GBC.gordon.HBN$sex)
GBC.schaefer200.HBN$sex <- as.factor(GBC.schaefer200.HBN$sex)
GBC.schaefer400.HBN$sex <- as.factor(GBC.schaefer400.HBN$sex)

 
BNC.gordon.HBN$sex <- as.factor(BNC.gordon.HBN$sex)
BNC.schaefer200x7.HBN$sex <- as.factor(BNC.schaefer200x7.HBN$sex)
BNC.schaefer200x17.HBN$sex <- as.factor(BNC.schaefer200x17.HBN$sex)
BNC.schaefer400x7.HBN$sex <- as.factor(BNC.schaefer400x7.HBN$sex)
BNC.schaefer400x17.HBN$sex <- as.factor(BNC.schaefer400x17.HBN$sex)

WNC.gordon.HBN$sex <- as.factor(WNC.gordon.HBN$sex)   
WNC.schaefer200x17.HBN$sex <- as.factor(WNC.schaefer200x17.HBN$sex) 
WNC.schaefer400x17.HBN$sex <- as.factor(WNC.schaefer400x17.HBN$sex) 
WNC.schaefer200x7.HBN$sex <- as.factor(WNC.schaefer200x7.HBN$sex) 
WNC.schaefer400x7.HBN$sex <- as.factor(WNC.schaefer400x7.HBN$sex) 

 
edge.schaefer200x7.HBN$sex <- as.factor(edge.schaefer200x7.HBN$sex)
  
```



# load parcel labels and edges 
```{r}
# load parcel labels
glasser.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/glasser360_regionlist_final.csv")

gordon.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/gordon_regionlist_final.csv")

schaefer200x7.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x7_regionlist_final.csv")

schaefer200x17.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x17_regionlist_final.csv")
schaefer200.parcel.labels <- schaefer200x17.parcel.labels #gbc

schaefer400x7.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer400x7_regionlist_final.csv")

schaefer400x17.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer400x17_regionlist_final.csv")
schaefer400.parcel.labels <- schaefer400x17.parcel.labels #gbc
 

# edges
schaefer200x7_edge <- read.csv("/cbica/projects/network_replication/atlases/edge/schaefer200x7_edge.csv")
schaefer200x7_edge <- schaefer200x7_edge[,2]
```  



# Check AIC for k=3-6
```{r}
library(stats)
dataset_name="HBN"
covariates ="sex + meanFD_avgSes"
smooth_var="age"


check_aic <- function(parcel.labels, atlas_name, network_parcellation, dataset_name, covariates, smooth_var, k_number){
    parcel.labels <- parcel.labels$label
    list_plots <- list()
    list_AIC <- c()
    list_region <- c()
    for(row in c(1:length(parcel.labels))){ #for each region
      region <- parcel.labels[row] 
      dataname <- sprintf("%s.%s%s.%s", metric, atlas_name, network_parcellation, dataset_name) 
      gam.data <- get(dataname) # Return the Value of a Named Object
      parcel <- region
      region <- str_replace(region, "-", ".")
      modelformula <- as.formula(sprintf("%s ~ s(%s, k=%s, fx=T) + %s", region, smooth_var, k_number, covariates)) # 3 knots, fx = should term be unpenalized (so here, it is unpenalized)
      gam.model <- gam(modelformula, data=gam.data)
      gam.results <- summary(gam.model) 
      
      #list_plots <- append(draw(gam.model, residuals = TRUE), list_plots)
      list_AIC <- append(AIC(gam.model), list_AIC)
      list_region <- append(region, list_region)
      k_dataframe <- data.frame(bind_cols(list_AIC, list_region))
      names(k_dataframe) <- c("AIC", "region")
      print(row)
    }
      return(k_dataframe)
}
 
metric="GBC"
k_3 <- check_aic(schaefer200.parcel.labels, "schaefer200", "", "HBN", "sex + meanFD_avgSes", "age", 3)
mean(k_3$AIC) #-4485.568
median(k_3$AIC) #-4501.418

k_4 <- check_aic(schaefer200.parcel.labels, "schaefer200", "", "HBN", "sex + meanFD_avgSes", "age", 4)
mean(k_4$AIC) #-4485.134
median(k_4$AIC) #-4499.945

k_5 <- check_aic(schaefer200.parcel.labels, "schaefer200", "", "HBN", "sex + meanFD_avgSes", "age", 5)
mean(k_5$AIC) #-4484.529
median(k_5$AIC) #-4497.948

k_6 <- check_aic(schaefer200.parcel.labels, "schaefer200", "", "HBN", "sex + meanFD_avgSes", "age", 6)
mean(k_6$AIC) #-4484.429
median(k_6$AIC) #-4497.524
 
 

length(which(k_3$AIC < k_4$AIC))/length(k_3$AIC) # 74%
length(which(k_3$AIC < k_5$AIC))/length(k_3$AIC) # 75%
length(which(k_3$AIC < k_6$AIC))/length(k_3$AIC) # 67%

# BNC
metric="BNC"
k_3.BNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 3)
mean(k_3.BNC$AIC) # -4141.17
median(k_3.BNC$AIC) # -4210.384
 
k_4.BNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 4)
mean(k_4.BNC$AIC) # -4140.11
median(k_4.BNC$AIC) #-4208.695

k_5.BNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 5)
mean(k_5.BNC$AIC) # -4139.139
median(k_5.BNC$AIC) #-4207.811

k_6.BNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 6)
mean(k_6.BNC$AIC) #-4139.192
median(k_6.BNC$AIC) #-4207.573


# WNC
metric="WNC"
k_3.WNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 3)
mean(k_3.WNC$AIC) # -2195.869
median(k_3.WNC$AIC) # -2171.11

k_4.WNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 4)
mean(k_4.WNC$AIC) # -2196.176
median(k_4.WNC$AIC) # -2172.262

k_5.WNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 5)
mean(k_5.WNC$AIC) # -2196.639
median(k_5.WNC$AIC) #-2171.487

k_6.WNC <- check_aic(schaefer200x7.parcel.labels, "schaefer200", "x7", "HBN", "sex + meanFD_avgSes", "age", 6)
mean(k_6.WNC$AIC) # -2196.688
median(k_6.WNC$AIC) #-2170.896
 
```





# Fit GAMs for GBC, BNC, and WNC
- note that fitGAMs_covbat function is used to take into account the _covbat tag in covbat harmonized files
```{r}
 
# GBC GAMs
gam.GBC.age.glasser <- fitGAMs_covbat(glasser.parcel.labels, "GBC", "glasser", "",dataset)
gam.GBC.age.gordon <- fitGAMs_covbat(gordon.parcel.labels, "GBC", "gordon", "", dataset)
gam.GBC.age.schaefer200 <- fitGAMs_covbat(schaefer200x17.parcel.labels, "GBC", "schaefer200", "", dataset)
gam.GBC.age.schaefer400 <- fitGAMs_covbat(schaefer400x17.parcel.labels, "GBC", "schaefer400", "", dataset)
 

# BNC GAMs
gam.BNC.age.gordon <- fitGAMs_covbat(gordon.parcel.labels, "BNC", "gordon", "", dataset)
gam.BNC.age.schaefer200x7 <- fitGAMs_covbat(schaefer200x7.parcel.labels, "BNC", "schaefer200", "x7", dataset)
gam.BNC.age.schaefer200x17 <- fitGAMs_covbat(schaefer200x17.parcel.labels, "BNC", "schaefer200", "x17",dataset)  
gam.BNC.age.schaefer400x7 <- fitGAMs_covbat(schaefer400x7.parcel.labels, "BNC", "schaefer400", "x7", dataset)   
gam.BNC.age.schaefer400x17 <- fitGAMs_covbat(schaefer400x17.parcel.labels, "BNC", "schaefer400", "x17",dataset)  
 


# WNC GAMs
gam.WNC.age.gordon <- fitGAMs_covbat(gordon.parcel.labels, "WNC", "gordon", "", dataset)
gam.WNC.age.schaefer200x7 <- fitGAMs_covbat(schaefer200x7.parcel.labels, "WNC", "schaefer200", "x7", dataset)   
gam.WNC.age.schaefer200x17 <- fitGAMs_covbat(schaefer200x17.parcel.labels, "WNC", "schaefer200", "x17",dataset)  
gam.WNC.age.schaefer400x7 <- fitGAMs_covbat(schaefer400x7.parcel.labels, "WNC", "schaefer400", "x7",dataset)  
gam.WNC.age.schaefer400x17 <- fitGAMs_covbat(schaefer400x17.parcel.labels, "WNC", "schaefer400", "x17",dataset)  
```

# Fit GAMs for Edges 
- Fitting edge-wise GAMs was very computationally heavy, and was thus submitted as job on cubic.
See /cbica/projects/network_replication/Rscripts/HBN_scripts/Analysis_scripts/connMetrics_scripts/fitGAMs_edge_HBN.sh
and
/cbica/projects/network_replication/Rscripts/functions/main_analyses/edge_fitGAMs.R
```{r}
# This code chunk was run on cubic   
schaefer200x7_edge <- gsub("7Networks", "Networks", schaefer200x7_edge)
names(edge.schaefer200x7.HBN) <- gsub("7Networks", "Networks", names(edge.schaefer200x7.HBN))
  
gam.edge.age.schaefer200x7 <- fitGAMs_edge_covbat(schaefer200x7_edge,"edge","schaefer200x7", dataset)
```


# Estimate GAM smooths based on model-predicted data and save out predicted y data** 
```{r}
 
# GBC GAMs 
gam.GBC.smooths.glasser <- estimate_GAMsmooths_covbat(glasser.parcel.labels, "GBC", "glasser", "",dataset)
gam.GBC.smooths.gordon <- estimate_GAMsmooths_covbat(gordon.parcel.labels, "GBC", "gordon", "", dataset)
gam.GBC.smooths.schaefer200 <- estimate_GAMsmooths_covbat(schaefer200x17.parcel.labels, "GBC", "schaefer200", "", dataset)
gam.GBC.smooths.schaefer400 <- estimate_GAMsmooths_covbat(schaefer400x17.parcel.labels, "GBC", "schaefer400", "", dataset)


# BNC GAMs
gam.BNC.smooths.gordon <- estimate_GAMsmooths_covbat(gordon.parcel.labels, "BNC", "gordon", "", dataset)
gam.BNC.smooths.schaefer200x7 <- estimate_GAMsmooths_covbat(schaefer200x7.parcel.labels, "BNC", "schaefer200", "x7", dataset)
gam.BNC.smooths.schaefer200x17 <- estimate_GAMsmooths_covbat(schaefer200x17.parcel.labels, "BNC", "schaefer200", "x17",dataset)
gam.BNC.smooths.schaefer400x7 <- estimate_GAMsmooths_covbat(schaefer400x7.parcel.labels, "BNC", "schaefer400", "x7",dataset)
gam.BNC.smooths.schaefer400x17 <- estimate_GAMsmooths_covbat(schaefer400x17.parcel.labels, "BNC", "schaefer400", "x17",dataset)

# WNC GAMs
gam.WNC.smooths.gordon <- estimate_GAMsmooths_covbat(gordon.parcel.labels, "WNC", "gordon", "", dataset)
gam.WNC.smooths.schaefer200x7 <- estimate_GAMsmooths_covbat(schaefer200x7.parcel.labels, "WNC", "schaefer200", "x7", dataset)
gam.WNC.smooths.schaefer200x17 <- estimate_GAMsmooths_covbat(schaefer200x17.parcel.labels, "WNC", "schaefer200", "x17",dataset)
gam.WNC.smooths.schaefer400x7 <- estimate_GAMsmooths_covbat(schaefer400x7.parcel.labels, "WNC", "schaefer400", "x7",dataset)
gam.WNC.smooths.schaefer400x17 <- estimate_GAMsmooths_covbat(schaefer400x17.parcel.labels, "WNC", "schaefer400", "x17",dataset)
```


# Calculate Region-wise Predicted Fitted GBC values  

```{r}

# GBC GAMs age fitted
gam.GBC.fitted.glasser <- dev_fitted_covbat(glasser.parcel.labels, "GBC", "glasser", dataset)
gam.GBC.fitted.gordon <- dev_fitted_covbat(gordon.parcel.labels, "GBC", "gordon", dataset)
gam.GBC.fitted.schaefer200 <- dev_fitted_covbat(schaefer200x17.parcel.labels, "GBC", "schaefer200", dataset)
gam.GBC.fitted.schaefer400 <- dev_fitted_covbat(schaefer400x17.parcel.labels, "GBC", "schaefer400", dataset)

 
# BNC GAMs age fitted
gam.BNC.fitted.gordon <- dev_fitted_covbat(gordon.parcel.labels, "BNC", "gordon", dataset)
gam.BNC.fitted.schaefer200x7 <- dev_fitted_covbat(schaefer200x7.parcel.labels, "BNC", "schaefer200x7", dataset)
gam.BNC.fitted.schaefer200x17 <- dev_fitted_covbat(schaefer200x17.parcel.labels, "BNC", "schaefer200x17", dataset)
gam.BNC.fitted.schaefer400x7 <- dev_fitted_covbat(schaefer400x7.parcel.labels, "BNC", "schaefer400x7", dataset)
gam.BNC.fitted.schaefer400x17 <- dev_fitted_covbat(schaefer400x17.parcel.labels, "BNC", "schaefer400x17", dataset)

# WNC GAMs age fitted
gam.WNC.fitted.gordon <- dev_fitted_covbat(gordon.parcel.labels, "WNC", "gordon", dataset)
gam.WNC.fitted.schaefer200x7 <- dev_fitted_covbat(schaefer200x7.parcel.labels, "WNC", "schaefer200x7", dataset)
gam.WNC.fitted.schaefer200x17 <- dev_fitted_covbat(schaefer200x17.parcel.labels, "WNC", "schaefer200x17",dataset)
gam.WNC.fitted.schaefer400x7 <- dev_fitted_covbat(schaefer400x7.parcel.labels, "WNC", "schaefer400x7", dataset)
gam.WNC.fitted.schaefer400x17 <- dev_fitted_covbat(schaefer400x17.parcel.labels, "WNC", "schaefer400x17", dataset)

```


 
# Calculate Region-wise Predicted Fitted GBC values Correlation with SA Axis for Schaefer200 only 
- Calculating region-wise predicted fitted GBC was very computationally heavy, and was thus submitted as job on cubic.
See /cbica/projects/network_replication/Rscripts/HBN_scripts/Analysis_scripts/connMetrics_scripts/fittedGBC_analysis_HBN.sh
and
/cbica/projects/network_replication/Rscripts/functions/main_analyses/fittedGBC_analysis.R

```{r}
# This code chunk was submitted as a job on cubic
fits.SAaxis.posteriorcor_schaefer200.GBC <- make_fits.SAaxis.posteriorcor_covbat("GBC", "schaefer200", dataset)
```

