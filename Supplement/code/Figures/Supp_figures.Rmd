---
title: "Supplementary Analyses"
author: "Audrey Luo"
date: "2023-11-15"
output: html_document
---

- Code for Supplementary Figures 3, 4, 6, and 7-15
- Analysis for Supplementary Figure 2 can be found in /PNC_scripts/Analysis_scripts/3_PNC_devEffectFigures.Rmd
- Analyses for Supplementary Figure 5 are completed separately for each dataset in /<dataset>_scripts/Analysis_scripts/sensitivity_analyses

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 
library(directlabels)
library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
#library(ggsegExtra)
library(ggsegSchaefer)
library(ggsegGlasser)
library(ggsegGordon)
library(ggcorrplot)
library(grid)
library(gridExtra)
library(gtable)
library(kableExtra)
library(mgcv)
library(gratia)
library(viridis)
library(scales)
library(patchwork)
library(stringr)
library(tidyr)
library(ggpubr)
library(purrr)
library(pammtools) 
 
source("/cbica/projects/network_replication/revisions/code/utils/netrep_spinTests_revisions.R")
source("/cbica/projects/network_replication/software/perm.sphere.p.R")
 
datasets <- c("PNC", "HCPD", "NKI", "HBN") 
conn_types <- c("absvalue", "thresholded")
indir <- "/cbica/projects/network_replication/revisions/output/"
```
 
 

## load parcellated S-A axis
```{r load_SAaxis, include=FALSE}
schaefer200x7_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x7_SAaxis.csv")
schaefer200x7_SAaxis$label <- gsub("7Network", "Network", schaefer200x7_SAaxis$label) 
```

## **Supplementary Figure 3: dev trajectories for additional networks**
#### load devTraj df
```{r load_devTraj_centered.dfs, include=FALSE, cache=TRUE}

devTraj.centered_PNC <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered.csv", "PNC", "GBC", "schaefer200"))
devTraj.centered_NKI <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered.csv", "NKI", "GBC", "schaefer200"))
devTraj.centered_HCPD <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered_covbat.csv", "HCPD", "GBC", "schaefer200"))
devTraj.centered_HBN <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered_covbat.csv", "HBN", "GBC", "schaefer200"))
 
```

#### Make overall dev traj
```{r devtraj}

## FIGURE: developmental trajectories, centered on zero
# @param atlas A character string of atlas name 
# @param metric A character string of connectivity metric (i.e. "GBC")
  
make_smooths_fig_centered <- function(dataset){
  smooth_fits <- get(paste0("devTraj.centered_", dataset))
  smooths_fig_centered <- ggplot(smooth_fits,aes(age,est,group=SA.axis_rank)) + 
    geom_line(data = smooth_fits, size=.7, alpha = .6, aes(color=SA.axis_rank)) + 
    ylim(-0.042, 0.053) + xlim(5, 23) +
    paletteer::scale_color_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(smooth_fits$SA.axis_rank), max(smooth_fits$SA.axis_rank)), oob = squish) + 
    theme(
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      axis.line = element_line(color = "black"),
      axis.text=element_text(size=28, color = "black"),
      panel.background=element_blank(),  
      legend.position = "none", 
      plot.margin = margin(t = 1, r = 0, b = , l = 1, unit = "cm")) + scale_y_continuous(breaks = c(-0.04, -0.02, 0, 0.02, 0.04, 0.06), limits=c(-0.042, 0.053))
  return(smooths_fig_centered)
}

devTraj.centered.PNC <- make_smooths_fig_centered("PNC")
devTraj.centered.NKI <- make_smooths_fig_centered("NKI")
devTraj.centered.HCPD <- make_smooths_fig_centered("HCPD")
devTraj.centered.HBN <- make_smooths_fig_centered("HBN")
```

#### Make dev traj for each network
```{r make_representative_parcels, warning=FALSE, cache=TRUE}
  
schaefer200x7_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x7_SAaxis.csv")
schaefer200x7_SAaxis$label <- gsub("7Network", "Network", schaefer200x7_SAaxis$label) 

# subsets gam.smooths (long_df) to extract specific parcels and creates a new dataframe (to make dev trajectory figures)
# @param SA_parcelnames, A character string indicating which parcels to plot (i.e "SM", "default", etc.; may be different for different atlases)
smooths_repParcels <- function(SA_ranks, dataset){
  gam.smooths.centered <- get(paste0("devTraj.centered_", dataset))
  gam.smooths.ordered <- gam.smooths.centered[order(gam.smooths.centered$SA.axis_rank),]
  parcel_rows <- which(gam.smooths.ordered$SA.axis_rank %in% SA_ranks) # trying to extract all rows that match SA_ranks
  repParcels <- gam.smooths.ordered[parcel_rows,]
  return(repParcels)
}

names(schaefer200x7_SAaxis)[3] <- "label"
# For schaefer200x7
## extract row numbers for parcels of interest
## note that all 7 Network schaefer atlas parcels have been reordered to match 17 network (see schaefer7to17_reordering.Rmd)
## arrange(schaefer200x7_SAaxis, by= SA.axis_rank) 

Vis <- which(str_detect(schaefer200x7_SAaxis$label, "Vis")) # mean SA rank = 33
Vis_ranks <- schaefer200x7_SAaxis$SA.axis_rank[Vis]  
 

DorsAttn <- which(str_detect(schaefer200x7_SAaxis$label, "DorsAttn")) # mean SA rank = 94
DorsAttn_ranks <- schaefer200x7_SAaxis$SA.axis_rank[DorsAttn]  
 

limbic <- which(str_detect(schaefer200x7_SAaxis$label, "Limbic")) # mean SA rank = 136
limbic_ranks <- schaefer200x7_SAaxis$SA.axis_rank[limbic]  

FPN <- which(str_detect(schaefer200x7_SAaxis$label, "Cont")) # mean SA rank = 144
FPN_ranks <- schaefer200x7_SAaxis$SA.axis_rank[FPN]  
 


schaefer200x7_parcelRanks <- list(Vis_ranks, DorsAttn_ranks, limbic_ranks, FPN_ranks)
repParcels_PNC <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, dataset="PNC") 
names(repParcels_PNC) <- c("Vis", "DorsAttn", "limbic","FPN")

repParcels_NKI <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, dataset="NKI")  
names(repParcels_NKI) <- c("Vis", "DorsAttn", "limbic","FPN")

repParcels_HCPD <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, dataset="HCPD")  
names(repParcels_HCPD) <- c("Vis", "DorsAttn", "limbic","FPN")

repParcels_HBN <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, dataset="HBN")  
names(repParcels_HBN) <- c("Vis", "DorsAttn", "limbic","FPN")
 
```
 

```{r FigRepresentativeParcels_schaefer200x7, fig.height= 8, fig.width= 12, warning=FALSE, cache=TRUE}
## FIGURE: developmental trajectories for representative parcels
# @param dataset A character string for dataset
# @param parcels A character string of parcel(s) whose trajectory you want to plot (i.e. "SomMot", "visual")
# @param color_hexcode A character string for color of geom_line
 
make_repParcel.fig <- function(dataset, parcels, color_hexcode) {
  df <- get(paste0("repParcels_", dataset))
  smooth_fits <- df[[parcels]]
  main.plot <- ggplot(smooth_fits,aes(age,est,group=SA.axis_rank)) + 
    geom_line(data = smooth_fits, size=1.5, alpha = .6,  colour=color_hexcode) + scale_y_continuous(breaks = c(-0.04, -0.02, 0, 0.02, 0.04, 0.06), limits=c(-0.042, 0.053)) + xlim(5, 23) +
    theme(
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      axis.line = element_line(color = "black"),
      axis.text=element_text(size=28, color = "black"),
      panel.background=element_blank(),  
      legend.position = "none", plot.margin = margin(t = 1, r = 0, b = , l = 1, unit = "cm")) 
  return(main.plot)
}

## set up dataframe for making figures
SAaxis_repParcels_schaefer200x7 <- schaefer200x7_SAaxis
SAaxis_repParcels_schaefer200x7$SA.axis_rank <- as.numeric(SAaxis_repParcels_schaefer200x7$SA.axis_rank)
names(SAaxis_repParcels_schaefer200x7)[3] <- "region"
schaefer200x7_SAaxis_fig.df <- SAaxis_repParcels_schaefer200x7 %>% 
  mutate(Vis = ifelse(SA.axis_rank %in% Vis_ranks, 1, 0)) %>% 
   
   
  mutate(DorsAttn = ifelse(SA.axis_rank %in% DorsAttn_ranks, 1, 0)) %>%
  mutate(limbic = ifelse(SA.axis_rank %in% limbic_ranks, 1, 0)) %>%
  mutate(FPN = ifelse(SA.axis_rank %in% FPN_ranks, 1, 0)) 
   
schaefer200x7_SAaxis_fig.df$region <- gsub("Network", "7Network", schaefer200x7_SAaxis_fig.df$region)
 

# make for all networks...but only including the ones that weren't already in Fig 3  
PNC_sensorimotor_figs <- make_repParcel.fig("Vis", dataset="PNC", color_hexcode="#24A6A8FF")
PNC_midaxis_figs <- make_repParcel.fig("DorsAttn", dataset="PNC", color_hexcode="#EEAC32FF")
PNC_assoc_figs <- lapply(c("limbic", "FPN"), make_repParcel.fig, dataset="PNC", color_hexcode="#C73000FF")

NKI_sensorimotor_figs <- make_repParcel.fig("Vis", dataset="NKI", color_hexcode="#24A6A8FF")
NKI_midaxis_figs <- make_repParcel.fig("DorsAttn", dataset="NKI", color_hexcode="#EEAC32FF")
NKI_assoc_figs <- lapply(c("limbic", "FPN"), make_repParcel.fig, dataset="NKI", color_hexcode="#C73000FF")

HCPD_sensorimotor_figs <- make_repParcel.fig("Vis", dataset="HCPD", color_hexcode="#24A6A8FF")
HCPD_midaxis_figs <- make_repParcel.fig("DorsAttn", dataset="HCPD", color_hexcode="#EEAC32FF")
HCPD_assoc_figs <- lapply(c("limbic", "FPN"), make_repParcel.fig, dataset="HCPD", color_hexcode="#C73000FF")

HBN_sensorimotor_figs <- make_repParcel.fig("Vis", dataset="HBN", color_hexcode="#24A6A8FF")
HBN_midaxis_figs <- make_repParcel.fig("DorsAttn", dataset="HBN", color_hexcode="#EEAC32FF")
HBN_assoc_figs <- lapply(c("limbic", "FPN"), make_repParcel.fig, dataset="HBN", color_hexcode="#C73000FF")


```

#### Make inset for Supp Figure 3
```{r plot_inset, fig.height=7, fig.width=7}
## FIGURE: inset for developmental trajectories for representative parcels
# @param atlas A character string of atlas name 
# @param parcels A character string of parcel(s) whose trajectory you want to plot (i.e. "SomMot", "visual")
# @param color_hexcode A character string for color of geom_line
# @param SA_rank A numeric for mean SA rank of parcels
# @param ggseg_atlas A character for ggseg atlas
make_repParcel.inset_rev <- function(atlas, parcels, color_hexcode, SA_rank, ggseg_atlas, title) { 
  SAaxis_fig.df <- get(paste0(atlas, "_SAaxis_fig.df")) 
  names(SAaxis_fig.df)[which(names(SAaxis_fig.df) == parcels)] <- "repParcel"
  fig_inset <- ggplot() + geom_brain(data=SAaxis_fig.df, 
                                     atlas=get(ggseg_atlas), 
                                     hemi='left', side = 'lateral',
                                     mapping=aes(fill=repParcel, colour=I(color_hexcode),  size=I(0.6)), 
                                     show.legend=FALSE) + scale_fill_gradient(low="white", high = color_hexcode) + theme_void() + 
    ggtitle(bquote(atop(bold(.(title)), "\nMean S-A Rank =" ~ .(SA_rank)))) +
    theme(plot.title = element_text(size=30, hjust = 0.5, vjust = -70, color="black"),
          plot.margin = margin(t = 0, r = 0, b = 1, l = 0, unit = "cm"))  
  return(fig_inset)
  }
 
 
inset_Vis <- make_repParcel.inset_rev("schaefer200x7", "Vis", SA_rank=round(mean(Vis_ranks),0), "#24A6A8FF", "schaefer7_200", "Visual")
 
 
inset_DorsAttn <- make_repParcel.inset_rev("schaefer200x7", "DorsAttn", SA_rank=round(mean(DorsAttn_ranks),0), "#EEAC32FF", "schaefer7_200", "Dorsal Attention")
 
 
inset_limbic <- make_repParcel.inset_rev("schaefer200x7", "limbic", SA_rank=round(mean(limbic_ranks),0), "#C73000FF", "schaefer7_200", "Limbic")
 
inset_FPN <- make_repParcel.inset_rev("schaefer200x7", "FPN", SA_rank=round(mean(FPN_ranks),0), "#C73000FF", "schaefer7_200", "Frontoparietal")
  
```
 
  
```{r supp fig3 new networks, fig.height=15, fig.width=20}

plot_grid(PNC_sensorimotor_figs , PNC_midaxis_figs, PNC_assoc_figs[[1]], PNC_assoc_figs[[2]], 
          NKI_sensorimotor_figs,  NKI_midaxis_figs, NKI_assoc_figs[[1]], NKI_assoc_figs[[2]],
          HCPD_sensorimotor_figs, HCPD_midaxis_figs, HCPD_assoc_figs[[1]], HCPD_assoc_figs[[2]], 
          HBN_sensorimotor_figs, HBN_midaxis_figs, HBN_assoc_figs[[1]], HBN_assoc_figs[[2]], ncol=4, labels=c("a", "e", "i", "m", "b", "f", "j", "n","c", "g", "k", "o", "d", "h", "l", "p"), 
          label_size=28, label_fontface = 'bold', label_y=rep(1,32), label_x = 0.01, byrow=TRUE)

 
```





## **Supplementary Figure 4: GBC Trajectories for association regions**
```{r load GBC smooths}

# load parcellated S-A axis 
schaefer200_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x17_SAaxis.csv")
schaefer200_SAaxis$label <- gsub("17Network", "Network", schaefer200_SAaxis$label) 

schaefer200.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x17_regionlist_final.csv")

# Function for creating gam.smooths dfs - original schaefer200
# @param metric A character string of connectivity metric (i.e. "GBC")
# @param atlas A character string of atlas name
load_gam.smooths <- function(metric, atlas, dataset){
  if(dataset=="PNC" | dataset == "NKI") {
    gam.smooths <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s.csv", dataset, metric, atlas))

  } else {
    gam.smooths <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_covbat.csv", dataset, metric, atlas))
  }
  print("Smooths loaded")
  parcel.labels <- get(paste0(atlas, ".parcel.labels"))
  parcel.labels <- data.frame(parcel.labels$label)
  names(parcel.labels) <- "label"
  SAaxis <- get(paste0(atlas, "_SAaxis"))
  gam.smooths <- left_join(gam.smooths, parcel.labels, by = "label")

  
  a <- merge(parcel.labels, SAaxis, by="label", sort=F)
  
  gam.smooths <- left_join(gam.smooths, a, by = "label")
  gam.smooths$SA.axis_rank <-as.numeric(gam.smooths$SA.axis_rank) 
  return(gam.smooths)
}


gam.smooths.GBC.PNC <- load_gam.smooths("GBC", "schaefer200", "PNC")
gam.smooths.GBC.NKI <- load_gam.smooths("GBC", "schaefer200", "NKI")
gam.smooths.GBC.HCPD <- load_gam.smooths("GBC", "schaefer200", "HCPD")
gam.smooths.GBC.HBN <- load_gam.smooths("GBC", "schaefer200", "HBN")


```

Dev trajectories for GBC - association regions
```{r make GBC devtraj figs}
## FIGURE: Developmental Trajectories 
# @param metric A character string of connectivity metric (i.e. "GBC")
# @param atlas A character string of atlas name 
devTraj_assocOnly_figure <- function(dataset) {
  gam.smooths <- get(paste0("gam.smooths.GBC.",  dataset))
  gam.smooths <- gam.smooths %>% filter(SA.axis_rank >= 180) 
  SAaxis <- schaefer200_SAaxis
  smooths_figure <- ggplot(gam.smooths,aes(age,fit,group=index)) + 
  geom_line(data = gam.smooths, size=1.8, alpha = 0.8, color="#C02B00FF") + 
   
  ggtitle(dataset) +  theme_classic() + 
  theme(plot.title=element_text(hjust=0.5),
    text = element_text(size=20),
    axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.line = element_line(color = "black"),
    legend.position = "none", 
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    legend.key.width = unit(2, 'cm'), legend.key.height = unit(1, 'cm'), 
    legend.title = element_text(size=18), legend.text = element_text(size=18), legend.direction = "horizontal") + coord_cartesian(expand = FALSE, xlim = c(5, 23)) + ylim(-0.07, 0.15)
  return(smooths_figure)
}
 
PNC_GBC_traj_assocOnly <- devTraj_assocOnly_figure("PNC")
NKI_GBC_traj_assocOnly <- devTraj_assocOnly_figure("NKI")
HCPD_GBC_traj_assocOnly <- devTraj_assocOnly_figure("HCPD") + ggtitle("HCP-D")
HBN_GBC_traj_assocOnly <- devTraj_assocOnly_figure("HBN")
```

```{r GBC noncentered, fig.width=10, fig.height = 10}
  
(GBC_devTraj_assocOnly <- ggarrange(PNC_GBC_traj_assocOnly, HCPD_GBC_traj_assocOnly, NKI_GBC_traj_assocOnly, HBN_GBC_traj_assocOnly, labels=c('a', 'c', 'b', 'd'), font.label=list(size=20, face="plain")))
 
```

 
 
## **Supplementary Figure 6: GBC computed from Thresholded matrices and Absolute Correlation in PNC**
#### load gam results
```{r load_gam, include=FALSE, cache=TRUE}
#GBC - loads gam.age.PNC_absvalue, gam.age.PNC_thresholded 
 
for(j in c(1:length(conn_types))) {
  df_name <- paste0("gam.", "age.", "PNC", "_", conn_types[j])
  assign(df_name, read.csv(paste0(indir, sprintf("%1$s/GBC/GAM/GAMresults.GBC.age.schaefer200_%2$s.csv", "PNC", conn_types[j]))))
  assign(df_name, get(df_name) %>% select(-label))
  df_to.label <- get(df_name)
  df_to.label$label <- schaefer200x7_SAaxis$label
  assign(df_name, df_to.label)
}
 
```
 

#### make figure df's - metric.axis_atlas
- makes metric.axis_atlas df's. can load these df's in following chunk.
```{r figure_dfs, include=FALSE, eval=TRUE}
# GBC - makes GBC.axis_[dataset]_absvalue and GBC.axis_[dataset]_thresholded
 

for(j in c(1:length(conn_types))) {
    df_name <- paste0("GBC", ".axis_", "PNC", "_", conn_types[j])
    assign(df_name, combineGAMdfs("PNC", conn_types[j]))
    print(df_name)
}
 
 
#add column for FDR correction
# GBC
GBC.axis_PNC_absvalue <- sig_parcels(GBC.axis_PNC_absvalue)
GBC.axis_PNC_thresholded <- sig_parcels(GBC.axis_PNC_thresholded)
 
# GBC - writes each axis df out

for(j in c(1:length(conn_types))) {
    df_name <- paste0("GBC", ".axis_", "PNC", "_", conn_types[j])
    filename <- paste0(df_name)
    write.csv(get(filename), paste0(indir, sprintf("%1$s/GBC/GAM/%2$s.csv", "PNC", filename)))
    print(df_name)
}


  
```

 

#### Spin-based spatial permutation tests - Prep dataframes
```{r prep_pspindfs, include=FALSE, cache=TRUE, eval=FALSE}
#Load Spin Test Parcel Rotation Matrix
perm.id.full_schaefer200x7 <- readRDS("/cbica/projects/network_replication/software/rotate_parcellation/schaefer200x7.coords_sphericalrotations_N10k.rds")
 
# GBC - make df.dev.spin_PNC_absvalue, df.dev.spin_PNC_thresholded (formatted df's for applying spin test)

for(j in c(1:length(conn_types))) {
    df_name <- paste0("df.dev.spin_", "PNC", "_", conn_types[j])
    assign(df_name, prepDfSpin("PNC", conn_types[j]))
    print(paste(df_name, "made"))
} 

 
```
 
#### Correlations and Spin-based spatial permutation tests
- executes spin test and saves out p-spin values. Can load values in the next chunk.
```{r cor_test, include=FALSE, eval=FALSE}
# GBC - making corr.[dataset]_absvalue, corr.[dataset]_thresholded  
 

for(j in c(1:length(conn_types))) {
    df_name <- paste0("corr.", "PNC", "_", conn_types[j])
    axis <- get(paste0("GBC", ".axis_", "PNC", "_", conn_types[j]))
    assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
    print(paste(df_name, "made"))
   
}
 
spearman_rho <- t(data.frame(cbind(corr.PNC_absvalue, corr.PNC_thresholded)))
write.csv(spearman_rho, "/cbica/projects/network_replication/revisions/output/spearman_rho_thresholded_absvalue.csv")

# spin permutation tests:
p_spin<- c()

for(j in c(1:length(conn_types))) {
    df.dev.spin <- get(paste0("df.dev.spin_", "PNC", "_", conn_types[j]))
    p_spin_temp <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full_schaefer200x7, corr.type='spearman')
    p_spin <- append(p_spin, p_spin_temp)
    print(paste("PNC", conn_types[j], p_spin_temp))
  
}
p_spin_all <- data.frame(cbind(c("PNC_absvalue", "PNC_thresholded"), p_spin))


p_spin_all$p_spin = as.numeric(p_spin_all$p_spin)
names(p_spin_all)[1] <- "dataset_conn_type"
 
write.csv(p_spin_all, "/cbica/projects/network_replication/revisions/output/pspin_vals_absvalue_thresholded.csv")
```


### Making figure labels with r and p_spin: 
this section required manual input since expression() doesn't take variables :( 
```{r make_figures_pspin, include=FALSE}
spearman_rho <- read.csv("/cbica/projects/network_replication/revisions/output/spearman_rho_thresholded_absvalue.csv")
p_spin_all <- read.csv("/cbica/projects/network_replication/revisions/output/pspin_vals_absvalue_thresholded.csv")
  
 
r_text_PNC_absvalue <- expression(paste(italic("r "), "= -0.48, ",  , italic(p[spin]), "< 0.01"))
(PNC_absvalue.fig <- gam_figure_p.spin(GBC.axis_PNC_absvalue, "GBC", "Schaefer200", r_text_PNC_absvalue, 
                                      x_pos= 150, y_pos=0.14, ylim_lower=-0.065, ylim_upper=0.15))


r_text_PNC_thresholded <- expression(paste(italic("r "), "= -0.49, ",  , italic(p[spin]), "< 0.01"))
(PNC_thresholded.fig <- gam_figure_p.spin(GBC.axis_PNC_thresholded, "GBC", "Schaefer200", r_text_PNC_thresholded, 
                                      x_pos= 150, y_pos=0.14, ylim_lower=-0.065, ylim_upper=0.15))

```
  
 
#### GBC computed from non-GSR and Partial Correlation 
#### load gam results
```{r load_gam, include=FALSE, cache=TRUE}
#GBC - loads gam.age.PNC_nonGSR, gam.age.PNC_partialcorr

gam.age.PNC_nonGSR <- read.csv(sprintf("/cbica/projects/network_replication/revisions/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s%4$s_%5$s.csv", "PNC", "GBC", "schaefer200", "x7", "nonGSR"))
gam.age.PNC_partialcorr <- read.csv(sprintf("/cbica/projects/network_replication/revisions/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s%4$s_%5$s.csv", "PNC", "GBC", "schaefer200", "x7", "partialcorr"))
  
```
 

#### make figure df's - metric.axis_atlas
- makes metric.axis_atlas df's. can load these df's in following chunk.
```{r figure_dfs, include=FALSE, eval=TRUE}

# GBC - makes GBC.axis_PNC_nonGSR and GBC.axis_PNC_partialcorr
GBC.axis_PNC_nonGSR <- combineGAMdfs("PNC", "nonGSR")
GBC.axis_PNC_partialcorr <- combineGAMdfs("PNC", "partialcorr")
 
#add column for FDR correction
# GBC
GBC.axis_PNC_nonGSR <- sig_parcels(GBC.axis_PNC_nonGSR)
GBC.axis_PNC_partialcorr <- sig_parcels(GBC.axis_PNC_partialcorr) # there are only 7/200 significant parcels 
 

# GBC - writes each axis df out
write.csv(GBC.axis_PNC_nonGSR, paste0(indir, sprintf("%1$s/GBC/GAM/%2$s.csv", "PNC", "GBC.axis_PNC_nonGSR")))
write.csv(GBC.axis_PNC_partialcorr, paste0(indir, sprintf("%1$s/GBC/GAM/%2$s.csv", "PNC", "GBC.axis_PNC_partialcorr")))
  
```
 
#### Spin-based spatial permutation tests - Prep dataframes
```{r prep_pspindfs, include=FALSE, cache=TRUE, eval=FALSE}
#Load Spin Test Parcel Rotation Matrix
perm.id.full_schaefer200x7 <- readRDS("/cbica/projects/network_replication/software/rotate_parcellation/MNI_coords/schaefer200x7.coords_sphericalrotations_N10k_original.rds")
 
# GBC - make df.dev.spin_PNC_nonGSR, df.dev.spin_PNC_partialcorr (formatted df's for applying spin test)
df.dev.spin_PNC_nonGSR <- prepDfSpin("PNC", "nonGSR")
df.dev.spin_PNC_nonGSR <- prepDfSpin("PNC", "partialcorr")
 
 
```
 
#### Correlations and Spin-based spatial permutation tests
- executes spin test and saves out p-spin values. Can load values in the next chunk.
```{r cor_test, include=FALSE, eval=FALSE}
# GBC - making corr.PNC_nonGSR, corr.PNC_partialcorr
 
corr.PNC_nonGSR <- cor.test(GBC.axis_PNC_nonGSR$GAM.age.AdjRsq, GBC.axis_PNC_nonGSR$SA.axis_rank, method=c("spearman"), exact=F)$estimate 
corr.PNC_partialcorr <- cor.test(GBC.axis_PNC_partialcorr$GAM.age.AdjRsq, GBC.axis_PNC_partialcorr$SA.axis_rank, method=c("spearman"), exact=F)$estimate  
 
# spin permutation tests:
p_spin_nonGSR <- perm.sphere.p(as.numeric(GBC.axis_PNC_nonGSR$GAM.age.AdjRsq), as.numeric(GBC.axis_PNC_nonGSR$SA.axis_rank), perm.id.full_schaefer200x7, corr.type='spearman')

p_spin_partialcorr <- perm.sphere.p(as.numeric(GBC.axis_PNC_partialcorr$GAM.age.AdjRsq), as.numeric(GBC.axis_PNC_partialcorr$SA.axis_rank), perm.id.full_schaefer200x7, corr.type='spearman')

 
corr_spin <- matrix(data=NA, nrow=2, ncol=2)
corr_spin[1,] <- c(corr.PNC_nonGSR, p_spin_nonGSR)
corr_spin[2,] <- c(corr.PNC_partialcorr, p_spin_partialcorr)
rownames(corr_spin) <- c("nonGSR", "partialcorr")

corr_spin <- data.frame(corr_spin) %>% setNames(c("corr", "pspin"))
write.csv(corr_spin, "/cbica/projects/network_replication/revisions/output/PNC/pspin_vals_CPAC.csv")

```


 
### Making figure labels with r and p_spin: 
this section required manual input since expression() doesn't take variables :( 
```{r make_figures_pspin, include=FALSE, fig.height=7, fig.width=7}
spearman_pval <- read.csv("/cbica/projects/network_replication/revisions/output/PNC/pspin_vals_CPAC.csv")
   
 
r_text_PNC_nonGSR <- expression(paste(italic("r "), "= -0.59, ",  , italic(p[spin]), "< 0.0001"))
(PNC_nonGSR.fig <- gam_figure_p.spin(GBC.axis_PNC_nonGSR, "GBC", "Schaefer200", r_text_PNC_nonGSR, 
                                      x_pos= 150, y_pos=0.030, ylim_lower=-0.027, ylim_upper=0.03) + ggtitle("No Global Signal 
Regression Applied") + theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        plot.title=element_text(hjust=0.5, size=24)))


r_text_PNC_partialcorr <- expression(paste(italic("r "), "= -0.26, ",  , italic(p[spin]), "< 0.01"))
(PNC_partialcorr.fig <- gam_figure_p.spin(GBC.axis_PNC_partialcorr, "GBC", "Schaefer200", r_text_PNC_partialcorr, 
                                      x_pos= 150, y_pos=0.02, ylim_lower=-0.035, ylim_upper=0.03) + ggtitle("Partial Correlation")) # not saving out partial correlation because there are only 7 parcels with significant age effect
 
```
 
#### Original GBC
```{r original Fig 4}

GBC.axis_PNC <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GBC.axis_schaefer200.csv", "PNC", "GBC"))
 

r_text_GBC.schaefer200 <- expression(paste(italic("r "), "= -0.71, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200_original <- gam_figure_p.spin(GBC.axis_PNC, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                      x_pos= 150, y_pos=0.14, ylim_lower=-0.065, ylim_upper=0.15) + ggtitle("Original Analysis") + theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.title=element_text(hjust=0.5, size=24)))

```

 
#### **Plot original, absolute correlation, thresholded, and no GSR**
```{r original absolute corr thresholded no GSR, fig.height= 15, fig.width= 15}

 
r_text_GBC.schaefer200 <- expression(paste(italic("r "), "= -0.71, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200_original <- gam_figure_p.spin(GBC.axis_PNC, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                      x_pos= 130, y_pos=0.14, ylim_lower=-0.065, ylim_upper=0.15) + ggtitle("Original Analysis") + theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.title=element_text(hjust=0.5, size=24)))

r_text_PNC_absvalue <- expression(paste(italic("r "), "= -0.48, ",  , italic(p[spin]), "< 0.01"))
(PNC_absvalue.fig <- gam_figure_p.spin(GBC.axis_PNC_absvalue, "GBC", "Schaefer200", r_text_PNC_absvalue, 
                                      x_pos= 130, y_pos=0.14, ylim_lower=-0.065, ylim_upper=0.15) + ggtitle("Absolute Correlation Coefficient") + theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(), plot.title=element_text(hjust=0.5, size=24)))


r_text_PNC_thresholded <- expression(paste(italic("r "), "= -0.49, ",  , italic(p[spin]), "< 0.01"))
(PNC_thresholded.fig <- gam_figure_p.spin(GBC.axis_PNC_thresholded, "GBC", "Schaefer200", r_text_PNC_thresholded, 
                                      x_pos= 130, y_pos=0.14, ylim_lower=-0.065, ylim_upper=0.15) + ggtitle("Thresholded Connectivity Matrices") + theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(), plot.title=element_text(hjust=0.5, size=24)))

 
r_text_PNC_nonGSR <- expression(paste(italic("r "), "= -0.59, ",  , italic(p[spin]), "< 0.0001"))
(PNC_nonGSR.fig <- gam_figure_p.spin(GBC.axis_PNC_nonGSR, "GBC", "Schaefer200", r_text_PNC_nonGSR, 
                                      x_pos= 130, y_pos=0.030, ylim_lower=-0.027, ylim_upper=0.03) + ggtitle("No Global Signal 
Regression Applied") + theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        plot.title=element_text(hjust=0.5, size=24)))



# arrange all together  
 
GBC_plot <- plot_grid(GBC_schaefer200_original, PNC_absvalue.fig, PNC_thresholded.fig, PNC_nonGSR.fig, labels="auto", label_fontface = "plain", label_size=24, scale=0.9, nrow=2)  

y.grob <- textGrob(expression(paste("Age Effect (", Delta, " Adj R"^"2)")), 
                   gp=gpar( col="black", fontsize=24), rot=90)

x.grob <- textGrob("Sensorimotor-Association Axis Rank", 
                   gp=gpar(col="black", fontsize=24))

#add axes to plot
GBC_plot.final <- grid.arrange(arrangeGrob(GBC_plot, left = y.grob, bottom = x.grob))
  
``` 


## **Supplementary Figure 7**
```{r recolor}
schaefer200x17.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x17_regionlist_final.csv")
schaefer200.parcel.labels <- schaefer200x17.parcel.labels #gbc
 
GBC.schaefer200.PNC <- read.csv("/cbica/projects/network_replication/output/PNC/GBC/GBCschaefer200_demographics_finalsample.csv")
names(GBC.schaefer200.PNC) <- gsub('X17Networks', "Networks", names(GBC.schaefer200.PNC))
GBC.schaefer200.PNC$sex <- as.factor(GBC.schaefer200.PNC$sex)
 
GBC.schaefer200.NKI <- read.csv("/cbica/projects/network_replication/output/NKI/GBC/GBCschaefer200_demographics_finalsample.csv")
names(GBC.schaefer200.NKI) <- gsub('X17Networks', "Networks", names(GBC.schaefer200.NKI))
GBC.schaefer200.NKI$sex <- as.factor(GBC.schaefer200.NKI$sex)

GBC.schaefer200.HCPD <- read.csv("/cbica/projects/network_replication/output/HCPD/GBC/GBCschaefer200_demographics_finalsample_covbat.csv") 
names(GBC.schaefer200.HCPD) <- gsub('X17Networks', "Networks", names(GBC.schaefer200.HCPD))
GBC.schaefer200.HCPD$sex <- as.factor(GBC.schaefer200.HCPD$sex)

GBC.schaefer200.HBN <- read.csv("/cbica/projects/network_replication/output/HBN/GBC/GBCschaefer200_demographics_finalsample_covbat.csv") 
names(GBC.schaefer200.HBN) <- gsub('X17Networks', "Networks", names(GBC.schaefer200.HBN))
GBC.schaefer200.HBN <- GBC.schaefer200.HBN[,-2]
GBC.schaefer200.HBN$sex <- as.factor(GBC.schaefer200.HBN$sex)

gam.fit_modelOnly <- function(measure, atlas, dataset, region, smooth_var, covariates, stats_only = FALSE){
  #Fit the gam
  dataname <- sprintf("%s.%s.%s", measure, atlas, dataset) 
  gam.data <- get(dataname) # Return the Value of a Named Object
  parcel <- region
  region <- str_replace(region, "-", ".")
  modelformula <- as.formula(sprintf("%s ~ s(%s, k=3, fx=T) + %s", region, smooth_var, covariates)) # 3 knots, fx = should term be unpenalized (so here, it is unpenalized)
  gam.model <- gam(modelformula, data=gam.data)
   
  return(gam.model)
}
  
parcel.labels <- schaefer200.parcel.labels$label
metric="GBC"
atlas_name="schaefer200"
network_parcellation=""
dataset_name="PNC"

make_fitted_df <- function(parcel.labels, metric, atlas_name, network_parcellation, dataset_name, sex_var_name) {
  fitted_df <- matrix(data=NA, nrow=1, ncol=8)
  fitted_df <- as.data.frame(fitted_df)
  colnames(fitted_df) <- c("sex", "age", "meanFD_avgSes", "fitted", "se", "lower", "upper", "region")

  for(row in c(1:length(parcel.labels))){ #for each region
      region <- parcel.labels[row] 
      GAM.RESULTS <- gam.fit_modelOnly(measure = metric, atlas = paste0(atlas_name, network_parcellation), dataset = dataset_name, region = region,
                                       smooth_var = "age", covariates = "sex + meanFD_avgSes")  
      
      newdf = expand.grid(sex=sex_var_name, age=c(seq(8, 22, 1)), meanFD_avgSes = mean(GAM.RESULTS$model$meanFD_avgSes))
      to_add <- cbind(fitted_values(GAM.RESULTS,data = newdf), c(rep(region, nrow(newdf))))
      names(to_add)[8] <- "region"
      fitted_df <- add_row(fitted_df, to_add)
      print(region)
  }
    fitted_df <- fitted_df[-1,]
    fitted_df <- fitted_df %>% arrange(age)
    if (str_detect(atlas_name, "schaefer") && metric == "GBC") {
      fitted_df$region <- gsub("Network", "17Network", fitted_df$region)
    }
    write.csv(fitted_df, sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/fitted%2$s_ageResolved_%3$s%4$s.csv", dataset_name, metric, atlas_name, network_parcellation), row.names = F, quote = F)
    return(fitted_df)

}

fitted_df_PNC <- make_fitted_df(schaefer200.parcel.labels$label, "GBC", "schaefer200", "", "PNC", "1")
fitted_df_NKI <- make_fitted_df(schaefer200.parcel.labels$label, "GBC", "schaefer200", "", "NKI", "Male")
fitted_df_HBN <- make_fitted_df(schaefer200.parcel.labels$label, "GBC", "schaefer200", "", "HBN", "Male")
fitted_df_HCPD <- make_fitted_df(schaefer200.parcel.labels$label, "GBC", "schaefer200", "", "HCPD", "M")

range(fitted_df_PNC$fitted) # -0.06424684  0.14165726
median(fitted_df_PNC$fitted) # 0.05155157

range(fitted_df_NKI$fitted) # -0.05699997  0.12628762
median(fitted_df_NKI$fitted) # 0.04733621

range(fitted_df_HCPD$fitted) # -0.04531437  0.11286720
median(fitted_df_HCPD$fitted) # 0.04742419

range(fitted_df_HBN$fitted) # -0.03790937  0.08700871
median(fitted_df_HBN$fitted) # 0.03499302
 
 


ageResolvedGBC_schaefer200_fig <- function(age_map, dataset_name) {
  fitted_df <- get(paste0("fitted_df_", dataset_name))
  
    ageMap.fig1 <- ggplot() + geom_brain(data=fitted_df[c(which(fitted_df$age==age_map)),], 
                                            atlas=schaefer17_200, 
                                            mapping=aes(fill=fitted), 
                                            show.legend=FALSE, 
                                            position = position_brain("right lateral")) + 
       #paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", limits = c(-0.05,0.12), oob=scales::squish, 
                          # values=rescale(c(-0.05,0.04,0.15))) + 
       scale_fill_gradientn(colors= c("#009DA1FF", "#FFFFFF","#D94602FF"), limits = c(-0.05,0.12), oob=scales::squish, 
                           values=rescale(c(-0.05,0.04,0.15))) + 
   theme_void()
    
    ageMap.fig2 <- ggplot() + geom_brain(data=fitted_df[c(which(fitted_df$age==age_map)),], 
                                            atlas=schaefer17_200, 
                                            mapping=aes(fill=fitted), 
                                            show.legend=FALSE, 
                                            position = position_brain("right medial")) + 
       #paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", limits = c(-0.05,0.12), oob=scales::squish, 
                          # values=rescale(c(-0.05,0.04,0.15))) + 
       scale_fill_gradientn(colors= c("#009DA1FF", "#FFFFFF","#D94602FF"), limits = c(-0.05,0.12), oob=scales::squish, 
                           values=rescale(c(-0.05,0.0,0.15))) + 
  theme_void()
  
  return(list(ageMap.fig1, ageMap.fig2))
}


 
  
age8_PNC_fig <- ageResolvedGBC_schaefer200_fig(8, "PNC")
age8_PNC_fig <- ggarrange(age8_PNC_fig[[1]],age8_PNC_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age14_PNC_fig <- ageResolvedGBC_schaefer200_fig(14, "PNC") 
age14_PNC_fig <- ggarrange(age14_PNC_fig[[1]],age14_PNC_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age22_PNC_fig <- ageResolvedGBC_schaefer200_fig(22, "PNC") 
age22_PNC_fig <- ggarrange(age22_PNC_fig[[1]],age22_PNC_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)


age8_NKI_fig <- ageResolvedGBC_schaefer200_fig(8, "NKI")
age8_NKI_fig <- ggarrange(age8_NKI_fig[[1]],age8_NKI_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age14_NKI_fig <- ageResolvedGBC_schaefer200_fig(14, "NKI") 
age14_NKI_fig <- ggarrange(age14_NKI_fig[[1]],age14_NKI_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age22_NKI_fig <- ageResolvedGBC_schaefer200_fig(22, "NKI") 
age22_NKI_fig <- ggarrange(age22_NKI_fig[[1]],age22_NKI_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

  
age8_HCPD_fig <- ageResolvedGBC_schaefer200_fig(8, "HCPD")
age8_HCPD_fig <- ggarrange(age8_HCPD_fig[[1]],age8_HCPD_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age14_HCPD_fig <- ageResolvedGBC_schaefer200_fig(14, "HCPD") 
age14_HCPD_fig <- ggarrange(age14_HCPD_fig[[1]],age14_HCPD_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age22_HCPD_fig <- ageResolvedGBC_schaefer200_fig(22, "HCPD") 
age22_HCPD_fig <- ggarrange(age22_HCPD_fig[[1]],age22_HCPD_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)


age8_HBN_fig <- ageResolvedGBC_schaefer200_fig(8, "HBN")
age8_HBN_fig <- ggarrange(age8_HBN_fig[[1]],age8_HBN_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age14_HBN_fig <- ageResolvedGBC_schaefer200_fig(14, "HBN") 
age14_HBN_fig <- ggarrange(age14_HBN_fig[[1]],age14_HBN_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)

age22_HBN_fig <- ageResolvedGBC_schaefer200_fig(22, "HBN") 
age22_HBN_fig <- ggarrange(age22_HBN_fig[[1]],age22_HBN_fig[[2]], common.legend = TRUE, legend="bottom", nrow=2)



```


```{r recolored plot, fig.height=10, fig.width=5}


plot_grid(age8_PNC_fig, age14_PNC_fig, age22_PNC_fig,  age8_NKI_fig, age14_NKI_fig, age22_NKI_fig, age8_HCPD_fig, age14_HCPD_fig, age22_HCPD_fig, age8_HBN_fig, age14_HBN_fig, age22_HBN_fig, rows = 4, scale = 0.9, labels = c("Age 8", "Age 14", "Age 22"), label_size = 10, label_fontface = "plain", label_x = 0.25, label_y = 1)
 
  
```

 

 


## **Supplementary Figures 8-10: Within and Between Network Connectivity (aka network pair analyses)**
1) correlation matrix between each pair of networks showing the age effect
```{r make withinbetween corrplot, fig.width=20, fig.height=15}

PNC_withinbetween <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMresults.withinbetween.age.csv", indir, "PNC"))
NKI_withinbetween <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMresults.withinbetween.age.csv", indir, "NKI"))
HCPD_withinbetween <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMresults.withinbetween.age.csv", indir, "HCPD"))
HBN_withinbetween <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMresults.withinbetween.age.csv", indir, "HBN"))

# make two new columns identifying network 1 and network 2
PNC_withinbetween <- PNC_withinbetween %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))
NKI_withinbetween <- NKI_withinbetween %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))
HCPD_withinbetween <- HCPD_withinbetween %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))
HBN_withinbetween <- HBN_withinbetween %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))


# make df for plotting: need to switch network 1 and 2 ordering for salience-dorsalattn and limbic-dorsal for visualization purposes
# also does fdr correction on non-duplicated pairs only
prep_withinbetween_df <- function(dataset) {
  df <- get(paste0(dataset, "_withinbetween"))  
  df$sorted_pairs <- apply(df[c("network1", "network2")], 1, 
                                         function(x) toString(sort(x)))  
  df <- df %>% group_by(sorted_pairs) %>% distinct(sorted_pairs, .keep_all = T)  
  df <- sig_parcels(df)
  df <- df %>% mutate(GAM.ageEffect_signif = ifelse(significant.fdr == 1, GAM.age.AdjRsq, NA))
  
  # switch network1 and 2 labeling for salience + dorsal 
  switch1 <- which(df$network1=="dorsalAttention" & df$network2=="salienceVentralAttention")
  orig_network1 <- df$network1[switch1]
  orig_network2 <- df$network2[switch1]
  df$network1[switch1] <- orig_network2
  df$network2[switch1] <- orig_network1
  
  # switch network1 and 2 labeling for limbic + dorsal 
  switch2 <- which(df$network1=="dorsalAttention" & df$network2=="limbic")
  orig_network1 <- df$network1[switch2]
  orig_network2 <- df$network2[switch2]
  df$network1[switch2] <- orig_network2
  df$network2[switch2] <- orig_network1
  
  # switch network1 and 2 labeling for frontoparietal + dorsal 
  switch3 <- which(df$network1=="dorsalAttention" & df$network2=="frontoparietalControl")
  orig_network1 <- df$network1[switch3]
  orig_network2 <- df$network2[switch3]
  df$network1[switch3] <- orig_network2
  df$network2[switch3] <- orig_network1
  return(df)
}
 


PNC_plot.df <- prep_withinbetween_df("PNC")
NKI_plot.df <- prep_withinbetween_df("NKI")
HCPD_plot.df <- prep_withinbetween_df("HCPD")
HBN_plot.df <- prep_withinbetween_df("HBN")
 
# make plots 
make_withinbetween_plot <- function(dataset) {
  df <- get(paste0(dataset, "_plot.df"))
  df <- df %>% mutate(GAM.ageEffect_signif = ifelse(significant.fdr == 1, GAM.age.AdjRsq, NA))
  df <- df %>% 
    mutate(network1_label = ifelse(network1 == "visual", "Visual", ifelse(network1=="somatomotor", "Somatomotor", ifelse(network1=="dorsalAttention", "Dorsal Attn", ifelse(network1=="salienceVentralAttention", "Salience Ventral Attn", ifelse(network1=="limbic", "Limbic", ifelse(network1=="frontoparietalControl", "Frontoparietal Control", ifelse(network1=="default", "Default", NA)))))))) %>% 
    mutate(network2_label = ifelse(network2 == "visual", "Visual", ifelse(network2=="somatomotor", "Somatomotor", ifelse(network2=="dorsalAttention", "Dorsal Attn", ifelse(network2=="salienceVentralAttention", "Salience Ventral Attn", ifelse(network2=="limbic", "Limbic", ifelse(network2=="frontoparietalControl", "Frontoparietal Control", ifelse(network2=="default", "Default", NA))))))))
  plot <- ggplot(df, aes(x = network1_label, y = network2_label, fill = GAM.age.AdjRsq)) +
  geom_tile() + 
  theme_classic(base_size=18) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=18), 
        axis.text.y = element_text(size=18),
        axis.title.x = element_blank(), axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5), 
        legend.key.width = unit(2, 'cm'), legend.key.height = unit(1, 'cm'), 
        legend.title = element_text(size=18), legend.text = element_text(size=18), legend.direction = "horizontal") + 
    geom_text(aes(network1_label, network2_label, label=ifelse(Anova.age.pvalue.fdr < 0.0001, "***", 
                                                               ifelse(Anova.age.pvalue.fdr < 0.001, "**", 
                                                                      ifelse(Anova.age.pvalue.fdr < 0.05, "*", "")))), 
                          colour = "black",  size=10)  +
  scale_fill_gradientn(name="Age Effect", colors= c("#009DA1FF", "white","#D94602FF"), 
                       limits = c(-0.04, 0.12), 
                       values=rescale(c(-0.04,0,0.12), oob=squish), 
                       na.value="gray93", 
                       oob=squish) + ggtitle(dataset) 
  return(plot)
          
}
 

make_withinbetween_plot_ageeffect <- function(dataset) {
  df <- get(paste0(dataset, "_plot.df"))
  df <- df %>% mutate(GAM.ageEffect_signif = ifelse(significant.fdr == 1, GAM.age.AdjRsq, NA))
  plot <- ggplot(df, aes(x = network1, y = network2, fill = GAM.age.AdjRsq)) +
  geom_tile() + geom_text(aes(network1, network2, label=round(GAM.age.AdjRsq,3)), colour = "black", check_overlap = TRUE)   + 
  theme_classic(base_size=18) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=18), 
        axis.text.y = element_text(size=18),
        axis.title.x = element_blank(), axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5), 
        legend.key.width = unit(2, 'cm'), legend.key.height = unit(1, 'cm'), 
        legend.title = element_text(size=18), legend.text = element_text(size=18), legend.direction = "horizontal") + 
    
  scale_fill_gradientn(name="Age Effect", colors= c("#009DA1FF", "white","#D94602FF"), 
                       limits = c(-0.04, 0.12), 
                       values=rescale(c(-0.04,0,0.12), oob=squish), 
                       na.value="gray93", 
                       oob=squish) + ggtitle(dataset) 
  return(plot)
          
}
 

PNC.plot <- make_withinbetween_plot("PNC")
NKI.plot <- make_withinbetween_plot("NKI")
HCPD.plot <- make_withinbetween_plot("HCPD") + ggtitle("HCP-D")
HBN.plot <- make_withinbetween_plot("HBN")

final_withinbetween <- PNC.plot + NKI.plot + HCPD.plot + HBN.plot
 
final_withinbetween <- ggarrange(PNC.plot,HCPD.plot, NKI.plot, HBN.plot, common.legend = TRUE, legend="bottom", labels=c('a', 'c', 'b', 'd'), font.label=list(size=24, face="bold"))

 
```

 
2) gam smooths for each network pair showing developmental trajectory (non-zero centered)
 
```{r compute SA axis mean and range}

schaefer200x7_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x7_SAaxis.csv")
schaefer200x7_SAaxis$label <- gsub("7Network", "Network", schaefer200x7_SAaxis$label) 

Vis <- which(str_detect(schaefer200x7_SAaxis$label, "Vis")) # mean SA rank = 32.5
Vis_ranks <- schaefer200x7_SAaxis$SA.axis_rank[Vis] 
mean_Vis <- mean(Vis_ranks)
range_Vis <- range(Vis_ranks)

SM <- which(str_detect(schaefer200x7_SAaxis$label, "SomMot")) # mean SA rank = 40
SM_ranks <- schaefer200x7_SAaxis$SA.axis_rank[SM] 
mean_SM <- mean(SM_ranks)
range_SM <- range(SM_ranks)

DMN <- which(str_detect(schaefer200x7_SAaxis$label, "Default")) # mean SA rank = 155.3
DMN_ranks <- schaefer200x7_SAaxis$SA.axis_rank[DMN] 
mean_DMN <- mean(DMN_ranks)
range_DMN <- range(DMN_ranks)
```

```{r make withinbetween gam smooths}

PNC_withinbetween_smooths <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMsmoothfits.withinbetween.csv", indir, "PNC"))
NKI_withinbetween_smooths <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMsmoothfits.withinbetween.csv", indir, "NKI"))
HCPD_withinbetween_smooths <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMsmoothfits.withinbetween.csv", indir, "HCPD"))
HBN_withinbetween_smooths <- read.csv(sprintf("%1$s%2$s/withinbetween/GAM/GAMsmoothfits.withinbetween.csv", indir, "HBN"))

# make two new columns identifying network 1 and network 2
PNC_withinbetween_smooths <- PNC_withinbetween_smooths %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))
NKI_withinbetween_smooths <- NKI_withinbetween_smooths %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))
HCPD_withinbetween_smooths <- HCPD_withinbetween_smooths %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))
HBN_withinbetween_smooths <- HBN_withinbetween_smooths %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))

 

smooths_noncentered_plot <- function(dataset) {
  df <- get(paste0(dataset, "_withinbetween_smooths"))
  df$label_abbrev  <- gsub("visual", "Vis", df$label) 
  df$label_abbrev <- gsub("somatomotor", "SM", df$label_abbrev)
  df$label_abbrev <- gsub("salienceVentralAttention", "SalVAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("dorsalAttention", "DorsAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("frontoparietalControl", "FPN", df$label_abbrev) 
  df$label_abbrev <- gsub("default", "DMN", df$label_abbrev) 
  df$label_abbrev <- gsub("limbic", "Limbic", df$label_abbrev) 
  df$label_abbrev <- gsub("_", "-", df$label_abbrev) 
  
  df_vis <- df %>% filter(str_detect(label_abbrev, "Vis-"))
  vis.fig <- ggplot(df_vis, aes(age,fit,group=label_abbrev)) + 
      geom_line(data = df_vis, size=1.5, alpha = .8, color="#0091A8FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1.2)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset) + ylim(min(df$fit), 0.3) 
  
 
  df_SM <- df %>% filter(str_detect(label_abbrev, "SM-"))
  SM.fig <- ggplot(df_SM, aes(age,fit,group=label_abbrev)) + 
      geom_line(data = df_SM, size=1.5, alpha = .8, color="#0091A8FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1.2)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset) + ylim(min(df$fit), 0.3) 
 
  return(list(vis.fig, SM.fig))
}

 
 
# make smooths without within-network trajectory for DMN
PNC_withinbetween_smooths_DMN <- PNC_withinbetween_smooths %>% filter((!network1=="default" & network2=="default"))
NKI_withinbetween_smooths_DMN <- NKI_withinbetween_smooths %>% filter((!network1=="default" & network2=="default"))
HCPD_withinbetween_smooths_DMN <- HCPD_withinbetween_smooths %>% filter((!network1=="default" & network2=="default"))
HBN_withinbetween_smooths_DMN <- HBN_withinbetween_smooths %>% filter((!network1=="default" & network2=="default"))
 
 
DMN_smooths_noncentered_plot <- function(dataset) {
  df <- get(paste0(dataset, "_withinbetween_smooths_DMN"))
  df$label_abbrev  <- gsub("visual", "Vis", df$label) 
  df$label_abbrev <- gsub("somatomotor", "SM", df$label_abbrev)
  df$label_abbrev <- gsub("salienceVentralAttention", "SalVAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("dorsalAttention", "DorsAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("frontoparietalControl", "FPN", df$label_abbrev) 
  df$label_abbrev <- gsub("default", "DMN", df$label_abbrev) 
  df$label_abbrev <- gsub("limbic", "Limbic", df$label_abbrev) 
  df$label_abbrev <- gsub("_", "-", df$label_abbrev) 
  
  df_DMN <- df %>% filter(str_detect(label_abbrev, "-DMN"))
  DMN.fig <- ggplot(df_DMN, aes(age,fit,group=label_abbrev)) + 
      geom_line(data = df_DMN, size=1.5, alpha = .8, color="#B01C13FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset) + ylim(min(df$fit), 0.1) 
  return(DMN.fig)
}

```
 
```{r make noncentered plots}

PNC_smooths_noncentered <- smooths_noncentered_plot("PNC")
names(PNC_smooths_noncentered) <- c("Vis", "SM")
PNC_smooths_noncentered_DMN <- DMN_smooths_noncentered_plot("PNC")

NKI_smooths_noncentered <- smooths_noncentered_plot("NKI")
names(NKI_smooths_noncentered) <- c("Vis", "SM")
NKI_smooths_noncentered_DMN <- DMN_smooths_noncentered_plot("NKI")


HCPD_smooths_noncentered <- smooths_noncentered_plot("HCPD")
names(HCPD_smooths_noncentered) <- c("Vis", "SM")
HCPD_smooths_noncentered_DMN <- DMN_smooths_noncentered_plot("HCPD")


HBN_smooths_noncentered <- smooths_noncentered_plot("HBN")
names(HBN_smooths_noncentered) <- c("Vis", "SM")
HBN_smooths_noncentered_DMN <- DMN_smooths_noncentered_plot("HBN")

```
 

```{r vis noncentered, fig.height=15, fig.width=15}
plot_grid(PNC_smooths_noncentered$Vis, HCPD_smooths_noncentered$Vis, NKI_smooths_noncentered$Vis, HBN_smooths_noncentered$Vis)
```

```{r sm noncentered, fig.height=15, fig.width=15}
plot_grid(PNC_smooths_noncentered$SM, HCPD_smooths_noncentered$SM, NKI_smooths_noncentered$SM, HBN_smooths_noncentered$SM)
```

```{r DMN no within traj, fig.width=15, fig.height=15}
plot_grid(PNC_smooths_noncentered_DMN, HCPD_smooths_noncentered_DMN, NKI_smooths_noncentered_DMN, HBN_smooths_noncentered_DMN)
```


3) zero-centered smooths

```{r load_zerosmooths_dem}

# load mean connectivity and demographics
PNC_demographics <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/PNC_demographics_finalsample_20230629.csv")
PNC_demographics <- PNC_demographics %>% dplyr::rename(subject=sub) %>% dplyr::select(subject, age, sex, meanFD_avgSes)
subxnetpair.PNC <- read.csv(sprintf("/cbica/projects/network_replication/revisions/output/%1$s/withinbetween/withinbetween_subxnetpair_matrix_schaefer200x7_orig.csv", "PNC"))
PNC_dem <- merge(subxnetpair.PNC, PNC_demographics, by="subject")
PNC_dem$sex <- as.factor(PNC_dem$sex)

NKI_demographics <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_demographics_finalsample_20230629.csv")
NKI_demographics <- NKI_demographics %>% dplyr::rename(subject=sub) %>% dplyr::select(subject, age, sex, meanFD_avgSes)
NKI_demographics$subject <- gsub("sub-", "", NKI_demographics$subject)
subxnetpair.NKI <- read.csv(sprintf("/cbica/projects/network_replication/revisions/output/%1$s/withinbetween/withinbetween_subxnetpair_matrix_schaefer200x7_orig.csv", "NKI"))
NKI_dem <- merge(subxnetpair.NKI, NKI_demographics, by="subject")
NKI_dem$sex <- as.factor(NKI_dem$sex)
 
HCPD_demographics <- read.csv("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_demographics_finalsample_20221226.csv")
names(HCPD_demographics)[c(which(names(HCPD_demographics) == "sub"))] <- "subject"
HCPD_demographics$age <- HCPD_demographics$interview_age/12
HCPD_demographics <- HCPD_demographics[,c(which(names(HCPD_demographics) == "subject"), which(names(HCPD_demographics) == "sex"), which(names(HCPD_demographics)=="age"), which(names(HCPD_demographics) =="meanFD_avgSes"))] 
subxnetpair.HCPD <- read.csv(sprintf("/cbica/projects/network_replication/revisions/output/%1$s/withinbetween/withinbetween_subxnetpair_matrix_schaefer200x7_orig.csv", "HCPD"))
HCPD_dem <- merge(subxnetpair.HCPD, HCPD_demographics, by="subject")
HCPD_dem$sex <- as.factor(HCPD_dem$sex)


HBN_demographics <- read.csv("/cbica/projects/network_replication/input/HBN/sample_selection/HBN_demographics_finalsample_20230629.csv")
names(HBN_demographics)[c(which(names(HBN_demographics) == "sub"))] <- "subject"
HBN_demographics <- HBN_demographics[,c(which(names(HBN_demographics) == "subject"), which(names(HBN_demographics) == "sex"), which(names(HBN_demographics)=="age"), which(names(HBN_demographics) =="meanFD_avgSes"))] 
subxnetpair.HBN<- read.csv(sprintf("/cbica/projects/network_replication/revisions/output/%1$s/withinbetween/withinbetween_subxnetpair_matrix_schaefer200x7_orig.csv", "HBN"))
HBN_dem <- merge(subxnetpair.HBN, HBN_demographics, by="subject")
HBN_dem$sex <- as.factor(HBN_dem$sex)
 

```

```{r zerosmooths functions}
## Function for estimating zero-centered smooths
## @param knots An integer representing k
## @param set_fx TRUE or FALSE indicating fx=T or F (remember fx=T means unpenalized, fx=F means penalized)
estimate_smooth_fits <- function(dataset) {
  dataname <- paste0(dataset, "_dem") 
  gam.data <- get(dataname) # Return the Value of a Named Object
  gam.data$sex <- as.factor(gam.data$sex)
  long_df<- gam.data[,-1] %>% pivot_longer(cols = !contains(c("age","sex", "meanFD_avgSes")), names_to = "label", values_to = "mean_connectivty")
  smooth_fits <- long_df %>% group_by(label) %>% do(fit = smooth_estimates(gam(mean_connectivty ~ s(age,k=3,fx=TRUE),data=.))) %>% unnest(fit)
  return(smooth_fits)
}
 

smooths_centered_plot <- function(dataset) {
  df <- get(paste0(dataset, "_centered"))
  df <- df %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))

  df$label_abbrev  <- gsub("visual", "Vis", df$label) 
  df$label_abbrev <- gsub("somatomotor", "SM", df$label_abbrev)
  df$label_abbrev <- gsub("salienceVentralAttention", "SalVAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("dorsalAttention", "DorsAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("frontoparietalControl", "FPN", df$label_abbrev) 
  df$label_abbrev <- gsub("default", "DMN", df$label_abbrev) 
  df$label_abbrev <- gsub("limbic", "Limbic", df$label_abbrev) 
  df$label_abbrev <- gsub("_", "-", df$label_abbrev) 
  
  df_vis <- df %>% filter(str_detect(label_abbrev, "Vis-"))
  vis.fig <- ggplot(df_vis, aes(age,est,group=label_abbrev)) + 
      geom_line(data = df_vis, size=1.5, alpha = .8, color="#0091A8FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset)  + ylim(-0.08, 0.08)
   
 
  df_SM <- df %>% filter(str_detect(label_abbrev, "SM-"))
  SM.fig <- ggplot(df_SM, aes(age,est,group=label_abbrev)) + 
      geom_line(data = df_SM, size=1.5, alpha = .8, color="#0091A8FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset)  + ylim(-0.04, 0.04)
 
   
  
  df_DMN <- df %>% filter(str_detect(label_abbrev, "DMN-"))
  DMN.fig <- ggplot(df_DMN, aes(age,est,group=label_abbrev)) + 
      geom_line(data = df_DMN, size=1.5, alpha = .8, color="#B01C13FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset) + ylim(-0.04, 0.04)
    return(list(vis.fig, SM.fig))
}


 
DMN_smooths_centered_plot <- function(dataset) {
  df <- get(paste0(dataset, "_centered_DMN"))
  df <- df %>% mutate(network1=str_extract(label, "[[:alpha:]]+"), network2=str_extract(label, "(?<=_).*"))

  df$label_abbrev  <- gsub("visual", "Vis", df$label) 
  df$label_abbrev <- gsub("somatomotor", "SM", df$label_abbrev)
  df$label_abbrev <- gsub("salienceVentralAttention", "SalVAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("dorsalAttention", "DorsAttn", df$label_abbrev) 
  df$label_abbrev <- gsub("frontoparietalControl", "FPN", df$label_abbrev) 
  df$label_abbrev <- gsub("default", "DMN", df$label_abbrev) 
  df$label_abbrev <- gsub("limbic", "Limbic", df$label_abbrev) 
  df$label_abbrev <- gsub("_", "-", df$label_abbrev) 
  
  df_DMN <- df %>% filter(str_detect(label_abbrev, "-DMN"))
  DMN.fig <- ggplot(df_DMN, aes(age,est,group=label_abbrev)) + 
      geom_line(data = df_DMN, size=1.5, alpha = .8, color="#B01C13FF") + 
    theme_classic(base_size = 18) + 
      theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) + 
    scale_x_continuous(limits = c(5, 30)) +
    geom_dl(aes(label = label_abbrev), method = list(dl.trans(x = x+0.1), "last.qp", cex=1)) +  
    xlab("Age (years)") + ylab("Mean Connectivity") + ggtitle(dataset) + ylim(-0.04, 0.04)
  return(DMN.fig)
}

 
```


```{r make zero smooths and plots}
PNC_centered <- estimate_smooth_fits("PNC")
NKI_centered <- estimate_smooth_fits("NKI")
HCPD_centered <- estimate_smooth_fits("HCPD")
HBN_centered <- estimate_smooth_fits("HBN")

PNC_smooths_centered <- smooths_centered_plot("PNC")
names(PNC_smooths_centered) <- c("Vis", "SM")


NKI_smooths_centered <- smooths_centered_plot("NKI")
names(NKI_smooths_centered) <- c("Vis", "SM")


HCPD_smooths_centered <- smooths_centered_plot("HCPD")
names(HCPD_smooths_centered) <- c("Vis", "SM")


HBN_smooths_centered <- smooths_centered_plot("HBN")
names(HBN_smooths_centered) <- c("Vis", "SM")



# remove within network for DMN
PNC_centered_DMN <- PNC_centered %>% filter(!label=="default_default")
NKI_centered_DMN <- NKI_centered %>% filter(!label=="default_default")
HCPD_centered_DMN <- HCPD_centered %>% filter(!label=="default_default")
HBN_centered_DMN <- HBN_centered %>% filter(!label=="default_default")


PNC_smooths_centered_DMN <- DMN_smooths_centered_plot("PNC")
NKI_smooths_centered_DMN <- DMN_smooths_centered_plot("NKI")
HCPD_smooths_centered_DMN <- DMN_smooths_centered_plot("HCPD")
HBN_smooths_centered_DMN <- DMN_smooths_centered_plot("HBN")
```


```{r vis centered, fig.height=15, fig.width=15}
plot_grid(PNC_smooths_centered$Vis, HCPD_smooths_centered$Vis, NKI_smooths_centered$Vis, HBN_smooths_centered$Vis)
```

```{r sm centered, fig.height=15, fig.width=15}
plot_grid(PNC_smooths_centered$SM, HCPD_smooths_centered$SM, NKI_smooths_centered$SM, HBN_smooths_centered$SM)
```

```{r DMN no within traj, fig.width=15, fig.height=15}
plot_grid(PNC_smooths_centered_DMN, HCPD_smooths_centered_DMN, NKI_smooths_centered_DMN, HBN_smooths_centered_DMN)
```




## **Supplementary Figure 11-15: Seed-based analyses**
```{r load edges}
gam.edge.PNC <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.schaefer200x7.RData", "PNC", "edge"))
gam.edge.NKI <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.schaefer200x7.RData", "NKI", "edge"))
gam.edge.HCPD <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.schaefer200x7_covbat.RData", "HCPD", "edge"))
gam.edge.HBN <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.schaefer200x7_covbat.RData", "HBN", "edge"))
 
prep_edge_dfs <- function(dataset) {
  df <- get(paste0("gam.edge.", dataset))
  df <- sig_parcels(df)
  df$significant.fdr <- gsub("0", "Non_Sig", df$significant.fdr)
  df$significant.fdr <- gsub("1", "Sig", df$significant.fdr)
  df <- df %>% mutate(network1=sub("(_to_).*", "", label), network2=sub(".*(_to_)", "", label)) 
  df$network1 <- gsub("_to", "", df$network1)
  df$network2 <- gsub("_to_", "", df$network2)
  
  return(df)
}

gam.edge.PNC <- prep_edge_dfs("PNC") 
gam.edge.NKI <- prep_edge_dfs("NKI") 
gam.edge.HCPD <- prep_edge_dfs("HCPD") 
gam.edge.HBN <- prep_edge_dfs("HBN") 
 

```
 

```{r seed based four datasets}
view_age_effect <- function(dataset, parcel){
  gam.edge <- get(paste0("gam.edge.", dataset))
  parcel_df <- gam.edge %>% 
      filter(network1 == parcel | network2 == parcel) %>% 
      arrange(network2)
  parcel_df$region <- ifelse(parcel_df$network1 == parcel, parcel_df$network2, parcel_df$network1) # get regions that parcel is connected to 
  
  parcel_df[nrow(parcel_df) + 1,] <- c(rep(NA, ncol(parcel_df)-4), "Sig", c(0,0), parcel)
  parcel_df$region <- ifelse(str_detect(parcel_df$region, "LH"), paste0("lh_7", parcel_df$region), paste0("rh_7", parcel_df$region)) # reformat 'region' to match ggseg schaefer 'label'
  
  
  # add lh_Background+FreeSurfer_Defined_Medial_Wall and rh_Background+FreeSurfer_Defined_Medial_Wall
  parcel_df[nrow(parcel_df) + 1,] <- c(rep(0, ncol(parcel_df)-4), "Sig", c(0,0),  "rh_Background+FreeSurfer_Defined_Medial_Wall")
  parcel_df[nrow(parcel_df) + 1,] <- c(rep(0, ncol(parcel_df)-4), "Sig", c(0,0), "lh_Background+FreeSurfer_Defined_Medial_Wall")
  
  parcel_df <- parcel_df %>% select(-label) # remove original label  
  parcel_df$label <- parcel_df$region 
  
  parcel_df <- parcel_df %>% select(-region)
 
  parcel_df$GAM.age.AdjRsq <- as.numeric(parcel_df$GAM.age.AdjRsq)
   
  plot <- ggplot() + geom_brain(data=parcel_df,   
                        atlas=schaefer7_200, 
                        mapping=aes(fill=GAM.age.AdjRsq, 
                                    colour=significant.fdr, 
                                    size=I(0.3)), 
                        show.legend=TRUE, 
                        position = position_brain(side ~ hemi)) + 
    theme_void() + 
    scale_colour_manual(values = c(Sig = "black", Non_Sig = "grey84"), guide = "none") + 
    scale_fill_gradientn(colors= c("#00A3A7FF", "#FFFFFF","#C75DAAFF"), na.value="red", 
                         limits = c(min(parcel_df$GAM.age.AdjRsq), max(parcel_df$GAM.age.AdjRsq)), 
                         oob = squish,
                         values=rescale(c(min(parcel_df$GAM.age.AdjRsq, na.rm=T),0,max(parcel_df$GAM.age.AdjRsq, na.rm=T)))) + ggtitle(gsub("Networks_", "", parcel)) +
    theme(plot.title=element_text(hjust=0.5))
  return(plot)
}
 
```
 

```{r seedbased left hemisphere only}
# default  
default_PNC <- view_age_effect(dataset="PNC", parcel="Networks_LH_Default_PFC_11")  
default_NKI <- view_age_effect(dataset="NKI", parcel="Networks_LH_Default_PFC_11")  
default_HCPD <- view_age_effect(dataset="HCPD", parcel="Networks_LH_Default_PFC_11")  
default_HBN <- view_age_effect(dataset="HBN", parcel="Networks_LH_Default_PFC_11")  


# M1  
SM_PNC <- view_age_effect(dataset="PNC", parcel="Networks_LH_SomMot_9")  
SM_NKI <- view_age_effect(dataset="NKI", parcel="Networks_LH_SomMot_9")  
SM_HCPD <- view_age_effect(dataset="HCPD", parcel="Networks_LH_SomMot_9")  
SM_HBN <- view_age_effect(dataset="HBN", parcel="Networks_LH_SomMot_9")  


# visual  
Vis_PNC <- view_age_effect(dataset="PNC", parcel="Networks_LH_Vis_13")  
Vis_NKI <- view_age_effect(dataset="NKI", parcel="Networks_LH_Vis_13")  
Vis_HCPD <- view_age_effect(dataset="HCPD", parcel="Networks_LH_Vis_13")  
Vis_HBN <- view_age_effect(dataset="HBN", parcel="Networks_LH_Vis_13")  


# ventral attention  
SalVentAttn_PNC <- view_age_effect(dataset="PNC", parcel="Networks_LH_SalVentAttn_Med_3")  
SalVentAttn_NKI <- view_age_effect(dataset="NKI", parcel="Networks_LH_SalVentAttn_Med_3")  
SalVentAttn_HCPD <- view_age_effect(dataset="HCPD", parcel="Networks_LH_SalVentAttn_Med_3")  
SalVentAttn_HBN <- view_age_effect(dataset="HBN", parcel="Networks_LH_SalVentAttn_Med_3") 

 
# FPN
FPN_PNC <- view_age_effect(dataset="PNC", parcel="Networks_LH_Cont_PFCl_5")  
FPN_NKI <- view_age_effect(dataset="NKI", parcel="Networks_LH_Cont_PFCl_5")  
FPN_HCPD <- view_age_effect(dataset="HCPD", parcel="Networks_LH_Cont_PFCl_5")  
FPN_HBN <- view_age_effect(dataset="HBN", parcel="Networks_LH_Cont_PFCl_5")  
```


```{r default 4 datasets lh, fig.height=15, fig.width=15}
PNC_default_figs <- default_PNC + plot_annotation(title = 'PNC', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

NKI_default_figs <- default_NKI + plot_annotation(title = 'NKI', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HCPD_default_figs <- default_HCPD + plot_annotation(title = 'HCP-D', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HBN_default_figs <- default_HBN + plot_annotation(title = 'HBN', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))
 

plot_grid(PNC_default_figs, HCPD_default_figs, NKI_default_figs, HBN_default_figs)
 
 
```


```{r SM 4 datasets lh, fig.height=15, fig.width=15}
PNC_SM_figs <- SM_PNC + plot_annotation(title = 'PNC', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

NKI_SM_figs <- SM_NKI + plot_annotation(title = 'NKI', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HCPD_SM_figs <- SM_HCPD + plot_annotation(title = 'HCP-D', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HBN_SM_figs <- SM_HBN + plot_annotation(title = 'HBN', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))
 

plot_grid(PNC_SM_figs, HCPD_SM_figs, NKI_SM_figs, HBN_SM_figs) 
```


```{r Vis 4 datasets lh, fig.height=15, fig.width=15}
PNC_Vis_figs <- Vis_PNC + plot_annotation(title = 'PNC', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

NKI_Vis_figs <- Vis_NKI + plot_annotation(title = 'NKI', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HCPD_Vis_figs <- Vis_HCPD + plot_annotation(title = 'HCP-D', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HBN_Vis_figs <- Vis_HBN + plot_annotation(title = 'HBN', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))
 

plot_grid(PNC_Vis_figs, HCPD_Vis_figs, NKI_Vis_figs, HBN_Vis_figs) 
```



```{r SalVentAttn 4 datasets lh, fig.height=15, fig.width=15}
PNC_SalVentAttn_figs <- SalVentAttn_PNC + plot_annotation(title = 'PNC', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

NKI_SalVentAttn_figs <- SalVentAttn_NKI + plot_annotation(title = 'NKI', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HCPD_SalVentAttn_figs <- SalVentAttn_HCPD + plot_annotation(title = 'HCP-D', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

HBN_SalVentAttn_figs <- SalVentAttn_HBN + plot_annotation(title = 'HBN', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))
 

plot_grid(PNC_SalVentAttn_figs, HCPD_SalVentAttn_figs, NKI_SalVentAttn_figs, HBN_SalVentAttn_figs)
 
```
 
 

```{r FPN 4 datasets lh, fig.height=15, fig.width=15}
 
FPN_PNC <- view_age_effect(dataset="PNC", parcel="Networks_LH_Cont_Par_3")  
FPN_NKI <- view_age_effect(dataset="NKI", parcel="Networks_LH_Cont_Par_3")  
FPN_HCPD <- view_age_effect(dataset="HCPD", parcel="Networks_LH_Cont_Par_3")  
FPN_HBN <- view_age_effect(dataset="HBN", parcel="Networks_LH_Cont_Par_3")  

 
PNC_FPN_figs <- FPN_PNC + plot_annotation(title = 'PNC', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))
 
NKI_FPN_figs <- FPN_NKI + plot_annotation(title = 'NKI', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))
 
HCPD_FPN_figs <- FPN_HCPD + plot_annotation(title = 'HCP-D', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

 
HBN_FPN_figs <- FPN_HBN + plot_annotation(title = 'HBN', theme=theme(plot.title=element_text(hjust=0.43, face='bold')))

plot_grid(PNC_FPN_figs, HCPD_FPN_figs, NKI_FPN_figs, HBN_FPN_figs)
 
```


