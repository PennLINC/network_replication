---
title: "Fit GAMs"
author: "Audrey Luo"
date: "2023-11-15"
output: html_document
---
 

```{r setup, include=FALSE}

library(dplyr)
source("/cbica/projects/network_replication/revisions/code/utils/GAM_functions_revisions.R")
source("/cbica/projects/network_replication/revisions/code/utils/fitGAMs_revisions.R")  
dataset = "PNC"
knitr::opts_chunk$set(include = FALSE, eval = TRUE, echo = FALSE, warning = FALSE, message = FALSE) 
```
 
 
# make connectivityMetric-demographics .csv's
```{r connMetric_demographics, include=FALSE}

demographics <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/PNC_demographics_finalsample_20230629.csv")
demographics <- demographics %>% dplyr::rename(subject=sub)
 
 
# GBC - combine GBC with demographics

subxparcel.matrix <- read.csv("/Users/audluo/cbica/projects/network_replication/revisions/output/PNC/GBC/GBC_subxparcel_matrix_schaefer200x7_orig.csv")
GBC.schaefer200_PNC <- merge(subxparcel.matrix, demographics, by="subject")
   
GBC.schaefer200_PNC$sex <- as.factor(GBC.schaefer200_PNC$sex) 
```
  
 
# load parcel labels 
```{r}
# load parcel labels 
schaefer200x7.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x7_regionlist_final.csv")
 
```  

 

# Fit GAMs for GBC 
```{r}
# GBC GAMs 
parcel.labels <- schaefer200x7.parcel.labels$label
gam.age <- matrix(data=NA, nrow=length(parcel.labels), ncol=9) #empty matrix to save gam.fit output to

for(row in c(1:length(parcel.labels))){ #for each region
  region <- parcel.labels[row] 
  GAM.RESULTS <- gam.fit(measure = "GBC", atlas = "schaefer200", conn_type = "PNC", region = region, smooth_var = "age", covariates = "sex + meanFD_avgSes") #run the gam.fit function
  gam.age[row,] <- GAM.RESULTS}
gam.age <- as.data.frame(gam.age)
colnames(gam.age) <- c("label","GAM.age.Fvalue","GAM.age.pvalue","GAM.age.AdjRsq","Anova.age.pvalue","age.onsetchange","age.peakchange","maxage.BNC.increase","age.maturation" )
cols = c(2:9)    
gam.age[,cols] = apply(gam.age[,cols], 2, function(x) as.numeric(as.character(x)))
gam.age <- gam.age %>% mutate(significant = (Anova.age.pvalue < 0.05))

write.csv(gam.age, sprintf("/cbica/projects/network_replication/revisions/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s%4$s_%5$s.csv", "PNC", "GBC", "schaefer200", "x7", "orig"), row.names = F, quote = F)

```

   

