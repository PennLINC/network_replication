---
title: "PNC Sample Selection"
author: "Audrey Luo"
date: "2022-12-27"
output: html_document
---

# Sample Selection process
1) original sample: N=1559, 4546 scans total, ages 8-23
2) exclude participants with medical conditions affecting brain function and gross neurological abnormalities: N=1413, 4136 scans 
3) include passing T1 QC: N=1374, 4041 scans
4) include meanFD < 0.3: N=1262, 3365 scans
5) include scans with at least 7 minutes of scan time: N= 1182,  628 females.

range before: 3.60 to 33.25 min
median before: 28.25 min
mode before: 28.25 min

range after: 8.35 to 33.25 min
median after: 28.25 min

Age: mean = 15.4, SD = 3.5
 
Race
- white = 551 - 45.7%
- black = 513 - 42.5%
- other (native american + hawaiian pi) = 4 + 1 - 0.41%
- asian = 11 - 0.9%
- missing = 0
- mixed = 127 - 10.5%
 
# Sample Selection for sensitivity analysis (rest only)
5) include scans with at least 6 minutes of rest-only scan time (lowered threshold due to fewer total scans available after selecting for rest-only): N= 998, 1060 scans, 549 females 

Notes:
- mean FD is averaged across the scans in a given session
 
 
```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(magrittr)
library(reshape)
library(reshape2)
library(MASS)
library(stargazer)
library(ggplot2)
library(ggpubr)
library(reticulate) 
# reticulate::py_install("pandas") # install pandas for python code
# reticulate::py_install("glob2")  # install glob2 for python code
  
```


## Concatenate CPAC qc files
```{python}
import pandas as pd
import glob2 as glob
import sys
import os
  
path = "/cbica/projects/network_replication/revisions/input/PNC/CPAC_subfiles/qc_files"  
all_files = glob.glob(os.path.join(path, "*.txt")) # load all qc csv filenames 
 

df_from_each_file = (pd.read_csv(f, header=0, sep=',') for f in all_files) # read txt files
concatenated_df = pd.concat(df_from_each_file, ignore_index=True) # concatenate txt files

path=r'/cbica/projects/network_replication/revisions/input/PNC/CPAC_subfiles/qc_files'
concatenated_df.to_csv(os.path.join(path,r'CPAC_PNC_qc_concat_20231130.csv'),index=False) # save out concatenated qc files

```



## 1) original sample: N=1537, ages 8-23
```{r qc_setup}
# load concatenated qc files
collated_PNC.CPAC <- read.csv("/cbica/projects/network_replication/revisions/input/PNC/CPAC_subfiles/qc_files/CPAC_PNC_qc_concat_20231130.csv")
length(unique(collated_PNC.CPAC$Subject)) # 1537 participants before any qc

collated_PNC.CPAC <- collated_PNC.CPAC %>% dplyr::rename(sub=Subject, meanFD=MeanFD_Power)  
length(unique(collated_PNC.CPAC$sub)) #   participants with n-back
 

# make list of participant ID's to merge with demographics in this chunk  
scanned_participants <- data.frame(unique(collated_PNC.CPAC$sub))
names(scanned_participants) <- "sub"

# load T1 QA - T1 ratings used in previous publications 
T1_QA <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/n1601_t1QaData_20170306.csv")
bblid_scanid <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/bblid_scanid_sub.csv")
T1_QA_PNC <- merge(T1_QA, bblid_scanid, by ="scanid")
T1_QA_PNC <- dplyr::select(T1_QA_PNC, -bblid.y)
T1_QA_PNC <- T1_QA_PNC %>% relocate(rbcid) 
T1_QA_PNC <- T1_QA_PNC %>% dplyr::rename(sub=rbcid)
T1_QA_PNC$sub <- paste0("sub-", T1_QA_PNC$sub)
 
# load demographics (updated file from informatics 6/7/2023)
demographics <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/n1601_demographics_go1_20161212.csv")
bblid_scanid <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/bblid_scanid_sub.csv")
demographics <- merge(demographics, bblid_scanid, by ="scanid")
demographics <- demographics %>% relocate(bblid, rbcid)
demographics <- dplyr::rename(demographics, sub = rbcid) %>% mutate(age = ageAtScan1/12)
demographics$sub <- paste0("sub-", demographics$sub)

# include only kids who got scanned 
demographics <- merge(scanned_participants, demographics, by = "sub")
nrow(demographics) # 1537 total with demographics and n-back
range(demographics$age, na.rm=TRUE) # age 8-23
 
```
 
  
## 2) exclude participants with medical conditions affecting brain function and gross neurological abnormalities (healthExcludev2)
```{r medical_exclusion}
PNC_healthExclude <- read.csv("/cbica/projects/network_replication/input/PNC/sample_selection/n1601_health_20170421.csv")
medical_exclusion <- PNC_healthExclude$bblid[c(which(PNC_healthExclude$healthExcludev2==1))] #fyi, bblid in PNC_healthExclude corresponds to rbcid in demographics 

demographics_medExclusion <- demographics[-c(which(demographics$rbcid %in% medical_exclusion)),] 
 
collated_PNC.CPAC_medExclusion <- collated_PNC.CPAC[-c(which(gsub("sub-", "", collated_PNC.CPAC$sub) %in% medical_exclusion)),]

length(unique(collated_PNC.CPAC_medExclusion$sub)) # N=1393
 
```


## 3) include passing T1 QC  
## 4) include meanFD < 0.3
```{r meanFD, cache=TRUE}

# T1 exclusion

collated_PNC.CPAC_T1Exclusion <- merge(collated_PNC.CPAC_medExclusion, dplyr::select(T1_QA_PNC, sub, t1Exclude), by = "sub")
collated_PNC.CPAC_T1Exclusion <- collated_PNC.CPAC_T1Exclusion[-c(which(collated_PNC.CPAC_T1Exclusion$t1Exclude==1)),]

length(unique(collated_PNC.CPAC_T1Exclusion$sub)) # N=1353 after excluding participants with failed T1
 
collated_PNC.CPAC_headMotion <- collated_PNC.CPAC_T1Exclusion[c(which(collated_PNC.CPAC_T1Exclusion$meanFD < 0.3)),]
length(unique(collated_PNC.CPAC_headMotion$sub)) # N=1238 after excluding meanFD >= 0.3  
 
 
write.csv(collated_PNC.CPAC_headMotion, "/cbica/projects/network_replication/revisions/input/PNC/CPAC_sample_selection/CPAC_nonGSR_collated_PNC_headMotion.csv", row.names=F)
```



## 5) include scans with at least 7 minutes of scan time
```{r scan_time}
# Calculate scan time for each subject 
collated_PNC.CPAC_headMotion <- read.csv("/cbica/projects/network_replication/revisions/input/PNC/CPAC_sample_selection/CPAC_nonGSR_collated_PNC_headMotion.csv")
# load cubids summary and files csv
CUBIDS_summary <- read.csv("/cbica/projects/network_replication/input/PNC/CUBIDS_csvs/PNC_FINAL_summary.csv")
CUBIDS_summary <- CUBIDS_summary[,-c(1:4)]
CUBIDS_files <- read.csv("/cbica/projects/network_replication/input/PNC/CUBIDS_csvs/PNC_FINAL_files.csv")

# filter only for fMRI
CUBIDS_files_func <- CUBIDS_files %>% filter(str_detect(FilePath, "func"))
 
# make columns for subject ID, site, task 
CUBIDS_files_func <- CUBIDS_files_func %>% 
  mutate(sub=str_extract(FilePath, "sub-[0-9]*")) %>% 
  mutate(task =ifelse(str_detect(FilePath, "rest"),  # if the task is a rest scan, the filename looks like task-rest_acq-*
                      gsub("acq-", "", gsub("task-", "", str_extract(FilePath, "task-rest_acq-[a-z0-9]*"))), 
                      gsub("task-", "", str_extract(FilePath, "task-[a-z0-9]*"))))
 
CUBIDS_files_func <- CUBIDS_files_func %>% 
  mutate(sub_task=paste0(sub, "_", task))
collated_PNC.CPAC_headMotion <- collated_PNC.CPAC_headMotion %>% mutate(task = ifelse(str_detect(Scan, "rest"), gsub("acq-", "", gsub("VARIANT(.)*", "",Scan)), str_extract(Scan, "[:alnum:]*"))) %>%
  mutate(sub_task= ifelse(str_detect(task, "rest"), paste0(sub, "_", task), paste0(sub, "_", task)))
  
fMRIinclude_CUBIDS <- merge(collated_PNC.CPAC_headMotion, dplyr::select(CUBIDS_files_func, NumVolumes, RepetitionTime, sub_task), by ="sub_task")
  
fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS %>% mutate(task_abbrev = str_extract(task, "[:alnum:]*"))
# sort dataframe by subject and calculate scan time
fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS %>% arrange(sub) %>% mutate(ScanTimeMinutes = NumVolumes*RepetitionTime/60) 
fMRIinclude_CUBIDS_ScanTime <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 
 
range(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 3.60 to 33.25
median(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 28.25 min
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
getmode(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) #28.25 min
   
# exclude participants with less than 7 min of scan time
subject_scanTime_exclude <- fMRIinclude_CUBIDS_ScanTime$sub[c(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total < 7))] 
  
fMRIinclude_CUBIDS<- fMRIinclude_CUBIDS[-c(which(fMRIinclude_CUBIDS$sub %in% subject_scanTime_exclude)),]  

length(unique(fMRIinclude_CUBIDS$sub)) # N=1182
 


fMRIinclude_CUBIDS_ScanTime <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 
max(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 33.25 minutes 
range(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 8.35 33.25
median(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 28.25

fMRIinclude_CUBIDS_NumVols <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(NumVols_Total = sum(NumVolumes))
max(fMRIinclude_CUBIDS_NumVols$NumVols_Total) # 665 volumes

saveRDS(fMRIinclude_CUBIDS, "/cbica/projects/network_replication/revisions/input/PNC/CPAC_sample_selection/CPAC_nonGSR_fMRIinclude_CUBIDS_20231130.RData")
 
```
 

# Final Demographics Dataframe
```{r final_participant_list}

fMRIinclude_CUBIDS <- readRDS("/cbica/projects/network_replication/revisions/input/PNC/CPAC_sample_selection/CPAC_nonGSR_fMRIinclude_CUBIDS_20231130.RData")
final_participants <- data.frame(unique(fMRIinclude_CUBIDS$sub))
names(final_participants) <- "sub"  
final_demographics <- merge(demographics, final_participants, by = "sub")
 
## include average meanFD across the acquisitions included in calculating connectivity matrix 
# for each subject, take average meanFD
subject <- c()
ses <- c()
avg_meanFD_vec <- c()
for(i in c(1:length(unique(fMRIinclude_CUBIDS$sub)))){
  indices <- which(fMRIinclude_CUBIDS$sub == unique(fMRIinclude_CUBIDS$sub)[i])
  avg_meanFD <- mean(as.numeric(fMRIinclude_CUBIDS$meanFD[indices]))
  subject <- append(subject, unique(fMRIinclude_CUBIDS$sub)[i])
  avg_meanFD_vec <- append(avg_meanFD_vec, avg_meanFD)
}  

PNC_avgMotion <- data.frame(cbind(subject, avg_meanFD_vec))
names(PNC_avgMotion) <- c("sub", "meanFD_avgSes")
PNC_avgMotion$meanFD_avgSes <- as.numeric(PNC_avgMotion$meanFD_avgSes)
final_dem_df <- merge(final_demographics, PNC_avgMotion, by="sub")
   

length(which(final_dem_df$sex=="2")) # 628 females 

unique(final_dem_df$race)
#"1= White; 
# 2= Black/African American; 
# 3= US_India/Alaska Native;
# 4=Asian; 
# 5=More Than One Race; 
# 6=Hawaiian/Pacific;  
 
length(which(final_dem_df$race==6))/nrow(final_dem_df)
# white = 551 - 45.7%
# black = 513 - 42.5%
# other (native american + hawaiian pi) = 4 + 1 - 0.41%
# asian = 11 - 0.9%
# missing = 0
# mixed = 127 - 10.5%

mean(final_dem_df$age) # mean = 15.4
sd(final_dem_df$age) # SD = 3.5

write.csv(final_dem_df, "/cbica/projects/network_replication/revisions/input/PNC/CPAC_sample_selection/CPAC_nonGSR_PNC_demographics_finalsample_20231130.csv", row.names=F)
 
```

 
 
 
  

 
