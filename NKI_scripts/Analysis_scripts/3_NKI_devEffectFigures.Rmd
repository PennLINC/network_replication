---
title: "NKI Figures"
author: "Audrey Luo"
output: html_document
---
 
Makes Figures 3B, 3F, 3J, 3N, 4B, 5B, 6B, 6F
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 

library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggsegExtra)
library(ggsegSchaefer)
library(ggsegGlasser)
library(ggsegGordon)
library(ggcorrplot)
library(viridis)
library(scales)
library(stringr)
library(tidyr)
library(ggpubr)
library(purrr)
library(pammtools) 

source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/DevEffect_Figures.R")
source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/netrep_spinTests.R")
source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/GAM_functions.R")
source("/cbica/projects/network_replication/software/perm.sphere.p.R")

atlases_GBC <- c("glasser", "gordon", "schaefer200", "schaefer400") # note that GBC (global brain connectivity) == FC strength
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17") # For BNC and WNC 
dataset <- "NKI"
  
```

 

## load parcellated S-A axis
```{r load_SAaxis, include=FALSE}

glasser_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/glasser_SAaxis.csv")
gordon_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/gordon_SAaxis.csv")

schaefer200x7_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x7_SAaxis.csv")
schaefer200x7_SAaxis$label <- gsub("7Network", "Network", schaefer200x7_SAaxis$label) 

schaefer200x17_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x17_SAaxis.csv")
schaefer200x17_SAaxis$label <- gsub("17Network", "Network", schaefer200x17_SAaxis$label) 
schaefer200_SAaxis <- schaefer200x17_SAaxis 

schaefer400x7_SAaxis  <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer400x7_SAaxis.csv")
schaefer400x7_SAaxis$label <-  gsub("7Networks", "Networks", schaefer400x7_SAaxis$label)

schaefer400x17_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer400x17_SAaxis.csv")
schaefer400x17_SAaxis$label <- gsub("17Network", "Network", schaefer400x17_SAaxis$label)
schaefer400_SAaxis <- schaefer400x17_SAaxis

 
```


## **Figure 3B**  

### DevTraj Centered
#### load gam.smooths
```{r load.gam.smooths, include=FALSE, cache=TRUE}
 
# GBC - makes gam.smooths.glasser.GBC, gam.smooths.gordon.GBC, gam.smooths.schaefer200.GBC, gam.smooths.schaefer400.GBC  
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.smooths.", atlases_GBC[i], ".", metric)
  assign(df_name, make_gam.smooths(metric, atlases_GBC[i], dataset))
  print(df_name)
} 
 
```

#### make devTraj df
- makes df for trajectories. Can load the output in following chunk.
```{r make_devTraj_centered, include=FALSE, eval=FALSE}
 
# GBC - makes devTraj.centered.glasser.GBC, devTraj.centered.gordon.GBC, devTraj.centered.schaefer200.GBC, devTraj.schaefer400.GBC    
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("devTraj.centered.", atlases_GBC[i], ".", metric, "_df")
  assign(df_name, make_gam.smooths_centered(metric, atlases_GBC[i], dataset))  
  print(df_name)
} 
 
    
  
```
#### load devTraj df
```{r load_devTraj_centered.dfs, include=FALSE, cache=TRUE}

# loads devTraj.centered.glasser.GBC_df, devTraj.centered.gordon.GBC_df, devTraj.centered.schaefer200.GBC_df, devTraj.centered.schaefer400.GBC_df
metric="GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("devTraj.centered.", atlases_GBC[i], ".", metric, "_df")
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered.csv", dataset, metric, atlases_GBC[i])))
  print(df_name)
}
 
```

#### make dev traj figures
```{r make_Dev.Trajectory.Figures, include=FALSE}
#GBC
devTraj.centered.GBC <- lapply(atlases_GBC, make_smooths_fig_centered, "GBC")
names(devTraj.centered.GBC) <- atlases_GBC
```

#### Plot Figure 3B: GBC Dev Trajectory  
```{r Fig7, fig.height= 10, fig.width= 12, warning=FALSE}

(devTraj.centered.GBC_fig <- plot_grid(devTraj.centered.GBC$glasser, devTraj.centered.GBC$gordon, devTraj.centered.GBC$schaefer200, devTraj.centered.GBC$schaefer400, labels = "AUTO"))

devTraj.centered.GBC$schaefer200
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig3/Fig3_GBCDevTraj_NKI.pdf", dpi=1200, width = 5, height = 5)
```
 

## **Figure 3F, J, N**
#### Make representative parcels
```{r make_representative_parcels, warning=FALSE, cache=TRUE}
  
# subsets gam.smooths (long_df) to extract specific parcels and creates a new dataframe (to make dev trajectory figures)
# @param SA_parcelnames, A character string indicating which parcels to plot (i.e "SM", "default", etc.; may be different for different atlases)
smooths_repParcels <- function(SA_ranks, atlas_name, metric){
  gam.smooths.centered <- get(paste0("devTraj.centered.", atlas_name, ".", metric, "_df"))
  gam.smooths.ordered <- gam.smooths.centered[order(gam.smooths.centered$SA.axis_rank),]
  parcel_rows <- which(gam.smooths.ordered$SA.axis_rank %in% SA_ranks) # trying to extract all rows that match SA_ranks
  repParcels <- gam.smooths.ordered[parcel_rows,]
  return(repParcels)
}
 
# For schaefer200x7
## extract row numbers for parcels of interest (somatomotor, default, visual, salient/ventral attention, and frontal parietal networks)
## note that all 7 Network schaefer atlas parcels have been reordered to match 17 network (see schaefer7to17_reordering.Rmd)
## arrange(schaefer200x7_SAaxis, by= SA.axis_rank) 
SM <- which(str_detect(schaefer200x7_SAaxis$label, "SomMot")) # mean SA rank = 40
SM_ranks <- schaefer200x7_SAaxis$SA.axis_rank[SM]  
default <- which(str_detect(schaefer200x7_SAaxis$label, "Default")) # mean SA rank = 155
default_ranks <- schaefer200x7_SAaxis$SA.axis_rank[default]  
attention <- which(str_detect(schaefer200x7_SAaxis$label, "SalVentAttn")) # mean SA rank = 113
attention_ranks <- schaefer200x7_SAaxis$SA.axis_rank[attention]  

schaefer200x7_parcelRanks <- list(SM_ranks, default_ranks, attention_ranks)
repParcels_schaefer200x7 <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, "schaefer200", "GBC")  
names(repParcels_schaefer200x7) <- c("SomMot", "default", "attention")


```
 

```{r FigRepresentativeParcels_schaefer200x7, fig.height= 8, fig.width= 12, warning=FALSE, cache=TRUE}

## set up dataframe for making figures
SAaxis_repParcels_schaefer200x7 <- schaefer200x7_SAaxis
SAaxis_repParcels_schaefer200x7$SA.axis_rank <- as.numeric(SAaxis_repParcels_schaefer200x7$SA.axis_rank)
names(SAaxis_repParcels_schaefer200x7)[3] <- "region"
schaefer200x7_SAaxis_fig.df <- SAaxis_repParcels_schaefer200x7 %>% mutate(SomMot = ifelse(SA.axis_rank %in% SM_ranks, 1, 0)) %>% 
  mutate(default = ifelse(SA.axis_rank %in% default_ranks, 1, 0))  %>%  
  mutate(attention = ifelse(SA.axis_rank %in% attention_ranks, 1, 0)) 
schaefer200x7_SAaxis_fig.df$region <- gsub("Network", "7Network", schaefer200x7_SAaxis_fig.df$region)
 
## somatomotor parcels: average SA rank = 39.5 
schaefer200x7_SomMot <- make_repParcel.fig("GBC", "schaefer200x7", "SomMot", "#24A6A8FF") 

## default parcels: average SA rank = 155
schaefer200x7_default <- make_repParcel.fig("GBC", "schaefer200x7", "default", "#C73000FF") 

## attention network parcels: average SA rank = 113  
schaefer200x7_attention <- make_repParcel.fig("GBC", "schaefer200x7", "attention", "#EEAC32FF") 
```
 
 

#### Plot Figure 3F, J, N
```{r FigRepresentativeParcels_schaefer200x7_saveOut, fig.height=4, fig.width=4}
 
schaefer200x7_SomMot
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig3/Fig3_GBCDevTrajRep_SM_NKI.pdf", dpi=1200, width = 5, height = 5)

schaefer200x7_attention 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig3/Fig3_GBCDevTrajRep_Attention_NKI.pdf", dpi=1200, width = 5, height = 5)

schaefer200x7_default 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig3/Fig3_GBCDevTrajRep_Default_NKI.pdf", dpi=1200, width = 5, height = 5)
 
```


## **Figure 4B**

#### load gam results
```{r load_gam, include=FALSE, cache=TRUE}
#GBC - loads gam.GBC.age.glasser, gam.GBC.age.gordon, gam.GBC.age.schaefer200, gam.GBC.age.schaefer400

metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.", metric, ".", "age.", atlases_GBC[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s.csv", dataset, metric, atlases_GBC[i])))
  assign(df_name, get(df_name) %>% select(-label))
  if(str_detect(atlases_GBC[i], "schaefer")) {
  SAaxis <- get(paste0(atlases_GBC[i], "x17_", "SAaxis"))
  } else {
  SAaxis <- get(paste0(atlases_GBC[i], "_", "SAaxis"))
  }
  df_to.label <- get(df_name)
  df_to.label$label <- SAaxis$label
  assign(df_name, df_to.label)
} 
 
 
#BNC - loads gam.BNC.age.gordon, gam.BNC.age.schaefer200x7, gam.BNC.age.schaefer400x7, gam.BNC.age.schaefer200x17, gam.BNC.age.schaefer400x17

metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".", "age.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s.csv", dataset, metric, atlases[i])))
  assign(df_name, get(df_name) %>% select(-label))
  SAaxis <- get(paste0(atlases[i], "_", "SAaxis"))
  df_to.label <- get(df_name)
  df_to.label$label <- SAaxis$label
  assign(df_name, df_to.label)
} 
 

  
#WNC - loads gam.WNC.age.gordon, gam.WNC.age.schaefer200x7, gam.WNC.age.schaefer400x7, gam.WNC.age.schaefer200x17, gam.WNC.age.schaefer400x17
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".", "age.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s.csv", dataset, metric, atlases[i])))
  assign(df_name, get(df_name) %>% select(-label))
  SAaxis <- get(paste0(atlases[i], "_", "SAaxis"))
  df_to.label <- get(df_name)
  df_to.label$label <- SAaxis$label
  assign(df_name, df_to.label)
} 
 
```
 

#### make figure df's - metric.axis_atlas
- makes metric.axis_atlas df's. can load these df's in following chunk.
```{r figure_dfs, include=FALSE, eval=FALSE}
# GBC - makes GBC.axis_glasser, GBC.axis_gordon, GBC.axis_schaefer200, GBC.axis_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0(metric, ".axis_", atlases_GBC[i])
  assign(df_name, combineGAMdfs(metric, atlases_GBC[i]))
  print(df_name)
} 

  
# BNC - makes BNC.axis_gordon, BNC.axis_schaefer200x7, BNC.axis_schaefer200x17, BNC.axis_schaefer400x7, BNC.axis_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  assign(df_name, combineGAMdfs(metric, atlases[i]))
  print(df_name)
} 

 
# WNC - makes WNC.axis_gordon, WNC.axis_schaefer200x7, WNC.axis_schaefer200x17, WNC.axis_schaefer400x7, WNC.axis_schaefer400x17 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  assign(df_name, combineGAMdfs(metric, atlases[i]))
  print(df_name)
} 
 

#add column for FDR correction
# GBC
GBC.axis_glasser <- sig_parcels(GBC.axis_glasser)   
GBC.axis_gordon <- sig_parcels(GBC.axis_gordon) 
GBC.axis_schaefer200 <- sig_parcels(GBC.axis_schaefer200) 
GBC.axis_schaefer400 <- sig_parcels(GBC.axis_schaefer400) 

# BNC
BNC.axis_gordon <- sig_parcels(BNC.axis_gordon)
BNC.axis_schaefer200x7 <- sig_parcels(BNC.axis_schaefer200x7)
BNC.axis_schaefer200x17 <- sig_parcels(BNC.axis_schaefer200x17)
BNC.axis_schaefer400x7 <- sig_parcels(BNC.axis_schaefer400x7)
BNC.axis_schaefer400x17 <- sig_parcels(BNC.axis_schaefer400x17)

# WNC
WNC.axis_gordon <- sig_parcels(WNC.axis_gordon)
WNC.axis_schaefer200x7 <- sig_parcels(WNC.axis_schaefer200x7)
WNC.axis_schaefer200x17 <- sig_parcels(WNC.axis_schaefer200x17)
WNC.axis_schaefer400x7 <- sig_parcels(WNC.axis_schaefer400x7)
WNC.axis_schaefer400x17 <- sig_parcels(WNC.axis_schaefer400x17)

# GBC - writes GBC.axis_glasser, GBC.axis_gordon, GBC.axis_schaefer200, GBC.axis_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0(metric, ".axis_", atlases_GBC[i])
  filename <- paste0(df_name)
  write.csv(get(filename), sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, filename))
  print(df_name)
} 

  
# BNC - writes BNC.axis_gordon, BNC.axis_schaefer200x7, BNC.axis_schaefer200x17, BNC.axis_schaefer400x7, BNC.axis_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  filename <- paste0(df_name)
  write.csv(get(filename), sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, filename))
  print(df_name)
} 

 
# WNC - writes WNC.axis_gordon, WNC.axis_schaefer200x7, WNC.axis_schaefer200x17, WNC.axis_schaefer400x7, WNC.axis_schaefer400x17 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  filename <- paste0(df_name)
  write.csv(get(filename), sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, filename))
  print(df_name)
} 
 
```

#### load figure df's - metric.axis_atlas
```{r load_figureDfs, include=FALSE, cache=TRUE}

#GBC - loads GBC.axis_glasser, GBC.axis_gordon, GBC.axis_schaefer200, GBC.axis_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  filename <- paste0(metric, ".axis_", atlases_GBC[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, filename)))
  print(filename)
} 
  
           
#BNC - loads BNC.axis_gordon, BNC.axis_schaefer200x7, BNC.axis_schaefer200x17, BNC.axis_schaefer400x7, BNC.axis_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  filename <- paste0(metric, ".axis_", atlases[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, filename)))
  print(filename)
} 
  
  
#WNC - loads WNC.axis_gordon, WNC.axis_schaefer200x7, WNC.axis_schaefer200x17, WNC.axis_schaefer400x7, WNC.axis_schaefer400x17
metric = "WNC"
for(i in c(1:length(atlases))){
  filename <- paste0(metric, ".axis_", atlases[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, filename)))
  print(filename)
} 

```

#### Spin-based spatial permutation tests - Prep dataframes
```{r prep_pspindfs, include=FALSE, cache=TRUE}
#Load Spin Test Parcel Rotation Matrix
all_atlases <- c("glasser", "gordon","schaefer200x7","schaefer200x17", "schaefer400x7","schaefer400x17")

# parcel rotation matrices: perm.id.full_glasser, perm.id.full_gordon, perm.id.full_schaefer200x7, perm.id.full_schaefer200x17, perm.id.full_schaefer400x7, perm.id.full_schaefer400x17 
for(i in c(1:length(all_atlases))){
  df_name <- paste0("perm.id.full", "_", all_atlases[i])
  assign(df_name, readRDS(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/%1$s.coords_sphericalrotations_N10k.rds", all_atlases[i]))) 
  print(paste(df_name, "made"))
} 

# GBC - making df.dev.spin_GBC_glasser, df.dev.spin_GBC_gordon, df.dev.spin_GBC_schaefer200, df.dev.spin_GBC_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("df.dev.spin_", metric, "_", atlases_GBC[i])
  assign(df_name, prepDfSpin(atlases_GBC[i], metric))
  print(paste(df_name, "made"))
} 

# BNC - making df.dev.spin_BNC_gordon, df.dev.spin_BNC_schaefer200x7, df.dev.spin_BNC_schaefer200x17, df.dev.spin_BNC_schaefer400x7, df.dev.spin_BNC_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("df.dev.spin_", metric, "_", atlases[i])
  assign(df_name, prepDfSpin(atlases[i], metric))
  print(paste(df_name, "made"))
} 

# WNC - making df.dev.spin_WNC_gordon, df.dev.spin_WNC_schaefer200x7, df.dev.spin_WNC_schaefer200x17, df.dev.spin_WNC_schaefer400x7, df.dev.spin_WNC_schaefer400x17 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("df.dev.spin_", metric, "_", atlases[i])
  assign(df_name, prepDfSpin(atlases[i], metric))
  print(paste(df_name, "made"))
} 
```
 
#### Correlations and Spin-based spatial permutation tests
- executes spin test and saves out p-spin values. Can load values in the next chunk.
```{r cor_test, include=FALSE, eval=FALSE}
# GBC - making corr.GBC_glasser, corr.GBC_gordon, corr.GBC_schaefer200, corr.GBC_schaefer400  
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("corr.", metric, "_", atlases_GBC[i])
  axis <- get(paste0(metric, ".axis_", atlases_GBC[i]))
  assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
  print(paste(df_name, "made"))
} 
 

# BNC - making corr.BNC_gordon, corr.BNC_schaefer200x7, corr.BNC_schaefer400x7, corr.BNC_schaefer200x17, corr.BNC_schaefer400x17  
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("corr.", metric, "_", atlases[i])
  axis <- get(paste0(metric, ".axis_", atlases[i]))
  assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
  print(paste(df_name, "made"))
} 

# WNC - making corr.WNC_gordon, corr.WNC_schaefer200x7, corr.WNC_schaefer400x7, corr.WNC_schaefer200x17, corr.WNC_schaefer400x17  
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("corr.", metric, "_", atlases[i])
  axis <- get(paste0(metric, ".axis_", atlases[i]))
  assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
  print(paste(df_name, "made"))
} 

spearman_rho <- data.frame(cbind(corr.GBC_glasser, corr.GBC_gordon, corr.GBC_schaefer200, corr.GBC_schaefer400, corr.BNC_gordon, corr.BNC_schaefer200x7, corr.BNC_schaefer400x7, corr.BNC_schaefer200x17, corr.BNC_schaefer400x17, corr.WNC_gordon, corr.WNC_schaefer200x7, corr.WNC_schaefer400x7, corr.WNC_schaefer200x17, corr.WNC_schaefer400x17))
write.csv(spearman_rho, "/cbica/projects/network_replication/output/NKI/spearman_rho.csv")

# spin permutation tests:
metric = "GBC"
p_spin_GBC <- c()
for(i in c(1:length(atlases_GBC))){
  df.dev.spin <- get(paste0("df.dev.spin_", metric, "_", atlases_GBC[i]))
  if(str_detect(atlases_GBC[i], "schaefer")) {
  perm.id.full <- get(paste0("perm.id.full_", atlases_GBC[i], "x17"))
  } else {
  perm.id.full <- get(paste0("perm.id.full_", atlases_GBC[i]))
  }
  p_spin_atlas <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full, corr.type='spearman')
  p_spin_GBC <- append(p_spin_GBC, p_spin_atlas)
  print(paste(atlases_GBC[i], p_spin_atlas))
} 
p_spin_GBC <- data.frame(cbind(atlases_GBC, p_spin_GBC))

 

metric = "BNC"
p_spin_BNC <- c()
for(i in c(1:length(atlases))){
  df.dev.spin <- get(paste0("df.dev.spin_", metric, "_", atlases[i]))
  perm.id.full <- get(paste0("perm.id.full_", atlases[i]))
  p_spin_atlas <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full, corr.type='spearman')
  p_spin_BNC <- append(p_spin_BNC, p_spin_atlas)
  print(paste(atlases[i], p_spin_atlas))
} 
p_spin_BNC <- data.frame(cbind(atlases, p_spin_BNC))

metric = "WNC"
p_spin_WNC <- c()
for(i in c(1:length(atlases))){
  df.dev.spin <- get(paste0("df.dev.spin_", metric, "_", atlases[i]))
  perm.id.full <- get(paste0("perm.id.full_", atlases[i]))
  p_spin_atlas <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full, corr.type='spearman')
  p_spin_WNC <- append(p_spin_WNC, p_spin_atlas)
  print(paste(atlases[i], p_spin_atlas))
} 
p_spin_WNC <- data.frame(cbind(atlases, p_spin_WNC))
 
p_spin_WNC$p_spin_WNC = as.numeric(p_spin_WNC$p_spin_WNC)
p_spin_GBC$p_spin_GBC = as.numeric(p_spin_GBC$p_spin_GBC)
names(p_spin_GBC)[1] <- "atlases"
p_spin_BNC$p_spin_BNC = as.numeric(p_spin_BNC$p_spin_BNC)

saveRDS(list(p_spin_GBC, p_spin_BNC, p_spin_WNC), "/cbica/projects/network_replication/output/NKI/pspin_vals.RData")
```


### Making figure labels with r and p_spin: 
this section required manual input since expression() doesn't take variables :( 
```{r make_figures_pspin, include=FALSE}
spearman_rho <- read.csv("/cbica/projects/network_replication/output/NKI/spearman_rho.csv")
pspin_vals <- readRDS("/cbica/projects/network_replication/output/NKI/pspin_vals.RData")
 

#GBC 
r_text_GBC.glasser <- expression(paste(italic("r"), " = -0.56, ",  , italic(p[spin]), "< 0.0001")) 
(GBC_glasser <- gam_figure_p.spin(GBC.axis_glasser, "GBC", "Glasser", r_text_GBC.glasser,
                                  x_pos= 270, y_pos=0.12, ylim_lower=-0.065, ylim_upper=0.15))

r_text_GBC.gordon <- expression(paste(italic("r"), "= -0.59, ",  , italic(p[spin]), "< 0.0001"))
(GBC_gordon <- gam_figure_p.spin(GBC.axis_gordon, "GBC", "Gordon", r_text_GBC.gordon, 
                                 x_pos= 270, y_pos=0.12, ylim_lower=-0.065, ylim_upper=0.15))

r_text_GBC.schaefer200 <- expression(paste(italic("r"), "= -0.56, ",  , italic(p[spin]), "< 0.001"))
(GBC_schaefer200 <- gam_figure_p.spin(GBC.axis_schaefer200, "GBC", "Schaefer200", r_text_GBC.schaefer200, 
                                      x_pos= 150, y_pos=0.12, ylim_lower=-0.065, ylim_upper=0.15))

r_text_GBC.schaefer400 <- expression(paste(italic("r"), "= -0.54, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer400 <- gam_figure_p.spin(GBC.axis_schaefer400, "GBC", "Schaefer400", r_text_GBC.schaefer400, 
                                      x_pos= 260, y_pos=0.12, ylim_lower=-0.065, ylim_upper=0.15))
 
#BNC
r_text_BNC.gordon <- expression(paste(italic("r"), "= -0.58, ",  , italic(p[spin]), "< 0.001"))
(BNC_gordon <- gam_figure_p.spin(BNC.axis_gordon, "BNC", "Gordon", r_text_BNC.gordon, 
                                 x_pos= 270, y_pos=0.12, ylim_lower=-0.07, ylim_upper=0.10))

r_text_BNC.schaefer200x7 <- expression(paste(italic("r"), "= -0.50, ",  , italic(p[spin]), "< 0.01"))
(BNC_schaefer200x7 <- gam_figure_p.spin(BNC.axis_schaefer200x7, "BNC", "schaefer200x7", r_text_BNC.schaefer200x7, 
                                        x_pos= 150, y_pos=0.1, ylim_lower=-0.07, ylim_upper=0.10))

r_text_BNC.schaefer200x17 <- expression(paste(italic("r"), "= -0.56, ",  , italic(p[spin]), "< 0.001"))
(BNC_schaefer200x17 <- gam_figure_p.spin(BNC.axis_schaefer200x17, "BNC", "schaefer200x17", r_text_BNC.schaefer200x17, 
                                         x_pos= 160, y_pos=0.1, ylim_lower=-0.07, ylim_upper=0.10))

r_text_BNC.schaefer400x7 <- expression(paste(italic("r"), "= -0.49, ",  , italic(p[spin]), "< 0.0001"))
(BNC_schaefer400x7 <- gam_figure_p.spin(BNC.axis_schaefer400x7, "BNC", "schaefer400x7", r_text_BNC.schaefer400x7, 
                                        x_pos= 260, y_pos=0.1, ylim_lower=-0.07, ylim_upper=0.10))

r_text_BNC.schaefer400x17 <- expression(paste(italic("r"), "= -0.55, ",  , italic(p[spin]), "< 0.0001"))
(BNC_schaefer400x17 <- gam_figure_p.spin(BNC.axis_schaefer400x17, "BNC", "schaefer400x17", r_text_BNC.schaefer400x17, 
                                         x_pos= 260, y_pos=0.1, ylim_lower=-0.07, ylim_upper=0.10))
 

#WNC
r_text_WNC.gordon <- expression(paste(italic("r"), "= -0.30, ",  , italic(p[spin]), "= N.S"))
(WNC_gordon <- gam_figure_p.spin(WNC.axis_gordon, "WNC", "Gordon", r_text_WNC.gordon, 
                                        x_pos= 270, y_pos=0.12, ylim_lower=-0.055, ylim_upper= 0.17))

r_text_WNC.schaefer200x7 <- expression(paste(italic("r"), "= -0.31, ",  , italic(p[spin]), "< 0.05"))
(WNC_schaefer200x7 <- gam_figure_p.spin(WNC.axis_schaefer200x7, "WNC", "schaefer200x7", r_text_WNC.schaefer200x7, 
                                        x_pos= 150, y_pos=0.12, ylim_lower=-0.055, ylim_upper= 0.17))

r_text_WNC.schaefer200x17 <- expression(paste(italic("r"), "= -0.14, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer200x17 <- gam_figure_p.spin(WNC.axis_schaefer200x17, "WNC", "schaefer200x17", r_text_WNC.schaefer200x17, 
                                         x_pos= 160, y_pos=0.1, ylim_lower=-0.055, ylim_upper= 0.17))

r_text_WNC.schaefer400x7 <- expression(paste(italic("r"), "= -0.28, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer400x7 <- gam_figure_p.spin(WNC.axis_schaefer400x7, "WNC", "schaefer400x7", r_text_WNC.schaefer400x7, 
                                        x_pos= 260, y_pos=0.1, ylim_lower=-0.055, ylim_upper= 0.17))

r_text_WNC.schaefer400x17 <- expression(paste(italic("r"), "= -0.17, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer400x17 <- gam_figure_p.spin(WNC.axis_schaefer400x17, "WNC", "schaefer400x17", r_text_WNC.schaefer400x17, 
                                         x_pos= 260, y_pos=0.1, ylim_lower=-0.055, ylim_upper= 0.17))
 
 
```
 
#### Plot Figure 4B: GBC DevEffect 
```{r Fig1, fig.height= 8, fig.width= 10, warning=FALSE, cache=TRUE}

plot_grid(GBC_glasser, GBC_gordon, GBC_schaefer200, GBC_schaefer400, labels = "AUTO")

GBC_schaefer200  
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig4/Fig4_GBCAgeEffect_NKI.pdf", dpi=300, width = 5, height = 5)

```



## **Figure 5B**
#### load GAM fitted values
```{r load_gam.fitted, include=FALSE, cache=TRUE}
gam.GBC.fitted.schaefer200 <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, "GBC", "gam.GBC.fitted.schaefer200"))
```

#### Posterior fitted GBC - sensorimotor-association axis correlations, N=10,000
- derives the posterior fitted GBC correlations to SA axis. Can load output in following chunk. 
```{r load.edit_fits.SAaxis.posteriorcorrs, include=FALSE, eval=FALSE}

# load posterior derivative correlations to SA-axis (fits.SAaxis.posteriorcorrs_metric$atlas)
fits.SAaxis.posteriorcorrs_GBC <- readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/SAaxis_posteriorfits_correlation_byage_%3$s.RData", dataset, "GBC", "schaefer200"))
colnames(fits.SAaxis.posteriorcorrs_GBC) <- sprintf("draw%s",seq(from = 1, to = ncol(fits.SAaxis.posteriorcorrs_GBC)))
fits.SAaxis.posteriorcorrs_GBC <- cbind(fits.SAaxis.posteriorcorrs_GBC, (gam.GBC.fitted.schaefer200 %>% group_by(age) %>% group_keys()))
 
    
saveRDS(fits.SAaxis.posteriorcorrs_GBC, "/cbica/projects/network_replication/output/NKI/GBC/GAM/fits.SAaxis.posteriorcorrs_GBC.RData")
 
```

#### load posterior fits
```{r load_fits.SAaxis.posteriorcorrs, include=FALSE, cache=TRUE}
fits.SAaxis.posteriorcorrs_GBC <- readRDS("/cbica/projects/network_replication/output/NKI/GBC/GAM/fits.SAaxis.posteriorcorrs_GBC.RData") 
```
 

#### Sensorimotor-association axis correlation value at each age: posterior median values + 95% credible interval
- calculates credible intervals. Can load results in following chunk. 
```{r cor.credible.intervals, include=FALSE, eval=FALSE}

fits.SAaxis.posteriorcorrs <- fits.SAaxis.posteriorcorrs_GBC %>% select(contains("draw"))
fits.SAaxis.mediancorr <- apply(fits.SAaxis.posteriorcorrs, 1, function(x){median(x)})
cor.credible.intervals <- apply(fits.SAaxis.posteriorcorrs, 1, function(x){quantile(x, probs = c(0.025, 0.975))}) #compute the credible interval for the correlation value at each age based on all draws 
cor.credible.intervals <- as.data.frame(t(cor.credible.intervals))
  
cor.credible.intervals <- cbind(cor.credible.intervals, (gam.GBC.fitted.schaefer200 %>% group_by(age) %>% group_keys()))
cor.credible.intervals <- cbind(cor.credible.intervals, fits.SAaxis.mediancorr)
colnames(cor.credible.intervals) <- c("lower","upper","age","SA.correlation")
    

saveRDS(cor.credible.intervals, "/cbica/projects/network_replication/output/NKI/GBC/GAM/cor.credible.intervals_GBC_fitted.RData")
  
```

 
```{r load_cor.credible.intervals, include=FALSE}
cor.credible.intervals <- readRDS("/cbica/projects/network_replication/output/NKI/GBC/GAM/cor.credible.intervals_GBC_fitted.RData")
```

#### Plot Figure 5B
```{r plot_cred.intervals, include=FALSE, cache=TRUE}
SA_metric_corr_GBC <- ggplot(cor.credible.intervals, aes(x = age, y = abs(SA.correlation), ymin = abs(lower), ymax = abs(upper))) + 
    geom_line(size = .5) +
    geom_ribbon(alpha = .2, fill = c("grey60")) + geom_hline(yintercept=0.6,linetype=2) + 
    labs(x="Age", y="Spatial Alignment of GBC to S-A Axis (r)") + 
    theme_classic() + ylim(0, 0.62) + 
    theme(axis.text = element_text(size = 24, 
                                   color = c("black")), 
          axis.title = element_text(size = 24, color = c("black")), 
          axis.line = element_line(size =.22), 
          axis.ticks = element_line(size = .22)) +
    scale_x_continuous(breaks=c(4, 6, 8, 10, 12, 14, 16, 18, 20, 22), expand = c(0, .1)) 
 
SA_metric_corr_GBC 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig5/Fig5_NKI_GBC_ageFittedValues.pdf", dpi=1200, width = 5, height = 5)
```

 
 
## **Figure 6B**
#### Plot Figure 6B: BNC DevEffect  
```{r Fig2, fig.height= 8, fig.width= 16, warning=FALSE, cache=TRUE}
BNC_schaefer200x7 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig6/Fig6_BNCAgeEffect_NKI.pdf", BNC_schaefer200x7, dpi=300,base_width = 6, base_height = 5)
```

## **Figure 6F**
#### Plot Figure 6F: WNC DevEffect  
```{r Fig3, fig.height= 8, fig.width= 16, warning=FALSE, cache=TRUE}
WNC_schaefer200x7 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig6/Fig6_WNCAgeEffect_NKI.pdf", dpi=300, width = 6, height = 5)
```

