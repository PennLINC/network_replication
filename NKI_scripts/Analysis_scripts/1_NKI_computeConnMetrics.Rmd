---
title: "NKI Compute Functional Connectivity Metrics"
author: "Audrey Luo"
output: html_document
---


```{r setup, include=FALSE}

library(dplyr)
source("/cbica/projects/network_replication/adapted_Rscripts/computeConnectivityMetrics.R")

knitr::opts_chunk$set(include = FALSE, eval = TRUE, echo = FALSE, warning = FALSE, message = FALSE) 
```


```{r loadParticipants}
# load participants
 
demographics <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_demographics_finalsample_20221219.csv")
participants <- demographics$subject 

 
```



```{r computeGBC}
# make output dfs: 
## GBC.subxparcel.matrix.glasser, GBC.subxparcel.matrix.gordon, GBC.subxparcel.matrix.schaefer200, GBC.subxparcel.matrix.schaefer400
atlases <- c("glasser", "gordon", "schaefer200", "schaefer400")
metric = "GBC"

for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".subxparcel.matrix.", atlases[i])
  assign(df_name, make_output_dfs(participants, atlases[i]))
}
  
 
# compute GBC
for(sub in c(1:length(participants))){
  for(i in c(1:length(atlases))){
    subjectID=as.character(participants[sub])
    NKIid.data <- computeGBC(subjectID, atlases[i], "NKI")
    dataname <- sprintf("%s.%s.%s", metric, "subxparcel.matrix", atlases[i]) 
    df_toUpdate <- get(dataname)
    df_toUpdate[sub,] <- cbind(subjectID, t(NKIid.data)) #update the name of the df every iteration to GBC.subxparcel.matrix.[atlas]
    assign(dataname, df_toUpdate)  
    print(paste(sub, "/", length(participants), "-", subjectID, atlases[i]))
  }
}
 
write.csv(GBC.subxparcel.matrix.glasser, "/cbica/projects/network_replication/output/NKI/GBC/GBC_subxparcel_matrix_glasser.csv", row.names=F, quote=F)
write.csv(GBC.subxparcel.matrix.gordon, "/cbica/projects/network_replication/output/NKI/GBC/GBC_subxparcel_matrix_gordon.csv", row.names=F, quote=F)
write.csv(GBC.subxparcel.matrix.schaefer200, "/cbica/projects/network_replication/output/NKI/GBC/GBC_subxparcel_matrix_schaefer200.csv", row.names=F, quote=F)
write.csv(GBC.subxparcel.matrix.schaefer400, "/cbica/projects/network_replication/output/NKI/GBC/GBC_subxparcel_matrix_schaefer400.csv", row.names=F, quote=F)
   
```



```{r computeBNC}
# make output dfs: 
## BNC.subxparcel.matrix.gordon, BNC.subxparcel.matrix.schaefer200x7, BNC.subxparcel.matrix.schaefer400x7
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
metric = "BNC"

for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".subxparcel.matrix.", atlases[i])
  assign(df_name, make_output_dfs(participants, atlases[i]))
}


# compute BNC
for(sub in c(1:length(participants))){
  for(i in c(1:length(atlases))){
    subjectID=as.character(participants[sub])
    print(paste(subjectID, atlases[i], metric, dataset))
    id.data <- computeBNC_WNC(subjectID, atlases[i], metric, dataset)
    
    dataname <- sprintf("%s.%s.%s", metric, "subxparcel.matrix", atlases[i]) 
    df_toUpdate <- get(dataname)
    df_toUpdate[sub,] <- cbind(subjectID, t(id.data)) #update the name of the df every iteration to BNC.subxparcel.matrix.[atlas]
    assign(dataname, df_toUpdate)  
    print(paste(sub, "/", length(participants), "-", subjectID, atlases[i]))
  }
}

write.csv(BNC.subxparcel.matrix.gordon, "/cbica/projects/network_replication/output/NKI/BNC/BNC_subxparcel_matrix_gordon.csv", row.names=F, quote=F)
write.csv(BNC.subxparcel.matrix.schaefer200x7, "/cbica/projects/network_replication/output/NKI/BNC/BNC_subxparcel_matrix_schaefer200x7.csv", row.names=F, quote=F)
write.csv(BNC.subxparcel.matrix.schaefer400x7, "/cbica/projects/network_replication/output/NKI/BNC/BNC_subxparcel_matrix_schaefer400x7.csv", row.names=F, quote=F)
write.csv(BNC.subxparcel.matrix.schaefer200x17, "/cbica/projects/network_replication/output/NKI/BNC/BNC_subxparcel_matrix_schaefer200x17.csv", row.names=F, quote=F)
write.csv(BNC.subxparcel.matrix.schaefer400x17, "/cbica/projects/network_replication/output/NKI/BNC/BNC_subxparcel_matrix_schaefer400x17.csv", row.names=F, quote=F)
 

```
 
 

```{r computeWNC}

# make output dfs: 
## WNC.subxparcel.matrix.gordon, WNC.subxparcel.matrix.schaefer200x7, WNC.subxparcel.matrix.schaefer400x7
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
metric = "WNC"

for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".subxparcel.matrix.", atlases[i])
  assign(df_name, make_output_dfs(participants, atlases[i]))
}


# compute WNC
for(sub in c(1:length(participants))){
  for(i in c(1:length(atlases))){
    subjectID=as.character(participants[sub])
    print(paste(subjectID, atlases[i], metric, dataset))
    id.data <- computeBNC_WNC(subjectID, atlases[i], metric, dataset)
    
    dataname <- sprintf("%s.%s.%s", metric, "subxparcel.matrix", atlases[i]) 
    df_toUpdate <- get(dataname)
    df_toUpdate[sub,] <- cbind(subjectID, t(id.data)) #update the name of the df every iteration to BNC.subxparcel.matrix.[atlas]
    assign(dataname, df_toUpdate)  
    print(paste(sub, "/", length(participants), "-", subjectID, atlases[i]))
  }
}

  
write.csv(WNC.subxparcel.matrix.gordon, "/cbica/projects/network_replication/output/NKI/WNC/WNC_subxparcel_matrix_gordon.csv", row.names=F, quote=F)
write.csv(WNC.subxparcel.matrix.schaefer200x7, "/cbica/projects/network_replication/output/NKI/WNC/WNC_subxparcel_matrix_schaefer200x7.csv", row.names=F, quote=F)
write.csv(WNC.subxparcel.matrix.schaefer400x7, "/cbica/projects/network_replication/output/NKI/WNC/WNC_subxparcel_matrix_schaefer400x7.csv", row.names=F, quote=F)
write.csv(WNC.subxparcel.matrix.schaefer200x17, "/cbica/projects/network_replication/output/NKI/WNC/WNC_subxparcel_matrix_schaefer200x17.csv", row.names=F, quote=F)
write.csv(WNC.subxparcel.matrix.schaefer400x17, "/cbica/projects/network_replication/output/NKI/WNC/WNC_subxparcel_matrix_schaefer400x17.csv", row.names=F, quote=F)
 

```


# Extract edge-level data (parcel-to-parcel connectivity)
```{r edge_level_dfs}

  
# make a dataframe in which rows are subjects, and columns are the names of the edges (parcel1_to_parcel2)
# the entries represent the parcel-by-parcel correlation
 

# gordon (??)
# for each subject, turn the connectivity matrix into a vector
extractEdge.gordon <- lapply(participants, extractParcel2ParcelConn, "gordon", "NKI")
extractEdge.glasser <- lapply(participants, extractParcel2ParcelConn, "glasser", "NKI")
extractEdge.schaefer200x7 <- lapply(participants, extractParcel2ParcelConn, "schaefer200x7", "NKI")
extractEdge.schaefer200x17 <- lapply(participants, extractParcel2ParcelConn, "schaefer200x17", "NKI")
extractEdge.schaefer400x7 <- lapply(participants, extractParcel2ParcelConn, "schaefer400x7", "NKI")
extractEdge.schaefer400x17 <- lapply(participants, extractParcel2ParcelConn, "schaefer400x17", "NKI")

 
# for other atlases -- need to run this next
atlases <- c("glasser", "gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
#atlases <- c("glasser", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
for(i in c(1:length(atlases))){
  extractEdge <- get(paste0("extractEdge.", atlases[i]))
  names(extractEdge) <- participants 
  columns_extractEdge <- bind_rows(extractEdge) # turn list into a dataframe
  subxedge <- as.data.frame(t(columns_extractEdge)) # transpose dataframe
  
  edge <- read.csv(sprintf("/cbica/projects/network_replication/atlases/edge/%1$s_edge.csv", atlases[i]))
  edge <- edge[,2]
  names(subxedge) <- edge # columns = names of edges
  
  subxedge <- subxedge %>% mutate(subject = rownames(subxedge))
  subxedge <- subxedge %>% relocate(subject)
  rownames(subxedge) <- NULL
  
  saveRDS(subxedge, sprintf("/cbica/projects/network_replication/output/NKI/edge/subxedge_%1$s.RData", atlases[i])) 
  print(atlases[i])
} 
 
 
```





