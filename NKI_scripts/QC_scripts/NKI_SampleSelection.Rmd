---
title: "NKI Sample Selection"
author: "Audrey Luo"
date: "2022-12-16"
output: html_document
---

# Sample Selection process
1) original sample: N=1268, ages 6-85, 6226 scans total
2) include ages 6-22: N=424, 2570 scans
3) include passing T1 QC: N=402, 2281 scans. 
  - delete all scans from a given session if fail T1 
4) include meanFD < 0.3: N=386, 1816 scans
5) choose the session that has the most scans surviving the head motion exclusion: N=386, 998 scans
6) include scans with at least 7 minutes of scan time: N=381, 993 scans (final sample),  177 females
Age: mean=14.5, SD=4.4

Race 
-  white = 249 - 65.4%
-  asian = 34 - 8.9%
-  black = 77 - 20.2%
-  other = 10 - 2.6%
-  missing = 11 - 2.9%

Notes:
- mean FD is averaged across the scans in a given session
  

```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(magrittr)
library(reshape)
library(reshape2)
library(MASS)
library(stargazer)
library(ggplot2)
library(ggpubr)
 

```

```{r qc_setup, include=FALSE, eval=FALSE}
# merge xcp and T1 QA ratings into one df

# load collated NKI xcp outputs
collated_NKI.xcp_temp <- read.csv('/cbica/projects/network_replication/input/NKI/sample_selection/NKI_xcp_qc_20221217.csv')  
toDelete <- seq(0, nrow(collated_NKI.xcp_temp), 2)
collated_NKI.xcp_temp <- collated_NKI.xcp_temp[-toDelete,]
 
# add binary column indicating FD >0.3 (exclude)
collated_NKI.xcp_temp <- collated_NKI.xcp_temp %>% mutate(Exclude = ifelse(meanFD>0.3, 1, 0))

# T1 QA 
T1_QA <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/EulerNumber_VisualQC_3sites.csv")
T1_QA$rbc_id <- gsub("sub-", "", T1_QA$rbc_id)
T1_QA$session <- gsub("ses-", "", T1_QA$session)
names(T1_QA)[which(names(T1_QA) == "rbc_id")] <- "sub"
names(T1_QA)[which(names(T1_QA) == "session")] <- "ses"
names(T1_QA)[which(names(T1_QA) == "manual_qc")] <- "t1_qc"
T1_QA_NKI <- T1_QA[which(T1_QA$sub %in% collated_NKI.xcp_temp$sub), ]
collated_NKI.xcp <- merge(collated_NKI.xcp_temp,T1_QA_NKI[, c(1, 2, 9)], by=c("sub", "ses"))
 
#write.csv(collated_NKI.xcp, "/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI_xcpALL_20221217.csv")
```
 

## 1) & 2) Filter for ages 6-22
```{r filter_age, include=FALSE}

collated_NKI.xcp <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI_xcpALL_20221217.csv")
length(unique(collated_NKI.xcp$sub)) #1268 total participants 
nrow(collated_NKI.xcp) #6226 scans total

demographics <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/nki_demographics.csv")
range(demographics$age, na.rm=TRUE) # age range of entire sample: 6-85 years
demographics_filtered <- demographics$sub[c(which(demographics$age >5 & demographics$age <23))]

 
collated_NKI.xcp_ageFiltered <- collated_NKI.xcp[c(which(collated_NKI.xcp$sub %in% demographics_filtered)),]
length(unique(collated_NKI.xcp_ageFiltered$sub)) # N=424, ages 6-22
nrow(collated_NKI.xcp_ageFiltered) # 2570 scans
 
#write.csv(collated_NKI.xcp_ageFiltered, "/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI_xcp_ageFiltered_20221217.csv")
 
```

## 3) include passing T1 QC 
```{r t1_qc, include=FALSE}

# t1_qc variable: 0=exclude based on T1 image quality. If T1 fails for one scan in a session, all scans from a given session will be excluded. 22 participants excluded;  289 scans excluded
t1_exclusion <- collated_NKI.xcp_ageFiltered[c(which(collated_NKI.xcp_ageFiltered$t1_qc==0)), ]
t1_exclusion_sessions <- collated_NKI.xcp_ageFiltered[c(which(collated_NKI.xcp_ageFiltered$t1_qc==0)), c(2, 3)]
t1_exclusion_sessions <- t1_exclusion_sessions %>% mutate(sub_ses = paste0(sub, "_", ses))
collated_NKI.xcp_ageFiltered <- collated_NKI.xcp_ageFiltered %>% mutate(sub_ses =  paste0(sub, "_", ses))
t1_excluded <- collated_NKI.xcp_ageFiltered[-c(which(collated_NKI.xcp_ageFiltered$sub_ses %in% unique(t1_exclusion_sessions$sub_ses))),] # delete all the scans in a given session if T1 qc from that session fails
length(unique(collated_NKI.xcp_ageFiltered$sub)) - length(unique(t1_excluded$sub)) # 22 participants excluded
nrow(collated_NKI.xcp_ageFiltered) - nrow(t1_excluded) # 289 scans excluded
  
```

## 4) include meanFD < 0.3
```{r meanFD, include=FALSE}
# Exclude variable: 1=exclude based on mean_fd > 0.3. 16 additional participants excluded; 465 additional scans excluded
meanFD_exclusion <- t1_excluded[c(which(t1_excluded$Exclude==1)),]
meanFD_excluded <- t1_excluded[-c(which(t1_excluded$Exclude==1)),]
length(unique(t1_excluded$sub)) - length(unique(meanFD_excluded$sub)) # 16 additional participants excluded
nrow(meanFD_exclusion) # 465 additional scans excluded

collated_NKI.xcp_headMotion <- meanFD_excluded # first exclude all scans from a given session that fail T1. Then exclude by meanFD
casted_NKI.xcp <- dcast(collated_NKI.xcp_headMotion[,c(2:3)], sub~ses)
```


## 5) choose the session that has the most scans surviving the head motion exclusion
```{r choose_session, include=FALSE}
 
sub_list <- c()
ses_list <- c()
for (i in 1:nrow(casted_NKI.xcp)){
  subject <- casted_NKI.xcp$sub[i]
  sub_list <- append(sub_list, subject)
  print(subject)
  sessions_maxScans <- names(casted_NKI.xcp)[c(which(casted_NKI.xcp[i,] == pmax(casted_NKI.xcp$BAS1[i],casted_NKI.xcp$BAS2[i], casted_NKI.xcp$FLU1[i], casted_NKI.xcp$FLU2[i], casted_NKI.xcp$TRT[i])))] # identify sessions that have max number of scans
  if ("BAS1" %in% sessions_maxScans) {
    ses <- "BAS1"
    ses_list <- append(ses_list, ses)
  } else if ("FLU1" %in% sessions_maxScans) {
    ses <- "FLU1"
    ses_list <- append(ses_list, ses)
  } else if ("BAS2" %in% sessions_maxScans) {
    ses <- "BAS2"
    ses_list <- append(ses_list, ses)
  } else if ("FLU2" %in% sessions_maxScans) {
    ses <- "FLU2"
    ses_list <- append(ses_list, ses)
  } else if ("TRT" %in% sessions_maxScans) {
    ses <- "TRT"
    ses_list <- append(ses_list, ses)
  }
  print(ses)
}
 
subject_session <- as.data.frame(cbind(sub_list, ses_list))
names(subject_session) <- c("sub", "ses")
  
collated_NKI.xcp_Session <- merge(collated_NKI.xcp_headMotion, subject_session, by=c("sub", "ses"))
collated_NKI.xcp_Session <- collated_NKI.xcp_Session[,-c(which(names(collated_NKI.xcp_Session) == "X"))]
#length(unique(collated_NKI.xcp_Session$sub))
#write.csv(collated_NKI.xcp_Session, "/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI.xcp_Session_20221217.csv")
```

## 6) include scans with at least 7 minutes of scan time
```{r ciftiFile_list, include=FALSE}
# first, make CIFTI File list (for creating connectivity matrices) 
collated_NKI.xcp_Session <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI.xcp_Session_20221217.csv")
atlases <- c("Glasser", "Gordon", "Schaefer217", "Schaefer417")

ptseries_filenames <- list()
subject_names <- list()
subfolder_names <- list()
for (i in c(1:nrow(collated_NKI.xcp_Session))) {
  for(j in c(1:length(atlases))){
    filename <- paste0("sub-", collated_NKI.xcp_Session$sub[i], "_ses-", collated_NKI.xcp_Session$ses[i], "_task-rest_acq-", collated_NKI.xcp_Session$acq[i], "_space-fsLR_atlas-", atlases[j], "_den-91k_bold.ptseries.nii")
    RBC_path <- paste0("/cbica/projects/network_replication/input/NKI/nki_xcp/")
    subject <- paste0("sub-", collated_NKI.xcp_Session$sub[i])
    subfolder <- paste0("/ses-",collated_NKI.xcp_Session$ses[i],  "/func/" )
    if(file.exists(paste0(RBC_path,"sub-", collated_NKI.xcp_Session$sub[i], "/", filename))) {
      ptseries_filenames <- append(ptseries_filenames, filename)
      subject_names <- append(subject_names, subject)
      subfolder_names <- append(subfolder_names, subfolder)
      print(paste(i, "/", nrow(collated_NKI.xcp_Session), j))
    } else {
      print(paste("missing", filename))
    }
  }
}
  
ptseries_filenamesDF <- as.data.frame(do.call(rbind, ptseries_filenames))
subject_namesDF <- as.data.frame(do.call(rbind, subject_names))
subfolder_namesDF <- as.data.frame(do.call(rbind, subfolder_names))
file_paths <- as.data.frame(cbind(subject_namesDF, subfolder_namesDF, ptseries_filenamesDF))
names(file_paths) <- c("subject_namesDF", "subfolder_namesDF","ptseries_filenamesDF")
file_paths <- file_paths %>% mutate(path = paste0("/cbica/projects/network_replication/input/NKI/nki_xcp/", subject_namesDF, "/", ptseries_filenamesDF))
 
NKI_qc_filenames_atlases <- list(collated_NKI.xcp_Session, file_paths) 
#saveRDS(NKI_qc_filenames_atlases, "/cbica/projects/network_replication/input/NKI/sample_selection/NKI_qc_CIFTI_filepaths_20221217.RData")
 
```


- Calculate scan time for each subject 
```{r scan_time}
NKI_qc_filenames_atlases  <- readRDS("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_qc_CIFTI_filepaths_20221217.RData")
  
sub_variants <- unique(c(unique(NKI_qc_filenames_atlases[[1]]$sub[which(str_detect(NKI_qc_filenames_atlases[[1]]$acq, "VARIANT"))]), unique(NKI_qc_filenames_atlases[[1]]$sub[which(str_detect(NKI_qc_filenames_atlases[[1]]$acq, "RR"))]))) # 69 participants with variant acquisitions
length(unique(NKI_qc_filenames_atlases[[1]]$sub)) # 386 total participants  
  
# scans of subjects that have at least one variant acquisition
df_NKI_qc_subVariants <- NKI_qc_filenames_atlases[[1]][c(which(NKI_qc_filenames_atlases[[1]]$sub %in% sub_variants)),]


# load cubids summary and files csv
CUBIDS_summary <- read.csv("/cbica/projects/network_replication/input/NKI/CUBIDS_csvs/NKI_with_orientation_summary_20221201.csv")
CUBIDS_files <- read.csv("/cbica/projects/network_replication/input/NKI/CUBIDS_csvs/NKI_with_orientation_files.csv")
 
 
CUBIDS_files_func <- CUBIDS_files[-c(which(str_detect(CUBIDS_files$FilePath, "dwi")), which(str_detect(CUBIDS_files$FilePath, "anat"))),]
CUBIDS_files_func <- CUBIDS_files_func[c(which(str_detect(CUBIDS_files_func$KeyParamGroup, "rest"))),]  

 

CUBIDS_files_func <- CUBIDS_files_func %>% mutate(sub = gsub("sub-", "", str_extract(FilePath, "sub-A[0-9]+"))) %>% mutate(ses = gsub("ses-", "", str_extract(FilePath, "ses-[A-Z0-9]+"))) %>% mutate(acq= gsub("acq-", "",str_extract(FilePath, "acq-(CAP|1400|645)")))
CUBIDS_files_func <- CUBIDS_files_func %>% mutate(sub_ses_acq = paste0(sub, "_", ses, "_", acq))

 

NKI_qc_filenames_atlases[[1]] <- NKI_qc_filenames_atlases[[1]] %>% mutate(acq_noVar = str_extract(acq, "(CAP|1400|645)")) %>% mutate(sub_ses_acq = paste0(sub, "_", ses, "_", acq_noVar))
 

fMRIinclude_CUBIDS <- merge(NKI_qc_filenames_atlases[[1]], CUBIDS_files_func[c(1, 2, 3, 4, 11, 16,17,28,32)], by="sub_ses_acq") # fMRIinclude_CUBIDS shoud have same number of rows as NKI_qc_filenames_atlases[[1]]

 

# calculate scan time column. fyi, CAP is TR=2500 ms
fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS %>% mutate(TR = ifelse(str_detect(acq, "1400"), 1400, ifelse(str_detect(acq, "645"), 645, ifelse(str_detect(acq, "CAP"), 2500, NA))))

fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS %>% mutate(ScanTimeMinutes = TR*NumVolumes/1000/60)

 
# for each subject, sum the scan time
fMRIinclude_ScanTime_NKI <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 
subject_scanTime_exclude <- fMRIinclude_ScanTime_NKI$sub[c(which(fMRIinclude_ScanTime_NKI$ScanTime_Total < 7))] # do cut off at 7 min to be safe
  
fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS[-c(which(fMRIinclude_CUBIDS$sub %in% subject_scanTime_exclude)),]  
NKI_FinalSample <- list()
NKI_FinalSample[[1]] <- fMRIinclude_CUBIDS
NKI_FinalSample[[2]] <- NKI_qc_filenames_atlases[[2]][-c(which(NKI_qc_filenames_atlases[[2]]$subject_namesDF %in% paste0("sub-",subject_scanTime_exclude))),]  
 
#saveRDS(NKI_FinalSample, "/cbica/projects/network_replication/input/NKI/sample_selection/NKI_FinalSample_withCUBIDS_20221219.RData")
 


fMRIinclude_CUBIDS <- readRDS("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_FinalSample_withCUBIDS_20221219.RData")
fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS[[1]]
 
fMRIinclude_CUBIDS_ScanTime <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 
max(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 24 minutes and 57 seconds
fMRIinclude_CUBIDS_NumVols <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(NumVols_Total = sum(NumVolumes))
max(fMRIinclude_CUBIDS_NumVols$NumVols_Total) # 1424 volumes
```
 
  
# Final Demographics Dataframe
```{r demographics_finalSample}
NKI_FinalSample <- readRDS("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_FinalSample_withCUBIDS_20221219.RData")
demographics <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/nki_demographics.csv")

demographics <- demographics %>% mutate(sub_ses = paste0(subject, "_", session))
NKI_FinalSample[[1]] <- NKI_FinalSample[[1]] %>% mutate(sub_ses = paste0(sub, "_", ses))
final_dem <- demographics[c(which(demographics$sub_ses %in% NKI_FinalSample[[1]]$sub_ses)),]
final_dem <- final_dem[!duplicated(final_dem),]
 

## include average of relMeansRMSMotion and meanFD across the acquisitions included in calculating connectivity matrix 
 
# for each subject, take average relMeansRMSMotion and meanFD
subject <- c()
ses <- c()
avg_relMeansRMSMotion_vec <- c()
avg_meanFD_vec <- c()
for(i in c(1:length(unique(NKI_FinalSample[[1]]$sub)))){
  indices <- which(NKI_FinalSample[[1]]$sub == unique(NKI_FinalSample[[1]]$sub)[i])
  avg_RMS <- mean(NKI_FinalSample[[1]]$relMeansRMSMotion[indices])
  avg_meanFD <- mean(NKI_FinalSample[[1]]$meanFD[indices])
  subject <- append(subject, unique(NKI_FinalSample[[1]]$sub)[i])
  ses <- append(ses,NKI_FinalSample[[1]]$ses[indices[1]])
  avg_relMeansRMSMotion_vec <- append(avg_relMeansRMSMotion_vec, avg_RMS)
  avg_meanFD_vec <- append(avg_meanFD_vec, avg_meanFD)
}  

NKI_avgMotion <- data.frame(cbind(subject, ses, avg_meanFD_vec, avg_relMeansRMSMotion_vec))
names(NKI_avgMotion) <- c("subject", "ses", "meanFD_avgSes", "relMeansRMSMotion_avgSes")
final_dem_df <- merge(final_dem, NKI_avgMotion, by="subject")
 
 
#write.csv(final_dem_df, "/cbica/projects/network_replication/input/NKI/sample_selection/NKI_demographics_finalsample_20221219.csv")
 
final_dem_df_nki <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_demographics_finalsample_20221219.csv")
nki_dem_tsv <- read.delim("/cbica/projects/network_replication/input/NKI/sample_selection/nki_participants.tsv")
nki_dem_tsv <- nki_dem_tsv %>% dplyr::rename(subject=participant_id)
nki_dem_tsv$subject <- gsub("sub-", "", nki_dem_tsv$subject)
nki_dem_tsv <- nki_dem_tsv[-c(which(duplicated(nki_dem_tsv$subject))),]

race_info_nki <- merge(final_dem_df_nki, nki_dem_tsv, by="subject")

unique(race_info_nki$race) 
length(which(is.na(race_info_nki$race)))/nrow(race_info_nki)
# white = 249 - 65.4%
# asian = 34 - 8.9%
# black = 77 - 20.2%
# other = 10 - 2.6%
# missing = 11 - 2.9%

sd(race_info_nki$age.x) #14.5, SD=4.4

length(which(final_dem_df$gender=="F")) # 177 females
 
```



# Variants
```{r}

NKI_FinalSample_withCUBIDS <- readRDS("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_FinalSample_withCUBIDS_20221219.RData")  
CUBIDS_files <- read.csv("/cbica/projects/network_replication/input/NKI/CUBIDS_csvs/NKI_with_orientation_files.csv")

#which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00027439")
 
# 316 normal participants
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(!str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyParamGroup, "VARIANT")))]))
#824 scans
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(!str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyParamGroup, "VARIANT")))])
 

NKI_FinalSample_withCUBIDS[[1]][c(which(!str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyParamGroup, "VARIANT"))),]
 
unique(NKI_FinalSample_withCUBIDS[[1]]$variant_info_CUBIDS)

unique(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "VARIANT")))])

# 1400VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime: A00027167, BAS1, 1400  
# 48 participants, 48 scans
NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "1400VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime")))]
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "1400VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime")))])) # 48 participants  
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "1400VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime")))]) # 48 scans 
NKI_FinalSample_withCUBIDS[[1]][c(which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00027167")),]
 
# 645VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime: A00027167, BAS1, 645
# 58 participants, 58 scans 
NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "645VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime")))]
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "645VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime")))])) # 58 participants 
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "645VARIANTMultibandAccelerationFactorPartialFourierTotalReadoutTime")))]) # 58 scans 
NKI_FinalSample_withCUBIDS[[1]][c(which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00027167")),]

# CAPVARIANTPartialFourierTotalReadoutTime: A00027167, BAS1, CAP
# 54 participants, 54 scans
NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "CAPVARIANTPartialFourierTotalReadoutTime")))]
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "CAPVARIANTPartialFourierTotalReadoutTime")))])) # 54 participants 
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "CAPVARIANTPartialFourierTotalReadoutTime")))]) # 54 scans 
NKI_FinalSample_withCUBIDS[[1]][c(which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00027167")),]

# 1400VARIANTObliquity: A00031219, BAS1
# 1 participant, 1 scan
NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "1400VARIANTObliquity")))]
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "1400VARIANTObliquity")))])) # 1 participant 
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "1400VARIANTObliquity")))]) # 1 scan
NKI_FinalSample_withCUBIDS[[1]][c(which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00031219")),]

# 645VARIANTObliquity: A00031219, BAS1
# 2 participants, 2 scans
NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "645VARIANTObliquity")))]
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "645VARIANTObliquity")))])) # 2 participant 
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "645VARIANTObliquity")))]) # 2 scans
NKI_FinalSample_withCUBIDS[[1]][c(which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00031219")),]

# CAPVARIANTNumVolumes: A00053171, FLU2, CAP
NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "CAPVARIANTNumVolumes")))]
length(unique(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "CAPVARIANTNumVolumes")))])) # 1 participant 
length(NKI_FinalSample_withCUBIDS[[1]]$sub[c(which(str_detect(NKI_FinalSample_withCUBIDS[[1]]$KeyGroup, "CAPVARIANTNumVolumes")))]) # 1 scan
NKI_FinalSample_withCUBIDS[[1]][c(which(NKI_FinalSample_withCUBIDS[[1]]$sub == "A00053171")),]



 
# T1 variants
CUBIDS_files_anat <- CUBIDS_files[-c(which(str_detect(CUBIDS_files$FilePath, "TRT")), which(str_detect(CUBIDS_files$FilePath, "BAS2")), which(str_detect(CUBIDS_files$FilePath, "BAS3")), which(str_detect(CUBIDS_files$FilePath, "FLU2")),which(str_detect(CUBIDS_files$FilePath, "FLU3")), which(str_detect(CUBIDS_files$FilePath, "dwi")), which(str_detect(CUBIDS_files$FilePath, "rest"))),]
CUBIDS_files_anat <- CUBIDS_files_func[c(which(str_detect(CUBIDS_files_anat$KeyParamGroup, "anat"))),] 

unique(CUBIDS_files_anat$KeyParamGroup)

# VARIANTParallelReductionFactorInPlanePartialFourierPhaseEncodingDirection -- A00066698
# 73 participants, 177 scans 
filepaths <- CUBIDS_files_anat$FilePath[c(which(str_detect(CUBIDS_files_anat$KeyParamGroup, "VARIANTParallelReductionFactorInPlanePartialFourierPhaseEncodingDirection")))]
sub <- str_extract(filepaths, "sub-A[0-9]+")
sub <- gsub("sub-", "", sub)
subs_t1_variant <- sub[c(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub))]
length(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub)) # 73 participants 
length(which(NKI_FinalSample_withCUBIDS[[1]]$sub %in% subs_t1_variant)) # 177 scans
 
 
 
# VARIANTObliquity -- A00027159
# 13 participants, 31 scans
filepaths <- CUBIDS_files_anat$FilePath[c(which(str_detect(CUBIDS_files_anat$KeyParamGroup, "VARIANTObliquity")))]
sub <- str_extract(filepaths, "sub-A[0-9]+")
sub <- gsub("sub-", "", sub)
subs_t1_variant <- sub[c(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub))]
length(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub)) # 13 participants 
length(which(NKI_FinalSample_withCUBIDS[[1]]$sub %in% subs_t1_variant)) # 31 scans

# VARIANTParallelReductionFactorInPlanePartialFourierPhaseEncodingDirectionObliquity - A00083744
# 6 participants, 12 scans
filepaths <- CUBIDS_files_anat$FilePath[c(which(str_detect(CUBIDS_files_anat$KeyParamGroup, "VARIANTParallelReductionFactorInPlanePartialFourierPhaseEncodingDirectionObliquity")))]
sub <- str_extract(filepaths, "sub-A[0-9]+")
sub <- gsub("sub-", "", sub)
subs_t1_variant <- sub[c(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub))]
length(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub)) # 6 participants 
length(which(NKI_FinalSample_withCUBIDS[[1]]$sub %in% subs_t1_variant)) # 12 scans

#VARIANTEchoTimeDim1SizeDim2SizeDim3SizeVoxelSizeDim1VoxelSizeDim2VoxelSizeDim3 - A00059733
# 2 participants, 3 scans
filepaths <- CUBIDS_files_anat$FilePath[c(which(str_detect(CUBIDS_files_anat$KeyParamGroup, "VARIANTEchoTimeDim1SizeDim2SizeDim3SizeVoxelSizeDim1VoxelSizeDim2VoxelSizeDim3")))]
sub <- str_extract(filepaths, "sub-A[0-9]+")
sub <- gsub("sub-", "", sub)
subs_t1_variant <- sub[c(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub))]
length(which(sub %in% NKI_FinalSample_withCUBIDS[[1]]$sub)) # 2 participants 
length(which(NKI_FinalSample_withCUBIDS[[1]]$sub %in% subs_t1_variant)) # 3 scans
```



# Extras
## Figures 
```{r scatterplot_meanFD_RMSmotion, fig.height=4, fig.width=4}
# full sample
ggplot(collated_NKI.xcp, aes(x=meanFD, y=relMeansRMSMotion)) + 
  geom_point(alpha = 0.7, size = 2, color = '#88419D') + 
  theme(axis.text.x=element_text(size=32), axis.title.x=element_text(size=28), axis.title.y=element_text(size=28)) + 
  ggtitle("MeanFD vs relMeansRMSMotion in NKI") + 
  labs(x="MeanFD", y="RelMeansRMSMotion", shape = "", color = "") + 
  theme_classic() +
  stat_cor(method = "spearman",size = 4, r.digits = 3)
```

```{r table_T1_FuncQC, eval-FALSE}
# LOOKING AT FULL SAMPLE (ages 6-85)
# Exclude variable: 1=exclude based on mean_fd > 0.3.
# t1_qc variable: 0=exclude based on T1 image quality. 426 scans excluded; 94 participants excluded.  
collated_NKI.xcp <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI_xcpALL.csv")
length(which(collated_NKI.xcp$Exclude == 0 & collated_NKI.xcp$t1_qc == 1)) # 4627 include based on mean_FD, include based on T1
length(which(collated_NKI.xcp$Exclude == 1 & collated_NKI.xcp$t1_qc == 0)) # 241 exclude based on mean_FD, exclude based on T1


length(which(collated_NKI.xcp$Exclude == 1 & collated_NKI.xcp$t1_qc == 1)) # 1173 exclude based on mean_FD, include based on T1
length(which(collated_NKI.xcp$Exclude == 0 & collated_NKI.xcp$t1_qc == 0)) # 185 include based on mean_FD, exclude based on T1
 
```


```{r scan_time.fig, fig.height=6, fig.width=6}
  
# for each subject, sum the scan time
fMRIinclude_ScanTime_NKI <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 

length(which(fMRIinclude_ScanTime_NKI$ScanTime_Total == max(fMRIinclude_ScanTime_NKI$ScanTime_Total))) #217
length(which(fMRIinclude_ScanTime_NKI$ScanTime_Total < max(fMRIinclude_ScanTime_NKI$ScanTime_Total) & fMRIinclude_ScanTime_NKI$ScanTime_Total >= 15)) # 31
length(which(fMRIinclude_ScanTime_NKI$ScanTime_Total < 15 & fMRIinclude_ScanTime_NKI$ScanTime_Total >= 10)) # 53
length(which(fMRIinclude_ScanTime_NKI$ScanTime_Total < 10)) # 62
length(which(fMRIinclude_ScanTime_NKI$ScanTime_Total == min(fMRIinclude_ScanTime_NKI$ScanTime_Total))) # 4

(ScanTime_fig_NKI <- ggplot(fMRIinclude_ScanTime_NKI, aes(x=ScanTime_Total)) +
  geom_histogram(position="identity", alpha=0.5, bins=25, colour = "#24A6A8FF", fill = "#24A6A8FF") + 
  theme_classic(base_size=16) +  
  annotate(geom="text", x=7, y=210, label="Total N = 363", color="black", fontface="bold", size=6, hjust=0) + 
  annotate(geom="text", x=7, y=180, label="TR = CAP, 1400, and 645 ms \n with NumVol=120, 404, and 900", color="black", fontface="bold", size=6, hjust=0) +
  annotate(geom="text", x=7, y=150, label="Max Scan Time 24.1 min: N = 217", color="black", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=135, label="15 min < Scan Time < 24.1 min: N = 31", color="black", size=5, hjust=0) +
  annotate(geom="text", x=7, y=120, label="10 min < Scan Time <= 15 min: N = 53", color="black", size=5, hjust=0) +
  annotate(geom="text", x=7, y=105, label="Scan Time <= 10 min: N = 62", color="black", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=70, label="Minimum Scan Time 5 min: N = 4", color="black", size=5 , hjust=0) + 
  ggtitle("Histogram of Total Scan Time (in Minutes): \n NKI"))
 
 
fMRIinclude_ScanTime_NKI$ScanTime_Total[c(which(fMRIinclude_ScanTime_NKI$ScanTime_Total < 10))] # do cut off at 7 min to be safe
  
```


## Mean FD threshold selection (no T1 QA applied!)
- included only age 6-22
```{r meanFD_thresholds, eval=FALSE, include=FALSE}
# no QC applied. Filtering for ages 5-22
collated_NKI.xcp <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/collated_NKI_xcpALL.csv")
demographics <- read.csv("/cbica/projects/network_replication/input/NKI/sample_selection/NKI_demographics_finalsample.csv")
demographics_filtered <- demographics$sub[c(which(demographics$age >4 & demographics$age <23))]
 
collated_NKI.xcp_ageExcluded <- collated_NKI.xcp[c(which(collated_NKI.xcp$sub %in% demographics_filtered)),]
  
collated_NKI.xcp_ageExcluded <- collated_NKI.xcp_ageExcluded[-c(which(collated_NKI.xcp_ageExcluded$ses=="BAS2"), which(collated_NKI.xcp_ageExcluded$ses=="BAS3"), which(collated_NKI.xcp_ageExcluded$ses=="TRT"), which(collated_NKI.xcp_ageExcluded$ses=="FLU2"), which(collated_NKI.xcp_ageExcluded$ses=="FLU3")),]

# checking how many subjects would be excluded with different meanFD filters (pre-QC). If BAS1 is missing or gets excluded by QC, then use FLU1
length(which(collated_NKI.xcp_ageExcluded$meanFD > 0.2)) # 524 across all sessions
meanFD_02 <- collated_NKI.xcp_ageExcluded %>% filter(meanFD < 0.2)
meanFD_02_casted <- dcast(meanFD_02[,c(2:3)], sub~ses)
meanFD_02_flu1_participants <- meanFD_02_casted$sub[c(which(meanFD_02_casted$BAS1 > 0 & meanFD_02_casted$FLU1 > 0))]
meanFD_02_final <- meanFD_02[-c(which(meanFD_02$sub %in% meanFD_02_flu1_participants & meanFD_02$ses == "FLU1")),]
length(unique(meanFD_02$sub)) #338 subjects included
 
length(which(collated_NKI.xcp_ageExcluded$meanFD > 0.3)) #267 across all sessions
meanFD_03 <- collated_NKI.xcp_ageExcluded %>% filter(meanFD < 0.3)
meanFD_03_casted <- dcast(meanFD_03[,c(2:3)], sub~ses)
meanFD_03_flu1_participants <- meanFD_03_casted$sub[c(which(meanFD_03_casted$BAS1 > 0 & meanFD_03_casted$FLU1 > 0))]
meanFD_03_final <- meanFD_03[-c(which(meanFD_03$sub %in% meanFD_03_flu1_participants & meanFD_03$ses == "FLU1")),]
length(unique(meanFD_03$sub)) # 363 subjects included
 
 
length(which(collated_NKI.xcp_ageExcluded$meanFD > 0.4)) # 152 across all sessions
meanFD_04 <- collated_NKI.xcp_ageExcluded %>% filter(meanFD < 0.4)
meanFD_04_casted <- dcast(meanFD_04[,c(2:3)], sub~ses)
meanFD_04_flu1_participants <- meanFD_04_casted$sub[c(which(meanFD_04_casted$BAS1 > 0 & meanFD_04_casted$FLU1 > 0))]
meanFD_04_final <- meanFD_04[-c(which(meanFD_04$sub %in% meanFD_04_flu1_participants & meanFD_04$ses == "FLU1")),]
length(unique(meanFD_04$sub)) # 363 subjects included


# checking how many subjects have at least 10 minutes and 15 minutes of data after applying meanFD thresholds
# load cubids summary and files csv
CUBIDS_summary <- read.csv("/cbica/projects/network_replication/input/NKI/CUBIDS_csvs/NKI_with_orientation_summary_20221201.csv")
CUBIDS_files <- read.csv("/cbica/projects/network_replication/input/NKI/CUBIDS_csvs/NKI_with_orientation_files.csv")
CUBIDS_files_func <- CUBIDS_files[-c(which(str_detect(CUBIDS_files$FilePath, "TRT")), which(str_detect(CUBIDS_files$FilePath, "BAS2")), which(str_detect(CUBIDS_files$FilePath, "BAS3")), which(str_detect(CUBIDS_files$FilePath, "FLU2")),which(str_detect(CUBIDS_files$FilePath, "FLU3")), which(str_detect(CUBIDS_files$FilePath, "dwi")), which(str_detect(CUBIDS_files$FilePath, "anat"))),]
CUBIDS_files_func <- CUBIDS_files_func[c(which(str_detect(CUBIDS_files_func$KeyParamGroup, "rest"))),] # need to remove the scans that got QC'd by T1 and meanFD
CUBIDS_files_func <- CUBIDS_files_func %>% mutate(sub = gsub("sub-", "", str_extract(FilePath, "sub-A[0-9]+"))) %>% mutate(ses = gsub("ses-", "", str_extract(FilePath, "ses-[A-Z0-9]+"))) %>% mutate(acq= gsub("acq-", "",str_extract(FilePath, "acq-(CAP|1400|645)")))
CUBIDS_files_func <- CUBIDS_files_func %>% mutate(sub_ses_acq = paste0(sub, "_", ses, "_", acq))
 


meanFD_02_final <- meanFD_02_final %>% mutate(acq_noVar = str_extract(acq, "(CAP|1400|645)")) %>% mutate(sub_ses_acq = paste0(sub, "_", ses, "_", acq_noVar))
meanFD_03_final <- meanFD_03_final %>% mutate(acq_noVar = str_extract(acq, "(CAP|1400|645)")) %>% mutate(sub_ses_acq = paste0(sub, "_", ses, "_", acq_noVar))
meanFD_04_final <- meanFD_04_final %>% mutate(acq_noVar = str_extract(acq, "(CAP|1400|645)")) %>% mutate(sub_ses_acq = paste0(sub, "_", ses, "_", acq_noVar))

meanFD_02_CUBIDS <- merge(meanFD_02_final, CUBIDS_files_func[c(1, 2, 3, 4, 11, 16,17,28,32)], by="sub_ses_acq")
meanFD_03_CUBIDS <- merge(meanFD_03_final, CUBIDS_files_func[c(1, 2, 3, 4, 11, 16,17,28,32)], by="sub_ses_acq")
meanFD_04_CUBIDS <- merge(meanFD_04_final, CUBIDS_files_func[c(1, 2, 3, 4, 11, 16,17,28,32)], by="sub_ses_acq")

meanFD_02_CUBIDS <- meanFD_02_CUBIDS %>% mutate(TR = ifelse(str_detect(acq, "1400"), 1400, ifelse(str_detect(acq, "645"), 645, ifelse(str_detect(acq, "CAP"), 2500, NA)))) %>% mutate(ScanTimeMinutes = TR*NumVolumes/1000/60)
meanFD_03_CUBIDS <- meanFD_03_CUBIDS %>% mutate(TR = ifelse(str_detect(acq, "1400"), 1400, ifelse(str_detect(acq, "645"), 645, ifelse(str_detect(acq, "CAP"), 2500, NA)))) %>% mutate(ScanTimeMinutes = TR*NumVolumes/1000/60)
meanFD_04_CUBIDS <- meanFD_04_CUBIDS %>% mutate(TR = ifelse(str_detect(acq, "1400"), 1400, ifelse(str_detect(acq, "645"), 645, ifelse(str_detect(acq, "CAP"), 2500, NA)))) %>% mutate(ScanTimeMinutes = TR*NumVolumes/1000/60)
 

meanFD_02_ScanTime_NKI <- meanFD_02_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
meanFD_03_ScanTime_NKI <- meanFD_03_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
meanFD_04_ScanTime_NKI <- meanFD_04_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))

length(which(meanFD_02_ScanTime_NKI$ScanTime_Total >= 10))
length(which(meanFD_02_ScanTime_NKI$ScanTime_Total >= 15))

length(which(meanFD_03_ScanTime_NKI$ScanTime_Total >= 10))
length(which(meanFD_03_ScanTime_NKI$ScanTime_Total >= 15))

length(which(meanFD_04_ScanTime_NKI$ScanTime_Total >= 10))
length(which(meanFD_04_ScanTime_NKI$ScanTime_Total >= 15))
```


