schaefer400x7_rows <- as.data.frame(t(schaefer400.parcel.labels$network))
schaefer400x7_commAffil_mat <- as.data.frame(schaefer400x7_rows[rep(seq_len(nrow(schaefer400x7_rows)), each = 400), ])
rownames(schaefer400x7_commAffil_mat) <- NULL
SNRmask_schaefer400 <- read.csv('/cbica/projects/network_replication/atlases/Masks/SNRmask_schaefer400x7.csv')
# computeWNC(rbcid, "schaefer400", schaefer400x7_commAffil_mat, schaefer400.parcel.labels$network)
computeWNC <- function(rbcid, atlas, community_affiliation_mat, network_assignment){
#read in connectivity matrix
if(atlas == "schaefer400"){
connect.matrix <- read_cifti(sprintf("/cbica/projects/network_replication/pconn/%1$s/%1$s_ses-PNC1_task-rest_acq-singleband_space-fsLR_atlas-Schaefer417_den-91k_den-91k_bold.pconn.nii",rbcid))
mask <- SNRmask_schaefer400} #400 x 400 matrix
# set rows and columns corresponding to parcel # in mask to NA
connect.matrix$data[which(mask == 0), ] <- NA
connect.matrix$data[,which(mask == 0)] <- NA
#compute average within-network connectivity
WNC <- c()
for (i in 1:nrow(connect.matrix$data)) {
within_network_values <- c()
WNC_per_node <- c()
for (j in 1:length(connect.matrix$data[i,])) {  # entire  row
if(is.na(connect.matrix$data[i,j]) || connect.matrix$data[i,j] == 1) { # add NA if excluded by mask or identity
within_network_values <- append(within_network_values, NA);
} else if (schaefer400.parcel.labels$network[i] == schaefer400x7_commAffil_mat[i,j]) {
within_network_values <- append(within_network_values, connect.matrix$data[i,j])
} else if (schaefer400.parcel.labels$network[i] != schaefer400x7_commAffil_mat[i,j]) {
within_network_values <- append(within_network_values, NA)
}
}
#print(within_network_values)
WNC_per_node <- append(WNC_per_node, mean(within_network_values, na.rm=TRUE))
#print(WNC_per_node) # 1 value
WNC <- append(WNC, WNC_per_node)
}
return(WNC)
}
participants <- read.csv('/cbica/projects/network_replication/adapted_Rscripts/participants_allIDs.csv')
subs_no_files <- read.csv('/cbica/projects/network_replication/adapted_Rscripts/subs_no_files.csv', row.names=NULL)
subs_no_files <- subs_no_files[,2]
WNC.subxparcel.matrix.schaefer400 <- matrix(data = NA, nrow = nrow(participants), ncol = 401)
regionheaders <- as.character(schaefer400.parcel.labels$region)
demoheaders <- c("rbcid")
colheaders <- as.matrix(c(demoheaders,regionheaders))
colnames(WNC.subxparcel.matrix.schaefer400) <- colheaders
#compute WNC for each subject
for(sub in c(40))){
#compute WNC for each subject
for(sub in c(40)){
rbcid=as.character(participants[sub,4])
if(rbcid %in% subs_no_files){
next
}
else {
rbcid.data.schaefer400 <- computeWNC(rbcid, "schaefer400", schaefer400x7_commAffil_mat, schaefer400.parcel.labels$network)
WNC.subxparcel.matrix.schaefer400[sub,] <- cbind(rbcid, t(rbcid.data.schaefer400))
print(paste(sub, rbcid, "schaefer400"))
}
}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
source("/cbica/projects/network_replication/adapted_Rscripts/GAM_functions.R")
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggsegExtra)
library(ggsegSchaefer)
library(ggcorrplot)
library(viridis)
library(scales)
library(stringr)
library(tidyr)
# load SNR mask
SNRmask_schaefer200 <- read.csv('/cbica/projects/network_replication/atlases/Masks/SNRmask_schaefer200x17.csv')
# load region list
schaefer200.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer200x17_regionlist.csv", header = T)
names(schaefer200.parcel.labels)[2] <- "label"
schaefer200.parcel.labels[which(SNRmask_schaefer200 == 0),] <- NA # apply SNR mask to parcel names
schaefer200.parcel.labels <- na.omit(schaefer200.parcel.labels)
# load parcellated SA axis
schaefer200_SAaxis_cifti <- read_cifti("/cbica/projects/network_replication/SAaxis/SensorimotorAssociation_Axis_parcellated/SensorimotorAssociation.Axis.Schaefer200.17Networks.pscalar.nii")
schaefer200_SAaxis <- as.data.frame(cbind(rank(schaefer200_SAaxis_cifti$data), names(schaefer200_SAaxis_cifti$Parcel)))
colnames(schaefer200_SAaxis) <- c("SA.axis_rank","label")
# apply SNR mask
schaefer200_SAaxis[which(SNRmask_schaefer200 == 0),] <- NA
schaefer200_SAaxis <- na.omit(schaefer200_SAaxis)
## GAM Results
gam.BNC.age.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMresults.BNC.age.schaefer200x17.csv")
gam.BNC.age.schaefer200 <- gam.BNC.age.schaefer200 %>% select(-label)
gam.BNC.age.schaefer200$label <- schaefer200_SAaxis$label
gam.smooths.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMsmoothfits.BNC.age.schaefer200x17.csv")
gam.smooths.schaefer200$orig_parcelname <- gam.smooths.schaefer200$label
gam.agepeaks.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMpeaks.BNC.age.schaefer200x17.csv")
gam.agepeaks.schaefer200 <- gam.agepeaks.schaefer200 %>% select(-label)
gam.agepeaks.schaefer200$label <- schaefer200_SAaxis$label
# Combine into Final Dfs
df.list <- list(schaefer200_SAaxis,gam.BNC.age.schaefer200)
BNC.axis <- Reduce(function(x,y) merge(x,y, all=TRUE, sort=F), df.list)
BNC.axis$SA.axis_rank <- as.numeric(BNC.axis$SA.axis_rank)
a <- merge(schaefer200.parcel.labels, schaefer200_SAaxis, by="label", sort=F)
gam.smooths.schaefer200 <- left_join(gam.smooths.schaefer200, a, by = "label")
gam.smooths.schaefer200$SA.axis_rank <-as.numeric(gam.smooths.schaefer200$SA.axis_rank)
gam.agepeaks.schaefer200 <- left_join(gam.agepeaks.schaefer200, schaefer200_SAaxis, by="label")
gam.agepeaks.schaefer200$SA.axis_rank <-as.numeric(gam.agepeaks.schaefer200$SA.axis_rank)
BNC.axis$Anova.age.pvalue.fdr <- p.adjust(BNC.axis$Anova.age.pvalue, method=c("fdr"))
cat(sprintf("There are %s/%s significant parcels", sum(BNC.axis$Anova.age.pvalue.fdr < 0.05), nrow(BNC.axis)))
BNC.axis$significant.fdr <- BNC.axis$Anova.age.pvalue.fdr < 0.05
BNC.axis$significant.fdr[BNC.axis$significant.fdr == TRUE] <- 1
BNC.axis$significant.fdr[BNC.axis$significant.fdr == FALSE] <- 0
cor.test(BNC.axis$GAM.age.AdjRsq, as.numeric(BNC.axis$SA.axis_rank), method=c("spearman"), exact=F)
library(ggpubr)
BNC.axis <- BNC.axis %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
## SA axis average rank vs. age effect
# included all datapoints for this figure
cor.test(BNC.axis$GAM.age.AdjRsq, as.numeric(BNC.axis$SA.axis_rank), method=c("spearman"), exact=F)
(schaefer200_SA.AgeEffect <- ggplot(BNC.axis, aes(x=SA.axis_rank, y=GAM.age.AdjRsq, fill = SA.axis_rank_signif)) + geom_point(color = "white", shape = 21, size=2) +
scale_fill_gradient2(low="#6f1282",high = "goldenrod1",, mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank), na.value="gray") +
labs(fill = "SA Axis Rank", x="\nSensorimotor-Association Axis Rank\n", y=expression(paste("Age Effect (Delta Adj", " R"^2, ")"))) +
geom_smooth(data = BNC.axis, method='lm', se=TRUE, fill=alpha(c("gray70"),.9), col="black") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "right") +
annotate(geom="text", x=140, y=0.055, label="R = -0.59, p < 0.0001  ", color="black"))
# ggsave(schaefer200_SA.AgeEffect, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer200/BNC/schaefer200x17_SA.AgeEffect.pdf", width = 5, height=4, dpi=300)
(schaefer200_SA.AgeEffect <- ggplot(BNC.axis, aes(x=SA.axis_rank, y=GAM.age.AdjRsq, fill = SA.axis_rank_signif)) + geom_point(color = "white", shape = 21, size=2) +
scale_fill_gradient2(low="#6f1282",high = "goldenrod1",, mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank), na.value="gray") +
labs(fill = "SA Axis Rank", x="\nSensorimotor-Association Axis Rank\n", y=expression(paste("Age Effect (Delta Adj", " R"^2, ")"))) +
geom_smooth(data = BNC.axis, method='lm', se=TRUE, fill=alpha(c("gray70"),.9), col="black") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "right") +
annotate(geom="text", x=140, y=0.055, label="R = -0.59, p < 0.00001  ", color="black"))
ggsave(schaefer200_SA.AgeEffect, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer200/BNC/schaefer200x17_SA.AgeEffect.pdf", width = 5, height=4, dpi=300)
# seems like transmodal areas have greater BNC and seem to increase with age, while unimodal areas have smaller BNC and increase or stays the same with age
(schaefer200_predBNC <- ggplot(gam.smooths.schaefer200,aes(age,fit,group=index)) +
geom_line(data = gam.smooths.schaefer200, size=.8, alpha = .6, aes(color=SA.axis_rank)) + scale_color_gradient2(low="#6f1282",high = "goldenrod1", mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank)) +
labs(color = "SA Axis Rank",
x="Age",
y="Predicted between-Network Coupling") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "bottom") + coord_cartesian(expand = FALSE, xlim = c(8, 23)))
#ggsave(schaefer200_predBNC, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer200/BNC/schaefer200x17_predBNC.pdf", width = 4, height=4, dpi=300)
gam.smooths.schaefer200
a <- merge(schaefer200.parcel.labels, schaefer200_SAaxis, by="label", sort=F)
a
gam.smooths.schaefer200 <- left_join(gam.smooths.schaefer200, a, by = "label")
gam.smooths.schaefer200
schaefer200_SAaxis
schaefer200.parcel.labels
a <- merge(schaefer200.parcel.labels, schaefer200_SAaxis, by="label", sort=F)
a
left_join(gam.smooths.schaefer200, a, by = "label")
right_join(gam.smooths.schaefer200, a, by = "label")
right_join(gam.smooths.schaefer200, a, by = "label")
gam.smooths.schaefer200 <- left_join(gam.smooths.schaefer200, a, by = "label")
gam.smooths.schaefer200
## GAM Results
gam.BNC.age.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMresults.BNC.age.schaefer200x17.csv")
gam.BNC.age.schaefer200 <- gam.BNC.age.schaefer200 %>% select(-label)
gam.BNC.age.schaefer200$label <- schaefer200_SAaxis$label
gam.smooths.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMsmoothfits.BNC.age.schaefer200x17.csv")
gam.smooths.schaefer200$orig_parcelname <- gam.smooths.schaefer200$label
gam.agepeaks.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMpeaks.BNC.age.schaefer200x17.csv")
gam.agepeaks.schaefer200 <- gam.agepeaks.schaefer200 %>% select(-label)
gam.agepeaks.schaefer200$label <- schaefer200_SAaxis$label
gam.smooths.schaefer200_test <- gam.smooths.schaefer200
gam.smooths.schaefer200_test <- left_join(gam.smooths.schaefer200_test, a, by = "orig_parcelname")
gam.smooths.schaefer200_test <- gam.smooths.schaefer200
gam.smooths.schaefer200_test <- left_join(gam.smooths.schaefer200_test, a, by = "orig_parcelname")
gam.smooths.schaefer200_test <- left_join(gam.smooths.schaefer200_test, a, by = "label")
gam.smooths.schaefer200_test
gam.smooths.schaefer200_test <- gam.smooths.schaefer200
gam.smooths.schaefer200_test
a
gam.smooths.schaefer200_test <- left_join(gam.smooths.schaefer200_test, a, by = "label")
gam.smooths.schaefer200_test
a
a <- a[,-2]
gam.smooths.schaefer200_test <- left_join(gam.smooths.schaefer200_test, a, by = "label")
gam.smooths.schaefer200_test
gam.smooths.schaefer200_test <- gam.smooths.schaefer200
gam.smooths.schaefer200_test <- right_join(gam.smooths.schaefer200_test, a, by = "label")
gam.smooths.schaefer200_test
gam.smooths.schaefer200
gam.smooths.schaefer200_test
cbind(gam.smooths.schaefer200[,c(1:6), gam.smooths.schaefer200_test]
gam.smooths.schaefer200_test <- gam.smooths.schaefer200_test[, -c(1:6)]
cbind(gam.smooths.schaefer200[,c(1:6), gam.smooths.schaefer200_test)
gam.smooths.schaefer200_test <- gam.smooths.schaefer200
gam.smooths.schaefer200_test <- right_join(gam.smooths.schaefer200_test, a, by = "label")
gam.smooths.schaefer200_test <- gam.smooths.schaefer200_test[, -c(1:6)]
cbind(gam.smooths.schaefer200[,c(1:6)], gam.smooths.schaefer200_test)
gam.smooths.schaefer200
cbind(gam.smooths.schaefer200[,c(1:6)], gam.smooths.schaefer200_test)
gam.agepeaks.schaefer200 <- left_join(gam.agepeaks.schaefer200, schaefer200_SAaxis, by="label")
gam.agepeaks.schaefer200$SA.axis_rank <-as.numeric(gam.agepeaks.schaefer200$SA.axis_rank)
gam.agepeaks.schaefer200
gam.smooths.schaefer200 <- cbind(gam.smooths.schaefer200[,c(1:6)], gam.smooths.schaefer200_test) #not sure why the original code wasn't working
gam.smooths.schaefer200
BNC.axis$Anova.age.pvalue.fdr <- p.adjust(BNC.axis$Anova.age.pvalue, method=c("fdr"))
cat(sprintf("There are %s/%s significant parcels", sum(BNC.axis$Anova.age.pvalue.fdr < 0.05), nrow(BNC.axis)))
BNC.axis$significant.fdr <- BNC.axis$Anova.age.pvalue.fdr < 0.05
BNC.axis$significant.fdr[BNC.axis$significant.fdr == TRUE] <- 1
BNC.axis$significant.fdr[BNC.axis$significant.fdr == FALSE] <- 0
cor.test(BNC.axis$GAM.age.AdjRsq, as.numeric(BNC.axis$SA.axis_rank), method=c("spearman"), exact=F)
# seems like transmodal areas have greater BNC and seem to increase with age, while unimodal areas have smaller BNC and increase or stays the same with age
(schaefer200_predBNC <- ggplot(gam.smooths.schaefer200,aes(age,fit,group=index)) +
geom_line(data = gam.smooths.schaefer200, size=.8, alpha = .6, aes(color=SA.axis_rank)) + scale_color_gradient2(low="#6f1282",high = "goldenrod1", mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank)) +
labs(color = "SA Axis Rank",
x="Age",
y="Predicted between-Network Coupling") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "bottom") + coord_cartesian(expand = FALSE, xlim = c(8, 23)))
library(ggpubr)
BNC.axis <- BNC.axis %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
## SA axis average rank vs. age effect
# included all datapoints for this figure
cor.test(BNC.axis$GAM.age.AdjRsq, as.numeric(BNC.axis$SA.axis_rank), method=c("spearman"), exact=F)
(schaefer200_SA.AgeEffect <- ggplot(BNC.axis, aes(x=SA.axis_rank, y=GAM.age.AdjRsq, fill = SA.axis_rank_signif)) + geom_point(color = "white", shape = 21, size=2) +
scale_fill_gradient2(low="#6f1282",high = "goldenrod1",, mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank), na.value="gray") +
labs(fill = "SA Axis Rank", x="\nSensorimotor-Association Axis Rank\n", y=expression(paste("Age Effect (Delta Adj", " R"^2, ")"))) +
geom_smooth(data = BNC.axis, method='lm', se=TRUE, fill=alpha(c("gray70"),.9), col="black") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "right") +
annotate(geom="text", x=140, y=0.055, label="R = -0.59, p < 0.00001  ", color="black"))
# ggsave(schaefer200_SA.AgeEffect, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer200/BNC/schaefer200x17_SA.AgeEffect.pdf", width = 5, height=4, dpi=300)
# seems like transmodal areas have greater BNC and seem to increase with age, while unimodal areas have smaller BNC and increase or stays the same with age
(schaefer200_predBNC <- ggplot(gam.smooths.schaefer200,aes(age,fit,group=index)) +
geom_line(data = gam.smooths.schaefer200, size=.8, alpha = .6, aes(color=SA.axis_rank)) + scale_color_gradient2(low="#6f1282",high = "goldenrod1", mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank)) +
labs(color = "SA Axis Rank",
x="Age",
y="Predicted between-Network Coupling") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "bottom") + coord_cartesian(expand = FALSE, xlim = c(8, 23)))
class(gam.smooths.schaefer200$SA.axis_rank)
gam.smooths.schaefer200$SA.axis_rank <- as.numeric(gam.smooths.schaefer200$SA.axis_rank)
# seems like transmodal areas have greater BNC and seem to increase with age, while unimodal areas have smaller BNC and increase or stays the same with age
(schaefer200_predBNC <- ggplot(gam.smooths.schaefer200,aes(age,fit,group=index)) +
geom_line(data = gam.smooths.schaefer200, size=.8, alpha = .6, aes(color=SA.axis_rank)) + scale_color_gradient2(low="#6f1282",high = "goldenrod1", mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank)) +
labs(color = "SA Axis Rank",
x="Age",
y="Predicted between-Network Coupling") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "bottom") + coord_cartesian(expand = FALSE, xlim = c(8, 23)))
gam.smooths.schaefer200_test <- gam.smooths.schaefer200
gam.smooths.schaefer200 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMsmoothfits.BNC.age.schaefer200x17.csv")
gam.smooths.schaefer200$orig_parcelname <- gam.smooths.schaefer200$label
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggsegExtra)
library(ggsegSchaefer)
library(ggcorrplot)
library(viridis)
library(scales)
library(stringr)
library(tidyr)
# load SNR mask
SNRmask_schaefer400 <- read.csv('/cbica/projects/network_replication/atlases/Masks/SNRmask_schaefer400x7_reordered.csv')
# load region list
schaefer400.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer400x7_ggseg_reordered.csv", header = T) #schaefer parcel names in order of surface data
names(schaefer400.parcel.labels)[2] <- "label"
schaefer400.parcel.labels[which(SNRmask_schaefer400 == 0),] <- NA # apply SNR mask to parcel names
schaefer400.parcel.labels <- na.omit(schaefer400.parcel.labels)
# load parcellated SA axis
schaefer400_SAaxis_cifti <- read_cifti("/cbica/projects/network_replication/SAaxis/SensorimotorAssociation_Axis_parcellated/SensorimotorAssociation.Axis.Schaefer400.7Networks.pscalar.nii")
schaefer400_SAaxis <- as.data.frame(cbind(rank(schaefer400_SAaxis_cifti$data), names(schaefer400_SAaxis_cifti$Parcel)))
colnames(schaefer400_SAaxis) <- c("SA.axis_rank","label")
# reorder SA axis (7 to 17)
index_schaefer400x7to17 <- read.csv("/cbica/projects/network_replication/software/schaefer7to17_reordering/index_schaefer400x7to17.csv", header=F)
index_schaefer400x7to17$V1 <- as.numeric(index_schaefer400x7to17$V1)
schaefer400_SAaxis <-schaefer400_SAaxis[index_schaefer400x7to17$V1,]
#as.matrix(cbind(schaefer400_SAaxis, schaefer400.parcel.labels))
# apply SNR mask
schaefer400_SAaxis[which(SNRmask_schaefer400 == 0),] <- NA
schaefer400_SAaxis <- na.omit(schaefer400_SAaxis)
setdiff(schaefer400_SAaxis$label, schaefer400.parcel.labels$label)
schaefer400_SAaxis$label <- schaefer400.parcel.labels$label
## GAM Results
gam.BNC.age.schaefer400 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMresults.BNC.age.schaefer400x7.csv")
gam.BNC.age.schaefer400 <- gam.BNC.age.schaefer400 %>% select(-label)
gam.BNC.age.schaefer400$label <- schaefer400_SAaxis$label
gam.smooths.schaefer400 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMsmoothfits.BNC.age.schaefer400x7.csv")
gam.smooths.schaefer400$orig_parcelname <- gam.smooths.schaefer400$label
gam.agepeaks.schaefer400 <- read.csv("/Users/audluo/cbica/projects/network_replication/BNC/GAM/GAMpeaks.BNC.age.schaefer400x7.csv")
gam.agepeaks.schaefer400 <- gam.agepeaks.schaefer400 %>% select(-label)
gam.agepeaks.schaefer400$label <- schaefer400_SAaxis$label
# Combine into Final Dfs
df.list <- list(schaefer400_SAaxis,gam.BNC.age.schaefer400)
BNC.axis <- Reduce(function(x,y) merge(x,y, all=TRUE, sort=F), df.list)
BNC.axis$SA.axis_rank <- as.numeric(BNC.axis$SA.axis_rank)
a <- merge(schaefer400.parcel.labels, schaefer400_SAaxis, by="label", sort=F)
a$label <- gsub("7Networks_", "", a$label)
gam.smooths.schaefer400 <- left_join(gam.smooths.schaefer400, a, by = "label")
gam.smooths.schaefer400$SA.axis_rank <-as.numeric(gam.smooths.schaefer400$SA.axis_rank)
gam.agepeaks.schaefer400 <- left_join(gam.agepeaks.schaefer400, schaefer400_SAaxis, by="label")
gam.agepeaks.schaefer400$SA.axis_rank <-as.numeric(gam.agepeaks.schaefer400$SA.axis_rank)
gam.smooths.schaefer400
gam.agepeaks.schaefer400
gam.smooths.schaefer400
gam.agepeaks.schaefer400
source("/cbica/projects/network_replication/software/perm.sphere.p.R")
perm.id.full <- readRDS("/cbica/projects/network_replication/software/rotate_parcellation/schaefer400x7.coords_sphericalrotations_N10k.rds")
# need to reintroduced the parcels removed by SNRmask as NA's
schaefer400.parcel.labels_noMask <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer400x7_ggseg_reordered.csv", header = T)
names(schaefer400.parcel.labels_noMask) <- c("orig_parcelname", "label")
schaefer400.parcel.labels_noMask
setdiff(BNC.axis$label, schaefer400.parcel.labels_noMask$label)
schaefer400.parcel.labels_noMask$label[which(!schaefer400.parcel.labels_noMask$label %in% BNC.axis$label)] # names of removed parcels
# need to go through parcel.labels and see which are in BNC.axis label
# then for the ones that aren't in BNC.axis$label, insert parcel.labels[row_of_missing_label] into BNC.axis, and have the rest of the row be NA
# r = the row index -- indices of SNR removed parcels
# newrow = content of inserted row -- c('name of parcel', NA, NA, NA etc)
# existingDF = BNC.axis
insertRow <- function(r, existingDF, orig.parcel.labels) {
newrow <- c(paste0(orig.parcel.labels[r]), rep(NA, 10)) # format data for spin tests by assigning NA to low SNR parcels, treating them like the medial wall
existingDF[seq(r+1,nrow(existingDF)+1),] <- existingDF[seq(r,nrow(existingDF)),]
existingDF[r,] <- newrow
existingDF
}
r <- which(!schaefer400.parcel.labels_noMask$label %in% BNC.axis$label) # indices of removed parcels
existingDF <- BNC.axis
for(i in c(1:length(r))){
existingDF <- insertRow(r[i], existingDF, schaefer400.parcel.labels_noMask$label)
}
df.dev.spin <- rbind(existingDF[1:200,], existingDF[201:400,]) #format df as left hemisphere -> right hemisphere for spin tests
df.dev.spin <- cbind(df.dev.spin, SNRmask_schaefer400)
df.dev.spin
BNC.axis$Anova.age.pvalue.fdr <- p.adjust(BNC.axis$Anova.age.pvalue, method=c("fdr"))
cat(sprintf("There are %s/%s significant parcels", sum(BNC.axis$Anova.age.pvalue.fdr < 0.05), nrow(BNC.axis)))
BNC.axis$significant.fdr <- BNC.axis$Anova.age.pvalue.fdr < 0.05
BNC.axis$significant.fdr[BNC.axis$significant.fdr == TRUE] <- 1
BNC.axis$significant.fdr[BNC.axis$significant.fdr == FALSE] <- 0
library(ggpubr)
BNC.axis <- BNC.axis %>% mutate(SA.axis_rank_signif = ifelse(significant.fdr == 1, SA.axis_rank, NA))
## SA axis average rank vs. age effect
# included all datapoints for this figure
cor.test(BNC.axis$GAM.age.AdjRsq, as.numeric(BNC.axis$SA.axis_rank), method=c("spearman"), exact=F)
r_text <- expression(paste(italic("r"), "= -0.56, ", italic(p[spin]), "< 0.0001"))
(schaefer400_SA.AgeEffect <- ggplot(BNC.axis, aes(x=SA.axis_rank, y=GAM.age.AdjRsq, fill = SA.axis_rank_signif)) + geom_point(color = "white", shape = 21, size=2) +
scale_fill_gradient2(low="#6f1282",high = "goldenrod1",, mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank), na.value="gray") +
labs(fill = "SA Axis Rank", x="\nSensorimotor-Association Axis Rank\n", y=expression(paste("Age Effect (Delta Adj", " R"^2, ")"))) +
geom_smooth(data = BNC.axis, method='lm', se=TRUE, fill=alpha(c("gray70"),.9), col="black") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "right") +
annotate(geom="text", x=290, y=0.055, label=r_text, color="black"))
# ggsave(schaefer400_SA.AgeEffect, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer400/BNC/schaefer400x7_SA.AgeEffect.pdf", width = 5, height=4, dpi=300)
gam.smooths.schaefer400$SA.axis_rank <- as.numeric(gam.smooths.schaefer400$SA.axis_rank)
# seems like transmodal areas have greater BNC and seem to increase with age, while unimodal areas have smaller BNC and increase or stays the same with age
(schaefer400_predBNC <- ggplot(gam.smooths.schaefer400,aes(age,fit,group=index)) +
geom_line(data = gam.smooths.schaefer400, size=.8, alpha = .6, aes(color=SA.axis_rank)) + scale_color_gradient2(low="#6f1282",high = "goldenrod1", mid = "#EBDAFF", midpoint = median(BNC.axis$SA.axis_rank)) +
labs(color = "SA Axis Rank",
x="Age",
y="Predicted between-Network Coupling") +
theme(
axis.title.x=element_text(size=12, color = "black"),
axis.title.y=element_text(size=12, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=12, color = "black"),
panel.background=element_blank(),
legend.position = "bottom") + coord_cartesian(expand = FALSE, xlim = c(8, 23)))
#ggsave(schaefer400_predBNC, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer400/BNC/schaefer400x7_predBNC.pdf", width = 4, height=4, dpi=300)
ggsave(schaefer400_predBNC, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer400/BNC/schaefer400x7_predBNC.pdf", width = 4, height=4, dpi=300)
(schaefer400_agepeakL <- ggplot() + geom_brain(data=left_gam.agepeaks.schaefer400,
atlas=schaefer7_400,
mapping=aes(fill=age.peak),
show.legend=TRUE,
hemi = "left") +
scale_fill_gradientn(colors = viridis_pal(option="B")(10)) + theme_void())
right_gam.agepeaks.schaefer400 <-  gam.agepeaks.schaefer400
right_gam.agepeaks.schaefer400$region<- gsub(x = gam.agepeaks.schaefer400$region, pattern = "7Networks_RH_", replacement = "")
right_gam.agepeaks.schaefer400
gam.agepeaks.schaefer400
plot(schaefer7_400) +
theme(legend.position = "bottom",
legend.text = element_text(size = 9)) +
guides(fill = guide_legend(ncol = 7))
names(gam.agepeaks.schaefer499)[2] <- "region"
names(gam.agepeaks.schaefer400)[2] <- "region"
(schaefer400_agepeak <- ggplot() + geom_brain(data=gam.agepeaks.schaefer400,
atlas=schaefer7_400,
mapping=aes(fill=age.peak),
show.legend=TRUE,
position = position_brain(hemi ~ side)) +
scale_fill_gradientn(colors = viridis_pal(option="B")(10)) + theme_void())
#ggsave(schaefer400_agepeak, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer400/BNC/schaefer400x7_agepeak.pdf", width = 6, height=4, dpi=300)
ggsave(schaefer400_agepeak, file="/cbica/projects/network_replication/adapted_Rscripts/Figures/Schaefer400/BNC/schaefer400x7_agepeak.pdf", width = 6, height=4, dpi=300)
knitr::opts_chunk$set(echo = TRUE)
library(ciftiTools)
ciftiTools.setOption('wb_path', '/Applications/workbench/')
library(gifti)
library(cifti)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggseg)
library(ggsegExtra)
library(ggsegGlasser)
library(ggsegSchaefer)
library(viridis)
require(ggplot2)
library(dplyr)
schaefer400.parcel.labels <- read.csv("/cbica/projects/network_replication/atlases/parcellations/schaefer400x7_ggseg_reordered.csv", header = T)
schaefer400.communityAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/Schaefer_7Network/schaefer400x7CommunityAffiliation.1D_reordered.csv", header=T)
schaefer400.parcel.labels <- as.data.frame(cbind(schaefer400.parcel.labels$x, schaefer400.communityAffil$x))
names(schaefer400.parcel.labels) <- c("label", "network")
#  make dataframe where rownames are the commAffil number, and then need to transpose V1 to be rows
schaefer400x7_rows <- as.data.frame(t(schaefer400.parcel.labels$network))
schaefer400x7_commAffil_mat <- as.data.frame(schaefer400x7_rows[rep(seq_len(nrow(schaefer400x7_rows)), each = 400), ])
rownames(schaefer400x7_commAffil_mat) <- NULL
SNRmask_schaefer400 <- read.csv('/cbica/projects/network_replication/atlases/Masks/SNRmask_schaefer400x7_reordered.csv')
# computeWNC(rbcid, "schaefer400", schaefer400x7_commAffil_mat, schaefer400.parcel.labels$network)
computeWNC <- function(rbcid, atlas, community_affiliation_mat, network_assignment){
#read in connectivity matrix
if(atlas == "schaefer400"){
connect.matrix <- read_cifti(sprintf("/cbica/projects/network_replication/pconn/%1$s/%1$s_ses-PNC1_task-rest_acq-singleband_space-fsLR_atlas-Schaefer417_den-91k_den-91k_bold.pconn.nii",rbcid))
mask <- SNRmask_schaefer400} #400 x 400 matrix
# set rows and columns corresponding to parcel # in mask to NA
connect.matrix$data[which(mask == 0), ] <- NA
connect.matrix$data[,which(mask == 0)] <- NA
#compute average within-network connectivity
WNC <- c()
for (i in 1:nrow(connect.matrix$data)) {
within_network_values <- c()
WNC_per_node <- c()
for (j in 1:length(connect.matrix$data[i,])) {  # entire  row
if(is.na(connect.matrix$data[i,j]) || connect.matrix$data[i,j] == 1) { # add NA if excluded by mask or identity
within_network_values <- append(within_network_values, NA);
} else if (schaefer400.parcel.labels$network[i] == schaefer400x7_commAffil_mat[i,j]) {
within_network_values <- append(within_network_values, connect.matrix$data[i,j])
} else if (schaefer400.parcel.labels$network[i] != schaefer400x7_commAffil_mat[i,j]) {
within_network_values <- append(within_network_values, NA)
}
}
#print(within_network_values)
WNC_per_node <- append(WNC_per_node, mean(within_network_values, na.rm=TRUE))
#print(WNC_per_node) # 1 value
WNC <- append(WNC, WNC_per_node)
}
return(WNC)
}
participants <- read.csv('/cbica/projects/network_replication/adapted_Rscripts/participants_allIDs.csv')
subs_no_files <- read.csv('/cbica/projects/network_replication/adapted_Rscripts/subs_no_files.csv', row.names=NULL)
subs_no_files <- subs_no_files[,2]
WNC.subxparcel.matrix.schaefer400 <- matrix(data = NA, nrow = nrow(participants), ncol = 401)
regionheaders <- as.character(schaefer400.parcel.labels$region)
demoheaders <- c("rbcid")
colheaders <- as.matrix(c(demoheaders,regionheaders))
colnames(WNC.subxparcel.matrix.schaefer400) <- colheaders
WNC.subxparcel.matrix.schaefer400
subs_no_files
WNC.subxparcel.matrix.schaefer400
regionheaders
schaefer400.parcel.labels
regionheaders <- as.character(schaefer400.parcel.labels$label)
demoheaders <- c("rbcid")
colheaders <- as.matrix(c(demoheaders,regionheaders))
colnames(WNC.subxparcel.matrix.schaefer400) <- colheaders
colheaders
#compute WNC for each subject
for(sub in c(1:nrow(participants))) {
rbcid=as.character(participants[sub,4])
if(rbcid %in% subs_no_files){
next
}
else {
rbcid.data.schaefer400 <- computeWNC(rbcid, "schaefer400", schaefer400x7_commAffil_mat, schaefer400.parcel.labels$network)
WNC.subxparcel.matrix.schaefer400[sub,] <- cbind(rbcid, t(rbcid.data.schaefer400))
print(paste(sub, rbcid, "schaefer400"))
}
}
