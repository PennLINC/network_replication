---
title: "HCPD Figures - Sensitivity Analysis"
author: "Audrey Luo"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 

library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggsegExtra)
library(ggsegSchaefer)
library(ggsegGlasser)
library(ggsegGordon)
library(ggcorrplot)
library(viridis)
library(scales)
library(stringr)
library(tidyr)
library(ggpubr)
library(purrr)
library(pammtools) 

source("/cbica/projects/network_replication/Rscripts/functions/sensitivity_analyses/DevEffect_Figures_restOnly.R")
source("/cbica/projects/network_replication/Rscripts/functions/main_analyses/netrep_spinTests.R")
source("/cbica/projects/network_replication/software/perm.sphere.p.R")
 
dataset <- "HCPD"
metric="GBC"
atlas="schaefer200"
  
 
```

 

#### load parcellated S-A axis
```{r load_SAaxis, include=FALSE}
 
schaefer200x17_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x17_SAaxis.csv") # note that schaefer200x17 parcel names are used - GBC isn't dependent on network parcellation
schaefer200x17_SAaxis$label <- gsub("17Network", "Network", schaefer200x17_SAaxis$label) 
schaefer200_SAaxis <- schaefer200x17_SAaxis 
 
```

 
 
 

#### load gam results
```{r load_gam, include=FALSE, cache=TRUE}
#GBC - loads gam.GBC.age.schaefer200

gam.GBC.age.schaefer200 <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/sensitivity_analyses/%2$s/GAM/GAMresults.%2$s.age.%3$s_covbat.csv", dataset, metric, atlas))
 
```


 
#### make figure df's - metric.axis_atlas
- makes metric.axis_atlas df's. can load these df's in following chunk.
```{r figure_dfs, include=FALSE, eval=FALSE}
# makes GBC.axis_schaefer200 
GBC.axis_schaefer200 <- combineGAMdfs(metric, atlas)
 
#add column for FDR correction
GBC.axis_schaefer200 <- sig_parcels(GBC.axis_schaefer200) 
 
# writes GBC.axis_schaefer200 
write.csv(GBC.axis_schaefer200, sprintf("/cbica/projects/network_replication/output/%1$s/sensitivity_analyses/%2$s/GAM/%3$s_covbat.csv", dataset, metric, "GBC.axis_schaefer200"))
```

#### load figure df's - metric.axis_atlas
```{r load_figureDfs, include=FALSE, cache=TRUE}
#loads GBC.axis_schaefer200 
GBC.axis_schaefer200 <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/sensitivity_analyses/%2$s/GAM/%3$s_covbat.csv", dataset, metric, "GBC.axis_schaefer200"))
```



#### Spin-based spatial permutation tests - prepping dataframes
```{r prep_pspindfs, include=FALSE, cache=TRUE}
#Load Spin Test Parcel Rotation Matrix
perm.id.full_schaefer200x17 <- readRDS(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/%1$s.coords_sphericalrotations_N10k.rds", "schaefer200x17")) 
 
# make df.dev.spin_GBC_schaefer200
df.dev.spin_GBC_schaefer200 <- prepDfSpin(atlas, metric)
 
```
 


 

 
#### Correlations and Spin-based spatial permutation tests
- executes spin test and saves out p-spin values. Can load values in the next chunk.
```{r cor_test, include=FALSE, eval=FALSE}
# get correlation: corr.GBC_schaefer200 
corr.GBC_schaefer200 <- cor.test(GBC.axis_schaefer200$GAM.age.AdjRsq, as.numeric(GBC.axis_schaefer200$SA.axis_rank), method=c("spearman"), exact=F)$estimate
 
spearman_rho <- corr.GBC_schaefer200
 
write.csv(spearman_rho, "/cbica/projects/network_replication/output/HCPD/sensitivity_analyses/spearman_rho.csv")

# spin permutation test:
p_spin_schaefer200 <- perm.sphere.p(as.numeric(df.dev.spin_GBC_schaefer200$GAM.age.AdjRsq), as.numeric(df.dev.spin_GBC_schaefer200$SA.axis_rank), perm.id.full_schaefer200x17, corr.type='spearman')
 
saveRDS(p_spin_schaefer200, "/cbica/projects/network_replication/output/HCPD/sensitivity_analyses/pspin_vals.RData")
 
```
 
### DevEffect with p_spin: 
this section requires manual input since expression() doesn't take variables :( 
```{r make_figures_pspin, include=FALSE}
spearman_rho <- read.csv("/cbica/projects/network_replication/output/HCPD/sensitivity_analyses/spearman_rho.csv")
pspin_vals <- readRDS("/cbica/projects/network_replication/output/HCPD/sensitivity_analyses/pspin_vals.RData")

 
#GBC 
r_text_GBC.schaefer200 <- expression(paste(italic("r"), "= -0.63, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200 <- gam_figure_p.spin(GBC.axis_schaefer200, "GBC", "Schaefer200", r_text_GBC.schaefer200, x_pos= 150, y_pos=0.08))
 
```
 
#### **Figure**: GBC DevEffect 
```{r Fig1, fig.height= 8, fig.width= 10, warning=FALSE, cache=TRUE}
 
GBC_schaefer200
 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Supplementary/FigS3_GBCAgeEffect_HCPD.pdf", dpi=300, width = 5, height = 5)

```

  

### DevTraj Centered
#### load gam.smooths
```{r load.gam.smooths, include=FALSE, cache=TRUE}
gam.smooths.schaefer200.GBC <- make_gam.smooths_covbat(metric, atlas, dataset)
```

#### make devTraj df
- makes df for trajectories. Can load the output in following chunk.
```{r make_devTraj_centered, include=FALSE}
devTraj.centered.schaefer200.GBC <-  make_gam.smooths_centered_covbat(metric, atlas, dataset)
```
#### load devTraj df
```{r load_devTraj_centered.dfs, include=FALSE, cache=TRUE}
devTraj.centered.schaefer200.GBC_df <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/sensitivity_analyses/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered_covbat.csv", dataset, metric, atlas))
```
#### make dev traj figures
```{r make_Dev.Trajectory.Figures, include=FALSE}
devTraj.centered.GBC <- make_smooths_fig_centered(atlas, metric)
```

#### **Figure**: GBC Dev Trajectory  
```{r Fig7, fig.height= 10, fig.width= 12, warning=FALSE}

devTraj.centered.GBC
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Supplementary/FigS3_GBCDevTraj_HCPD.pdf", dpi=300, width = 5, height = 5)

```

