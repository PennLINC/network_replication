---
title: "HCPD Figures"
author: "Audrey Luo"
date: "2022-08-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 

library(dplyr)
require(ggplot2)
library(cowplot)
library(cifti)
library(ggseg)
Sys.setenv(RGL_USE_NULL=TRUE)
library(ggsegExtra)
library(ggsegSchaefer)
library(ggsegGlasser)
library(ggsegGordon)
library(ggcorrplot)
library(viridis)
library(scales)
library(stringr)
library(tidyr)
library(ggpubr)
library(purrr)
library(pammtools)


source("/cbica/projects/network_replication/adapted_Rscripts/DevEffect_Figures.R")
source("/cbica/projects/network_replication/adapted_Rscripts/netrep_spinTests.R")
source("/cbica/projects/network_replication/software/perm.sphere.p.R")

atlases_GBC <- c("glasser", "gordon", "schaefer200", "schaefer400")
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
dataset <- "HCPD"
  
  
 
```

 

#### load parcellated S-A axis
```{r load_SAaxis, include=FALSE}

glasser_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/glasser_SAaxis.csv")
gordon_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/gordon_SAaxis.csv")

schaefer200x7_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x7_SAaxis.csv")
schaefer200x7_SAaxis$label <- gsub("7Network", "Network", schaefer200x7_SAaxis$label) 

schaefer200x17_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x17_SAaxis.csv")
schaefer200x17_SAaxis$label <- gsub("17Network", "Network", schaefer200x17_SAaxis$label) 
schaefer200_SAaxis <- schaefer200x17_SAaxis 

schaefer400x7_SAaxis  <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer400x7_SAaxis.csv")
schaefer400x7_SAaxis$label <-  gsub("7Networks", "Networks", schaefer400x7_SAaxis$label)

schaefer400x17_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer400x17_SAaxis.csv")
schaefer400x17_SAaxis$label <- gsub("17Network", "Network", schaefer400x17_SAaxis$label)
schaefer400_SAaxis <- schaefer400x17_SAaxis
```

 
 
 

#### load gam results
```{r load_gam, include=FALSE, cache=TRUE}
#GBC - loads gam.GBC.age.glasser, gam.GBC.age.gordon, gam.GBC.age.schaefer200, gam.GBC.age.schaefer400

metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.", metric, ".", "age.", atlases_GBC[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s_covbat.csv", dataset, metric, atlases_GBC[i])))
  assign(df_name, get(df_name) %>% select(-label))
  if(str_detect(atlases_GBC[i], "schaefer")) {
  SAaxis <- get(paste0(atlases_GBC[i], "x17_", "SAaxis"))
  } else {
  SAaxis <- get(paste0(atlases_GBC[i], "_", "SAaxis"))
  }
  df_to.label <- get(df_name)
  df_to.label$label <- SAaxis$label
  assign(df_name, df_to.label)
} 
 
 
#BNC - loads gam.BNC.age.gordon, gam.BNC.age.schaefer200x7, gam.BNC.age.schaefer400x7, gam.BNC.age.schaefer200x17, gam.BNC.age.schaefer400x17

metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".", "age.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s_covbat.csv", dataset, metric, atlases[i])))
  assign(df_name, get(df_name) %>% select(-label))
  SAaxis <- get(paste0(atlases[i], "_", "SAaxis"))
  df_to.label <- get(df_name)
  df_to.label$label <- SAaxis$label
  assign(df_name, df_to.label)
} 
 

  
#WNC - loads gam.WNC.age.gordon, gam.WNC.age.schaefer200x7, gam.WNC.age.schaefer400x7, gam.WNC.age.schaefer200x17, gam.WNC.age.schaefer400x17
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".", "age.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s_covbat.csv", dataset, metric, atlases[i])))
  assign(df_name, get(df_name) %>% select(-label))
  SAaxis <- get(paste0(atlases[i], "_", "SAaxis"))
  df_to.label <- get(df_name)
  df_to.label$label <- SAaxis$label
  assign(df_name, df_to.label)
} 
 
```



#### load GAM derivatives output
```{r load_gam_derivatives, include=FALSE, cache=TRUE}

#GBC - loads gam.GBC.derivatives.glasser, gam.GBC.derivatives.gordon, gam.GBC.derivatives.schaefer200, gam.GBC.derivatives.schaefer400

metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  filename <- paste0("gam.", metric, ".derivatives.", atlases_GBC[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename)))
  print(filename)
} 
  
            
#BNC - loads gam.BNC.derivatives.gordon, gam.BNC.derivatives.schaefer200x7, gam.BNC.derivatives.schaefer400x7, gam.BNC.derivatives.schaefer200x17, gam.BNC.derivatives.schaefer400x17

metric = "BNC"
for(i in c(1:length(atlases))){
  filename <- paste0("gam.", metric, ".derivatives.", atlases[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename)))
  print(filename)
} 
 

  
#WNC - loads gam.WNC.derivatives.gordon, gam.WNC.derivatives.schaefer200x7, gam.WNC.derivatives.schaefer400x7, gam.WNC.derivatives.schaefer200x17, gam.WNC.derivatives.schaefer400x17
metric = "WNC"
for(i in c(1:length(atlases))){
  filename <- paste0("gam.", metric, ".derivatives.", atlases[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename)))
  print(filename)
} 
```


#### make figure df's - metric.axis_atlas
- makes metric.axis_atlas df's. can load these df's in following chunk.
```{r figure_dfs, include=FALSE, eval=FALSE}
# GBC - makes GBC.axis_glasser, GBC.axis_gordon, GBC.axis_schaefer200, GBC.axis_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0(metric, ".axis_", atlases_GBC[i])
  assign(df_name, combineGAMdfs(metric, atlases_GBC[i]))
  print(df_name)
} 

  
# BNC - makes BNC.axis_gordon, BNC.axis_schaefer200x7, BNC.axis_schaefer200x17, BNC.axis_schaefer400x7, BNC.axis_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  assign(df_name, combineGAMdfs(metric, atlases[i]))
  print(df_name)
} 

 
# WNC - makes WNC.axis_gordon, WNC.axis_schaefer200x7, WNC.axis_schaefer200x17, WNC.axis_schaefer400x7, WNC.axis_schaefer400x17 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  assign(df_name, combineGAMdfs(metric, atlases[i]))
  print(df_name)
} 
 

#add column for FDR correction
# GBC
GBC.axis_glasser <- sig_parcels(GBC.axis_glasser)   
GBC.axis_gordon <- sig_parcels(GBC.axis_gordon) 
GBC.axis_schaefer200 <- sig_parcels(GBC.axis_schaefer200) 
GBC.axis_schaefer400 <- sig_parcels(GBC.axis_schaefer400) 

# BNC
BNC.axis_gordon <- sig_parcels(BNC.axis_gordon)
BNC.axis_schaefer200x7 <- sig_parcels(BNC.axis_schaefer200x7)
BNC.axis_schaefer200x17 <- sig_parcels(BNC.axis_schaefer200x17)
BNC.axis_schaefer400x7 <- sig_parcels(BNC.axis_schaefer400x7)
BNC.axis_schaefer400x17 <- sig_parcels(BNC.axis_schaefer400x17)

# WNC
WNC.axis_gordon <- sig_parcels(WNC.axis_gordon)
WNC.axis_schaefer200x7 <- sig_parcels(WNC.axis_schaefer200x7)
WNC.axis_schaefer200x17 <- sig_parcels(WNC.axis_schaefer200x17)
WNC.axis_schaefer400x7 <- sig_parcels(WNC.axis_schaefer400x7)
WNC.axis_schaefer400x17 <- sig_parcels(WNC.axis_schaefer400x17)

# GBC - writes GBC.axis_glasser, GBC.axis_gordon, GBC.axis_schaefer200, GBC.axis_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0(metric, ".axis_", atlases_GBC[i])
  filename <- paste0(df_name)
  #write.csv(get(filename), sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename))
  print(df_name)
} 

  
# BNC - writes BNC.axis_gordon, BNC.axis_schaefer200x7, BNC.axis_schaefer200x17, BNC.axis_schaefer400x7, BNC.axis_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  filename <- paste0(df_name)
  #write.csv(get(filename), sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename))
  print(df_name)
} 

 
# WNC - writes WNC.axis_gordon, WNC.axis_schaefer200x7, WNC.axis_schaefer200x17, WNC.axis_schaefer400x7, WNC.axis_schaefer400x17 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0(metric, ".axis_", atlases[i])
  filename <- paste0(df_name)
  #write.csv(get(filename), sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename))
  print(df_name)
} 

 
```

#### load figure df's - metric.axis_atlas
```{r load_figureDfs, include=FALSE, cache=TRUE}

#GBC - loads GBC.axis_glasser, GBC.axis_gordon, GBC.axis_schaefer200, GBC.axis_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  filename <- paste0(metric, ".axis_", atlases_GBC[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename)))
  print(filename)
} 
  
           
#BNC - loads BNC.axis_gordon, BNC.axis_schaefer200x7, BNC.axis_schaefer200x17, BNC.axis_schaefer400x7, BNC.axis_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  filename <- paste0(metric, ".axis_", atlases[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename)))
  print(filename)
} 
  
  
#WNC - loads WNC.axis_gordon, WNC.axis_schaefer200x7, WNC.axis_schaefer200x17, WNC.axis_schaefer400x7, WNC.axis_schaefer400x17
metric = "WNC"
for(i in c(1:length(atlases))){
  filename <- paste0(metric, ".axis_", atlases[i])
  assign(filename, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, filename)))
  print(filename)
} 

```



#### Spin-based spatial permutation tests - prepping dataframes
```{r prep_pspindfs, include=FALSE, cache=TRUE}
#Load Spin Test Parcel Rotation Matrix

all_atlases <- c("glasser", "gordon","schaefer200x7","schaefer200x17", "schaefer400x7","schaefer400x17")

# parcel rotation matrices: perm.id.full_glasser, perm.id.full_gordon, perm.id.full_schaefer200x7, perm.id.full_schaefer200x17, perm.id.full_schaefer400x7, perm.id.full_schaefer400x17 
for(i in c(1:length(all_atlases))){
  df_name <- paste0("perm.id.full", "_", all_atlases[i])
  assign(df_name, readRDS(sprintf("/cbica/projects/network_replication/software/rotate_parcellation/%1$s.coords_sphericalrotations_N10k.rds", all_atlases[i])))
  print(paste(df_name, "made"))
} 

 
# GBC - making df.dev.spin_GBC_glasser, df.dev.spin_GBC_gordon, df.dev.spin_GBC_schaefer200, df.dev.spin_GBC_schaefer400 
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("df.dev.spin_", metric, "_", atlases_GBC[i])
  assign(df_name, prepDfSpin(atlases_GBC[i], metric))
  print(paste(df_name, "made"))
} 

 
 

# BNC - making df.dev.spin_BNC_gordon, df.dev.spin_BNC_schaefer200x7, df.dev.spin_BNC_schaefer200x17, df.dev.spin_BNC_schaefer400x7, df.dev.spin_BNC_schaefer400x17 
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("df.dev.spin_", metric, "_", atlases[i])
  assign(df_name, prepDfSpin(atlases[i], metric))
  print(paste(df_name, "made"))
} 

# WNC - making df.dev.spin_WNC_gordon, df.dev.spin_WNC_schaefer200x7, df.dev.spin_WNC_schaefer200x17, df.dev.spin_WNC_schaefer400x7, df.dev.spin_WNC_schaefer400x17 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("df.dev.spin_", metric, "_", atlases[i])
  assign(df_name, prepDfSpin(atlases[i], metric))
  print(paste(df_name, "made"))
} 
```
 


 


### Surface View of Age Effect
```{r plot.surface_ageEffect, warning=FALSE, cache=TRUE, include=FALSE}
 

#GBC
ageEffect_GBC.fig <- lapply(atlases_GBC, ageEffect_surf_figure, "GBC")
names(ageEffect_GBC.fig) <- atlases_GBC

#BNC
ageEffect_BNC.fig <- lapply(atlases, ageEffect_surf_figure, "BNC")
names(ageEffect_BNC.fig) <- atlases

#WNC
ageEffect_WNC.fig <- lapply(atlases, ageEffect_surf_figure, "WNC")
names(ageEffect_WNC.fig) <- atlases
```


#### **Figure**: GBC AgeEffect - Surface
```{r Fig.surface_ageEffect_GBC,fig.height= 10, fig.width= 12, warning=FALSE, cache=TRUE}

plot_grid(ageEffect_GBC.fig$gordon, ageEffect_GBC.fig$schaefer200, ageEffect_GBC.fig$glasser,ageEffect_GBC.fig$schaefer400,labels = "AUTO")

```

#### **Figure**: BNC AgeEffect - Surface
```{r Fig.surface_ageEffect_BNC,fig.height= 10, fig.width= 12, warning=FALSE, cache=TRUE}
plot_grid(ageEffect_BNC.fig$gordon, ageEffect_BNC.fig$schaefer200x7, ageEffect_BNC.fig$schaefer200x17, ageEffect_BNC.fig$schaefer400x7, ageEffect_BNC.fig$schaefer400x17, labels = "AUTO")

```

#### **Figure**: WNC AgeEffect - Surface
```{r Fig.surface_ageEffect_WNC,fig.height= 10, fig.width= 12, warning=FALSE, cache=TRUE}
plot_grid(ageEffect_WNC.fig$gordon, ageEffect_WNC.fig$schaefer200x7, ageEffect_WNC.fig$schaefer200x17, ageEffect_WNC.fig$schaefer400x7, ageEffect_WNC.fig$schaefer400x17, labels = "AUTO")

```


#### Correlations and Spin-based spatial permutation tests
- executes spin test and saves out p-spin values. Can load values in the next chunk.
```{r cor_test, include=FALSE, eval=FALSE}
# GBC - making corr.GBC_glasser, corr.GBC_gordon, corr.GBC_schaefer200, corr.GBC_schaefer400  
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("corr.", metric, "_", atlases_GBC[i])
  axis <- get(paste0(metric, ".axis_", atlases_GBC[i]))
  assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
  print(paste(df_name, "made"))
} 
 

# BNC - making corr.BNC_gordon, corr.BNC_schaefer200x7, corr.BNC_schaefer400x7, corr.BNC_schaefer200x17, corr.BNC_schaefer400x17  
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("corr.", metric, "_", atlases[i])
  axis <- get(paste0(metric, ".axis_", atlases[i]))
  assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
  print(paste(df_name, "made"))
} 

# WNC - making corr.WNC_gordon, corr.WNC_schaefer200x7, corr.WNC_schaefer400x7, corr.WNC_schaefer200x17, corr.WNC_schaefer400x17  
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("corr.", metric, "_", atlases[i])
  axis <- get(paste0(metric, ".axis_", atlases[i]))
  assign(df_name, cor.test(axis$GAM.age.AdjRsq, as.numeric(axis$SA.axis_rank), method=c("spearman"), exact=F)$estimate)
  print(paste(df_name, "made"))
} 

spearman_rho <- data.frame(cbind(corr.GBC_glasser, corr.GBC_gordon, corr.GBC_schaefer200, corr.GBC_schaefer400, corr.BNC_gordon, corr.BNC_schaefer200x7, corr.BNC_schaefer400x7, corr.BNC_schaefer200x17, corr.BNC_schaefer400x17, corr.WNC_gordon, corr.WNC_schaefer200x7, corr.WNC_schaefer400x7, corr.WNC_schaefer200x17, corr.WNC_schaefer400x17))
write.csv(spearman_rho, "/cbica/projects/network_replication/output/HCPD/spearman_rho_covbat.csv")

# spin permutation tests:
metric = "GBC"
p_spin_GBC <- c()
for(i in c(1:length(atlases_GBC))){
  df.dev.spin <- get(paste0("df.dev.spin_", metric, "_", atlases_GBC[i]))
  if(str_detect(atlases_GBC[i], "schaefer")) {
  perm.id.full <- get(paste0("perm.id.full_", atlases_GBC[i], "x17"))
  } else {
  perm.id.full <- get(paste0("perm.id.full_", atlases_GBC[i]))
  }
  p_spin_atlas <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full, corr.type='spearman')
  p_spin_GBC <- append(p_spin_GBC, p_spin_atlas)
  print(paste(atlases_GBC[i], p_spin_atlas))
} 
p_spin_GBC <- data.frame(cbind(atlases_GBC, p_spin_GBC))


metric = "BNC"
p_spin_BNC <- c()
for(i in c(1:length(atlases))){
  df.dev.spin <- get(paste0("df.dev.spin_", metric, "_", atlases[i]))
  perm.id.full <- get(paste0("perm.id.full_", atlases[i]))
  p_spin_atlas <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full, corr.type='spearman')
  p_spin_BNC <- append(p_spin_BNC, p_spin_atlas)
  print(paste(atlases[i], p_spin_atlas))
} 
p_spin_BNC <- data.frame(cbind(atlases, p_spin_BNC))

metric = "WNC"
p_spin_WNC <- c()
for(i in c(1:length(atlases))){
  df.dev.spin <- get(paste0("df.dev.spin_", metric, "_", atlases[i]))
  perm.id.full <- get(paste0("perm.id.full_", atlases[i]))
  p_spin_atlas <- perm.sphere.p(as.numeric(df.dev.spin$GAM.age.AdjRsq), as.numeric(df.dev.spin$SA.axis_rank), perm.id.full, corr.type='spearman')
  p_spin_WNC <- append(p_spin_WNC, p_spin_atlas)
  print(paste(atlases[i], p_spin_atlas))
} 
p_spin_WNC <- data.frame(cbind(atlases, p_spin_WNC))
 
p_spin_WNC$p_spin_WNC = as.numeric(p_spin_WNC$p_spin_WNC)
p_spin_GBC$p_spin_GBC = as.numeric(p_spin_GBC$p_spin_GBC)
names(p_spin_GBC)[1] <- "atlases"
p_spin_BNC$p_spin_BNC = as.numeric(p_spin_BNC$p_spin_BNC)

saveRDS(list(p_spin_GBC, p_spin_BNC, p_spin_WNC), "/cbica/projects/network_replication/output/HCPD/pspin_vals_covbat.RData")
```


```{r}

t(spearman_rho)
pspin_vals
```

### DevEffect with p_spin: 
this section requires manual input since expression() doesn't take variables :( 
```{r make_figures_pspin, include=FALSE}
spearman_rho <- read.csv("/cbica/projects/network_replication/output/HCPD/spearman_rho_covbat.csv")
pspin_vals <- readRDS("/cbica/projects/network_replication/output/HCPD/pspin_vals_covbat.RData")

 
#GBC
#list(p_spin_GBC, p_spin_BNC, p_spin_WNC)
 
r_text_GBC.glasser <- expression(paste(italic("r"), " = -0.52, ",  , italic(p[spin]), "< 0.0001")) 
(GBC_glasser <- gam_figure_p.spin(GBC.axis_glasser, "GBC", "Glasser", r_text_GBC.glasser,x_pos= 270, y_pos=0.12))

r_text_GBC.gordon <- expression(paste(italic("r"), "= -0.55, ",  , italic(p[spin]), "< 0.0001"))
(GBC_gordon <- gam_figure_p.spin(GBC.axis_gordon, "GBC", "Gordon", r_text_GBC.gordon, x_pos= 270, y_pos=0.12))

r_text_GBC.schaefer200 <- expression(paste(italic("r"), "= -0.67, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200 <- gam_figure_p.spin(GBC.axis_schaefer200, "GBC", "Schaefer200", r_text_GBC.schaefer200, x_pos= 150, y_pos=0.12))

r_text_GBC.schaefer400 <- expression(paste(italic("r"), "= -0.67, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer400 <- gam_figure_p.spin(GBC.axis_schaefer400, "GBC", "Schaefer400", r_text_GBC.schaefer400, x_pos= 260, y_pos=0.12))
 
 
 
#BNC
 
r_text_BNC.gordon <- expression(paste(italic("r"), "= -0.56, ",  , italic(p[spin]), "< 0.0001"))
(BNC_gordon <- gam_figure_p.spin(BNC.axis_gordon, "BNC", "Gordon", r_text_BNC.gordon, x_pos= 270, y_pos=0.12))

r_text_BNC.schaefer200x7 <- expression(paste(italic("r"), "= -0.61, ",  , italic(p[spin]), "< 0.0001"))
(BNC_schaefer200x7 <- gam_figure_p.spin(BNC.axis_schaefer200x7, "BNC", "schaefer200x7", r_text_BNC.schaefer200x7, x_pos= 150, y_pos=0.1))

r_text_BNC.schaefer200x17 <- expression(paste(italic("r"), "= -0.67, ",  , italic(p[spin]), "< 0.0001"))
(BNC_schaefer200x17 <- gam_figure_p.spin(BNC.axis_schaefer200x17, "BNC", "schaefer200x17", r_text_BNC.schaefer200x17, x_pos= 160, y_pos=0.1))

r_text_BNC.schaefer400x7 <- expression(paste(italic("r"), "= -0.61, ",  , italic(p[spin]), "< 0.0001"))
(BNC_schaefer400x7 <- gam_figure_p.spin(BNC.axis_schaefer400x7, "BNC", "schaefer400x7", r_text_BNC.schaefer400x7, x_pos= 260, y_pos=0.1))

r_text_BNC.schaefer400x17 <- expression(paste(italic("r"), "= -0.68, ",  , italic(p[spin]), "< 0.0001"))
(BNC_schaefer400x17 <- gam_figure_p.spin(BNC.axis_schaefer400x17, "BNC", "schaefer400x17", r_text_BNC.schaefer400x17, x_pos= 260, y_pos=0.1))
 

#WNC
 
r_text_WNC.gordon <- expression(paste(italic("r"), "= -0.12, ",  , italic(p[spin]), "= N.S"))
(WNC_gordon <- gam_figure_p.spin(WNC.axis_gordon, "WNC", "Gordon", r_text_WNC.gordon, x_pos= 270, y_pos=0.12))

r_text_WNC.schaefer200x7 <- expression(paste(italic("r"), "= -0.27, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer200x7 <- gam_figure_p.spin(WNC.axis_schaefer200x7, "WNC", "schaefer200x7", r_text_WNC.schaefer200x7, x_pos= 150, y_pos=0.1))

r_text_WNC.schaefer200x17 <- expression(paste(italic("r"), "= -0.16, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer200x17 <- gam_figure_p.spin(WNC.axis_schaefer200x17, "WNC", "schaefer200x17", r_text_WNC.schaefer200x17, x_pos= 160, y_pos=0.1))

r_text_WNC.schaefer400x7 <- expression(paste(italic("r"), "= -0.28, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer400x7 <- gam_figure_p.spin(WNC.axis_schaefer400x7, "WNC", "schaefer400x7", r_text_WNC.schaefer400x7, x_pos= 260, y_pos=0.1))

r_text_WNC.schaefer400x17 <- expression(paste(italic("r"), "= -0.12, ",  , italic(p[spin]), "= N.S."))
(WNC_schaefer400x17 <- gam_figure_p.spin(WNC.axis_schaefer400x17, "WNC", "schaefer400x17", r_text_WNC.schaefer400x17, x_pos= 260, y_pos=0.1))
 
 
```
 
#### **Figure**: GBC DevEffect 
```{r Fig1, fig.height= 8, fig.width= 10, warning=FALSE, cache=TRUE}

plot_grid(GBC_glasser, GBC_gordon, GBC_schaefer200, GBC_schaefer400, labels = "AUTO")

GBC_schaefer200
#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Figures/OHBM_2023/GBC_schaefer200_HCPD.svg", dpi=300, width = 5, height = 4)
#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_GBCAgeEffect_Covbat.pdf", dpi=300, width = 5, height = 4)
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig4_New/Fig4_GBCAgeEffect_HCPD_Covbat.pdf", dpi=300, width = 5, height = 5)
```



#### **Figure**: BNC DevEffect  
```{r Fig2, fig.height= 8, fig.width= 16, warning=FALSE, cache=TRUE}

plot_grid(BNC_gordon, BNC_schaefer200x7, BNC_schaefer200x17, BNC_schaefer400x7, BNC_schaefer400x17, labels = "AUTO")
 

BNC_schaefer200x7
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/BNC_schaefer200x17.svg", dpi=300)

#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_BNCAgeEffect_Covbat.pdf", dpi=300, width = 5, height = 4)


ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig5_New/Fig5_BNCAgeEffect_HCPD_covbat.pdf", dpi=300, width = 6, height = 5)

```



#### **Figure**: WNC DevEffect  
```{r Fig3, fig.height= 8, fig.width= 16, warning=FALSE, cache=TRUE}

plot_grid(WNC_gordon, WNC_schaefer200x7, WNC_schaefer200x17, WNC_schaefer400x7, WNC_schaefer400x17, labels = "AUTO")
 
WNC_schaefer200x7
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/WNC_schaefer200x17.svg", dpi=300)
#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_WNCAgeEffect_Covbat.pdf", dpi=300, width = 5, height = 4)

ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig5_New/Fig5_WNCAgeEffect_HCPD_covbat.pdf", dpi=300, width = 6, height = 5)

```



For Ted - HHMI
```{r}
 
r_text_GBC.schaefer200 <- expression(paste(italic("r"), "= -0.67, ",  , italic(p[spin]), "< 0.0001"))
(GBC_schaefer200 <- gam_figure_p.spin_Val(GBC.axis_schaefer200, "GBC", "Schaefer200", r_text_GBC.schaefer200, x_pos= 150, y_pos=0.12))


GBC_schaefer200
#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Figures/OHBM_2023/GBC_schaefer200_HCPD.svg", dpi=300, width = 5, height = 4)
#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_GBCAgeEffect_Covbat.pdf", dpi=300, width = 5, height = 4)
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig4_GBCAgeEffect_HCPD_Covbat.pdf", dpi=300, width = 5, height = 5)
```


#####not main figure - Correlation between Age Effect of BNC vs. WNC
```{r BNC_WNC.fig, include=FALSE, eval=FALSE}

#need to clean this code
cor.test(BNC.axis_gordon$GAM.age.AdjRsq, WNC.axis_gordon$GAM.age.AdjRsq)
nrow(BNC.axis_gordon)/3

ordered_BNC.axis_gordon <- BNC.axis_gordon[order(BNC.axis_gordon$SA.axis_rank),]
ordered_BNC.axis <- ordered_BNC.axis_gordon

ordered_WNC.axis_gordon <- WNC.axis_gordon[order(WNC.axis_gordon$SA.axis_rank),]
ordered_WNC.axis <- ordered_WNC.axis_gordon
 
sensorimotor <- c(1:round(nrow(ordered_BNC.axis_gordon)/3)) 
visual <- which(str_detect(ordered_BNC.axis_gordon$label, "Visual"))
SM <- which(str_detect(ordered_BNC.axis_gordon$label, "SM"))
auditory <- which(str_detect(ordered_BNC.axis_gordon$label, "Auditory"))
 


ordered_BNC.axis_sensorimotor <- ordered_BNC.axis[c(sensorimotor),] # range SA rank: 1-101
ordered_BNC.axis_SM <- ordered_BNC.axis[c(SM),] # range SA rank: 1-107
ordered_BNC.axis_visual <- ordered_BNC.axis[c(visual),]# range SA rank: 2-149
ordered_BNC.axis_auditory <- ordered_BNC.axis[c(auditory),] # range SA rank: 57-170

ordered_WNC.axis_sensorimotor <- ordered_WNC.axis[c(sensorimotor),] # range SA rank: 1-101
ordered_WNC.axis <- ordered_WNC.axis[order(ordered_WNC.axis$SA.axis_rank),]
ordered_WNC.axis_SM <- ordered_WNC.axis[c(SM),] # range SA rank: 1-107
ordered_WNC.axis_visual <- ordered_WNC.axis[c(visual),]# range SA rank: 2-149
ordered_WNC.axis_auditory <- ordered_WNC.axis[c(auditory),] # range SA rank: 57-170

atlas.BNC_WNC <- data.frame(cbind(ordered_BNC.axis_sensorimotor$label, ordered_BNC.axis_sensorimotor$SA.axis_rank, ordered_BNC.axis_gordon_sensorimotor$GAM.age.AdjRsq, ordered_WNC.axis_gordon_sensorimotor$GAM.age.AdjRsq))
names(atlas.BNC_WNC) <- c("label", "SA.axis_rank", "GAM.age.AdjRsq_BNC", "GAM.age.AdjRsq_WNC")
atlas.BNC_WNC$GAM.age.AdjRsq_BNC <- as.numeric(atlas.BNC_WNC$GAM.age.AdjRsq_BNC)
atlas.BNC_WNC$GAM.age.AdjRsq_WNC <- as.numeric(atlas.BNC_WNC$GAM.age.AdjRsq_WNC)
atlas.BNC_WNC$SA.axis_rank <- as.integer(atlas.BNC_WNC$SA.axis_rank)


cor.test(ordered_BNC.axis_gordon$GAM.age.AdjRsq, ordered_WNC.axis_gordon$GAM.age.AdjRsq)

# so sensorimotor regions have a moderate positive correlation between the age effect of BNC and WNC, suggesting that the parcels that increase in BNC also tend to increase in WNC. but association regions have no significant correlation between the two (i.e. r= 0.1, p=N.S.). 
cor.test(BNC.axis_gordon$GAM.age.AdjRsq, WNC.axis_gordon$GAM.age.AdjRsq)

cor.test(BNC.axis_gordon$GAM.age.AdjRsq, WNC.axis_gordon$GAM.age.AdjRsq)


(AgeEffect_figure <- ggplot(atlas.BNC_WNC, aes(x=GAM.age.AdjRsq_WNC, y=GAM.age.AdjRsq_BNC, fill = SA.axis_rank)) + 
    geom_point(color = "gray", shape = 21, size=3.5) + 
    scale_fill_gradient2(low="#006CA5FF",high = "#A0CEB6FF", mid = "#009BA8FF", midpoint = median(atlas.BNC_WNC$SA.axis_rank)) +
      labs(fill = "SA Axis Rank", x="Age Effect of WNC", y="Age Effect of BNC") +
      ggtitle("Age Effect of BNC vs. WNC") + 
      geom_smooth(data = atlas.BNC_WNC, method='lm', se=TRUE, fill=alpha(c("gray70"),.9), col="black") +
      theme(
        axis.title.x=element_text(size=12, color = "black"),
        axis.title.y=element_text(size=12, color = "black"),
        axis.line = element_line(color = "black"),
        axis.text=element_text(size=12, color = "black"),
        panel.background=element_blank(),
        legend.position = "right") + 
    stat_cor(method = "pearson",size = 5))
```



### DevTraj Centered
#### load gam.smooths
```{r load.gam.smooths, include=FALSE, cache=TRUE}
 
# GBC - makes gam.smooths.glasser.GBC, gam.smooths.gordon.GBC, gam.smooths.schaefer200.GBC, gam.smooths.schaefer400.GBC  
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.smooths.", atlases_GBC[i], ".", metric)
  assign(df_name, make_gam.smooths_covbat(metric, atlases_GBC[i], dataset))
  print(df_name)
} 

 
# BNC - makes gam.smooths.gordon.BNC, gam.smooths.schaefer200x7.BNC, gam.smooths.schaefer200x17.BNC, gam.smooths.schaefer400x7.BNC   
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.smooths.", atlases[i], ".", metric)
  assign(df_name, make_gam.smooths_covbat(metric, atlases[i], dataset))
  print(df_name)
} 
 
# WNC - makes gam.smooths.gordon.WNC, gam.smooths.schaefer200x7.WNC, gam.smooths.schaefer200x17.WNC, gam.smooths.schaefer400x7.WNC, gam.smooths.schaefer400x17.WNC  
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.smooths.", atlases[i], ".", metric)
  assign(df_name, make_gam.smooths_covbat(metric, atlases[i], dataset))
  print(df_name)
} 
   
```

#### make devTraj df
- makes df for trajectories. Can load the output in following chunk.
```{r make_devTraj_centered, include=FALSE, eval=FALSE}
 
# GBC - makes devTraj.centered.glasser.GBC, devTraj.centered.gordon.GBC, devTraj.centered.schaefer200.GBC, devTraj.schaefer400.GBC    
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("devTraj.centered.", atlases_GBC[i], ".", metric, "_df")
  assign(df_name, make_gam.smooths_centered_covbat(metric, atlases_GBC[i], dataset)) #commenting out to prevent make_gam.smooths_centered from making new csv's each time you run code
  print(df_name)
} 

  
 
# BNC - makes devTraj.centered.gordon.BNC, devTraj.centered.schaefer200x7.BNC, devTraj.centered.schaefer200x17.BNC, devTraj.centered.schaefer400x7.BNC, devTraj.centered.schaefer400x17.BNC   
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("devTraj.centered.", atlases[i], ".", metric, "_df")
  assign(df_name, make_gam.smooths_centered_covbat(metric, atlases[i], dataset)) #commenting out to prevent make_gam.smooths_centered from making new csv's each run
  print(df_name)
} 
 
# WNC - makes devTraj.centered.gordon.WNC, devTraj.centered.schaefer200x7.WNC, devTraj.centered.schaefer200x17.WNC, devTraj.centered.schaefer400x7.WNC, devTraj.centered.schaefer400x17.WNC 
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("devTraj.centered.", atlases[i], ".", metric, "_df")
  assign(df_name, make_gam.smooths_centered_covbat(metric, atlases[i], dataset)) #commenting out to prevent make_gam.smooths_centered from making new csv's each run
  print(df_name)
} 
  
```
#### load devTraj df
```{r load_devTraj_centered.dfs, include=FALSE, cache=TRUE}

# makes devTraj.centered.glasser.GBC_df, devTraj.centered.gordon.GBC_df, devTraj.centered.schaefer200.GBC_df, devTraj.centered.schaefer400.GBC_df
metric="GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("devTraj.centered.", atlases_GBC[i], ".", metric, "_df")
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered_covbat.csv", dataset, metric, atlases_GBC[i])))
  print(df_name)
}

 

 
atlases <- c("gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
# devTraj.centered.gordon.BNC_df, devTraj.centered.schaefer200x7.BNC_df, devTraj.centered.schaefer200x17.BNC_df,  devTraj.centered.schaefer400x7.BNC_df, devTraj.centered.schaefer400x17.BNC_df
metric="BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("devTraj.centered.", atlases[i], ".", metric, "_df")
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered_covbat.csv", dataset, metric, atlases[i])))
  print(df_name)
}


# devTraj.centered.gordon.WNC_df, devTraj.centered.schaefer200x7.WNC_df, devTraj.centered.schaefer200x17.WNC_df,  devTraj.centered.schaefer400x7.WNC_df, devTraj.centered.schaefer400x17.WNC_df 
metric="WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("devTraj.centered.", atlases[i], ".", metric, "_df")
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMsmoothfits.%2$s.age.%3$s_centered_covbat.csv", dataset, metric, atlases[i])))
  print(df_name)
}

 
 
```
#### make dev traj figures
```{r make_Dev.Trajectory.Figures, include=FALSE}
#GBC
devTraj.centered.GBC <- lapply(atlases_GBC, make_smooths_fig_centered, "GBC")
names(devTraj.centered.GBC) <- atlases_GBC

#BNC
devTraj.centered.BNC <- lapply(atlases, make_smooths_fig_centered, "BNC")
names(devTraj.centered.BNC) <- atlases

#WNC
devTraj.centered.WNC <- lapply(atlases, make_smooths_fig_centered, "WNC")
names(devTraj.centered.WNC) <- atlases
```

#### **Figure**: GBC Dev Trajectory  
```{r Fig7, fig.height= 10, fig.width= 12, warning=FALSE}

(devTraj.centered.GBC_fig <- plot_grid(devTraj.centered.GBC$glasser, devTraj.centered.GBC$gordon, devTraj.centered.GBC$schaefer200, devTraj.centered.GBC$schaefer400, labels = "AUTO"))

devTraj.centered.GBC$schaefer200
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/devTraj.centered.GBC_fig.svg", dpi=300)

ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig3_New/Fig3_GBCDevTraj_HCPD.pdf", dpi=1200, width = 5, height = 5)
 
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_GBCDevTraj_Covbat.pdf", dpi=300, width = 5, height = 4)

```

#### **Figure**: BNC Dev Trajectory  
```{r Fig8, fig.height= 10, fig.width= 12, warning=FALSE}

(devTraj.centered.BNC_fig <- plot_grid(devTraj.centered.BNC$gordon, devTraj.centered.BNC$schaefer200x7, devTraj.centered.BNC$schaefer400x7, labels = "AUTO"))

 
devTraj.centered.BNC$schaefer200x7
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_BNCDevTraj_Covbat.pdf", dpi=300, width = 5, height = 4)
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/devTraj.centered.BNC_fig.svg", dpi=300)

#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_BNCDevTraj_noCovbat.pdf", dpi=300, width = 5, height = 4)
```

#### **Figure**: WNC Dev Trajectory  
```{r Fig9, fig.height= 5, fig.width= 6, warning=FALSE}

(devTraj.centered.WNC_fig <- plot_grid(devTraj.centered.WNC$gordon, devTraj.centered.WNC$schaefer200x7, devTraj.centered.WNC$schaefer400x7,  labels = "AUTO"))
 


#ggsave("/cbica/projects/network_replication/output/Figures/Flux/devTraj.centered.WNC_fig.svg", dpi=300)

devTraj.centered.WNC$schaefer200x7
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_WNCDevTraj_Covbat.pdf", dpi=300, width = 5, height = 4)

#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/harmonization/HCPD_WNCDevTraj_noCovbat.pdf", dpi=300, width = 5, height = 4)
```



```{r SM.middle.assoc_dataframe, include=FALSE}

# subsets gam.smooths (long_df) to SM, middle axis, and association pole dataframes (to make dev trajectory figures)
make_SM.middle.assoc_dataframe <- function(atlas_name, metric){
  gam.smooths.centered <- get(paste0("devTraj.centered.", atlas_name, ".", metric, "_df"))
  gam.smooths.ordered <- gam.smooths.centered[order(gam.smooths.centered$SA.axis_rank),]
  # break smooths dataframe into thirds (SM pole, middle axis, association pole)
  # then run the make_gam.smooths_centered function to make the trajectories 
  thirds <- seq(1, nrow(gam.smooths.ordered), nrow(gam.smooths.ordered)/3)
  SM <- gam.smooths.ordered[c(1:round(thirds[2])),]
  middle.axis <- gam.smooths.ordered[c(round(thirds[2]):round(thirds[3])),]
  assoc.pole <- gam.smooths.ordered[c(round(thirds[3]):nrow(gam.smooths.ordered)),]
  SM.middle.assoc_dataframe <- list(SM, middle.axis, assoc.pole)
  names(SM.middle.assoc_dataframe) <- c("SM", "middle.axis", "assoc.pole")
  print(paste(atlas_name, metric))
  return(SM.middle.assoc_dataframe)
}
 
GBC_SM.middle.assoc <- lapply(atlases_GBC, make_SM.middle.assoc_dataframe, "GBC")
names(GBC_SM.middle.assoc) <- atlases_GBC
 
BNC_SM.middle.assoc <- lapply(atlases, make_SM.middle.assoc_dataframe, "BNC")
names(BNC_SM.middle.assoc) <- atlases 

WNC_SM.middle.assoc <- lapply(atlases, make_SM.middle.assoc_dataframe, "WNC")
names(WNC_SM.middle.assoc) <- atlases 
 
 
```


```{r SM.middle.assoc_figure.df, include= FALSE}

 
# SM
GBC_SM_devTraj.fig <- lapply(atlases_GBC, make_SM.middle.assoc.fig_centered, "GBC", "SM")
names(GBC_SM_devTraj.fig) <- atlases_GBC
BNC_SM_devTraj.fig <- lapply(atlases, make_SM.middle.assoc.fig_centered, "BNC", "SM")
names(BNC_SM_devTraj.fig) <- atlases
WNC_SM_devTraj.fig <- lapply(atlases, make_SM.middle.assoc.fig_centered, "WNC", "SM")
names(WNC_SM_devTraj.fig) <- atlases

# middle axis
GBC_middle.axis_devTraj.fig <- lapply(atlases_GBC, make_SM.middle.assoc.fig_centered, "GBC", "middle.axis")
names(GBC_middle.axis_devTraj.fig) <- atlases_GBC
BNC_middle.axis_devTraj.fig <- lapply(atlases, make_SM.middle.assoc.fig_centered, "BNC", "middle.axis")
names(BNC_middle.axis_devTraj.fig) <- atlases
WNC_middle.axis_devTraj.fig <- lapply(atlases, make_SM.middle.assoc.fig_centered, "WNC", "middle.axis")
names(WNC_middle.axis_devTraj.fig) <- atlases
 
# association pole
GBC_assoc.pole_devTraj.fig <- lapply(atlases_GBC, make_SM.middle.assoc.fig_centered, "GBC", "assoc.pole")
names(GBC_assoc.pole_devTraj.fig) <- atlases_GBC
BNC_assoc.pole_devTraj.fig <- lapply(atlases, make_SM.middle.assoc.fig_centered, "BNC", "assoc.pole")
names(BNC_assoc.pole_devTraj.fig) <- atlases
WNC_assoc.pole_devTraj.fig <- lapply(atlases, make_SM.middle.assoc.fig_centered, "WNC", "assoc.pole")
names(WNC_assoc.pole_devTraj.fig) <- atlases
 
 
#paletteer::paletteer_c("grDevices::RdYlBu", n=20)
 
 
  
```

 
#### **Figure**: GBC Dev Trajectory - by SA rank
 
```{r FigDevTraj1, fig.height= 9, fig.width= 11, warning=FALSE, cache=TRUE}

GBC.dev.traj_SAranked <- plot_grid(GBC_SM_devTraj.fig$glasser, GBC_middle.axis_devTraj.fig$glasser, GBC_assoc.pole_devTraj.fig$glasser, 
          GBC_SM_devTraj.fig$gordon, GBC_middle.axis_devTraj.fig$gordon, GBC_assoc.pole_devTraj.fig$gordon, 
          GBC_SM_devTraj.fig$schaefer200, GBC_middle.axis_devTraj.fig$schaefer200, GBC_assoc.pole_devTraj.fig$schaefer200, 
          GBC_SM_devTraj.fig$schaefer400, GBC_middle.axis_devTraj.fig$schaefer400, GBC_assoc.pole_devTraj.fig$schaefer400, labels = "AUTO", ncol=3)
GBC.dev.traj_SAranked
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/GBC.dev.traj_SAranked.svg", dpi=300)
```

#### **Figure**: BNC Dev Trajectory - by SA rank
```{r FigDevTraj2, fig.height= 7, fig.width= 11, warning=FALSE, cache=TRUE}


BNC.dev.traj_SAranked <- plot_grid(BNC_SM_devTraj.fig$gordon, BNC_middle.axis_devTraj.fig$gordon, BNC_assoc.pole_devTraj.fig$gordon, 
          BNC_SM_devTraj.fig$schaefer200x7, BNC_middle.axis_devTraj.fig$schaefer200x7, BNC_assoc.pole_devTraj.fig$schaefer200x7, 
          BNC_SM_devTraj.fig$schaefer400x7, BNC_middle.axis_devTraj.fig$schaefer400x7, BNC_assoc.pole_devTraj.fig$schaefer400x7, labels = "AUTO", ncol=3)
BNC.dev.traj_SAranked
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/BNC.dev.traj_SAranked.svg", dpi=300)
#smooth_fits$schaefer200x7$assoc.pole
smooth_fits$schaefer400x7$assoc.pole[c(which(is.na(smooth_fits$schaefer400x7$assoc.pole$SA.axis_rank))),]

which(str_detect(schaefer400x7_SAaxis$label, "Cont_PFCl_9"))
schaefer400x7_SAaxis[332,]

smooth_fits$schaefer400x7$assoc.pole[c(which(str_detect(smooth_fits$schaefer400x7$assoc.pole$parcel, "Cont_PFCl_9"))),]

setdiff(gsub("X7", "", unique(smooth_fits$schaefer400x7$middle.axis$parcel)), schaefer400x7_SAaxis$label)
smooth_fits <- get(paste0(metric, "_SM.middle.assoc"))
  smooth_fits1 <- smooth_fits[[atlas]][[SA_position]]
```



#### **Figure**: WNC Dev Trajectory - by SA rank
```{r FigDevTraj3, fig.height= 7, fig.width= 11, warning=FALSE, cache=TRUE} 

WNC.dev.traj_SAranked <- plot_grid(WNC_SM_devTraj.fig$gordon, WNC_middle.axis_devTraj.fig$gordon, WNC_assoc.pole_devTraj.fig$gordon, 
          WNC_SM_devTraj.fig$schaefer200x7, WNC_middle.axis_devTraj.fig$schaefer200x7, WNC_assoc.pole_devTraj.fig$schaefer200x7, 
          WNC_SM_devTraj.fig$schaefer400x7, WNC_middle.axis_devTraj.fig$schaefer400x7, WNC_assoc.pole_devTraj.fig$schaefer400x7, labels = "AUTO", ncol=3)
WNC.dev.traj_SAranked

#ggsave("/cbica/projects/network_replication/output/Figures/Flux/WNC.dev.traj_SAranked.svg", dpi=300) 
#### start here - may want to figure out what's wrong with the parcel that only has half a trajcetory
#save.image(file='HCPD_devEffectFigures_environment.RData')
```

 

#### print average S-A rank of each network for each atlas 
```{r print_avg_SArank, include=TRUE}
# Print average S-A rank of each network from schaefer200x7
schaefer200x7_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer200x7_SAaxis_CommAffil.csv")
schaefer200x7_SAaxis_CommAffil <- schaefer200x7_SAaxis_CommAffil[,-1]
cat("Schaefer200x7\n")
for(i in 1:length(levels(as.factor(schaefer200x7_SAaxis_CommAffil$CommNames)))) {
  rows <- which(str_detect(schaefer200x7_SAaxis_CommAffil$CommNames, levels(as.factor(schaefer200x7_SAaxis_CommAffil$CommNames))[i]))
  mean <- mean(schaefer200x7_SAaxis_CommAffil$SA.axis_rank[rows])
  print(paste(levels(as.factor(schaefer200x7_SAaxis_CommAffil$CommNames))[i], "network =", round(mean, 1)))
}
cat("\nSchaefer200x17\n")
# Print average S-A rank or each network from schaefer200x17
schaefer200x17_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer200x17_SAaxis_CommAffil_BNC.GBC.csv")
schaefer200x17_SAaxis_CommAffil <- schaefer200x17_SAaxis_CommAffil[,-1]
for(i in 1:length(levels(as.factor(schaefer200x17_SAaxis_CommAffil$CommNames)))) {
  rows <- which(str_detect(schaefer200x17_SAaxis_CommAffil$CommNames, levels(as.factor(schaefer200x17_SAaxis_CommAffil$CommNames))[i]))
  mean <- mean(schaefer200x17_SAaxis_CommAffil$SA.axis_rank[rows])
  print(paste(levels(as.factor(schaefer200x17_SAaxis_CommAffil$CommNames))[i], "network =", round(mean, 1)))
}

# Print average S-A rank of each network from schaefer400x7
schaefer400x7_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer400x7_SAaxis_CommAffil.csv")
schaefer400x7_SAaxis_CommAffil <- schaefer400x7_SAaxis_CommAffil[,-1]
cat("\nSchaefer400x7\n")
for(i in 1:length(levels(as.factor(schaefer400x7_SAaxis_CommAffil$CommNames)))) {
  rows <- which(str_detect(schaefer400x7_SAaxis_CommAffil$CommNames, levels(as.factor(schaefer400x7_SAaxis_CommAffil$CommNames))[i]))
  mean <- mean(schaefer400x7_SAaxis_CommAffil$SA.axis_rank[rows])
  print(paste(levels(as.factor(schaefer400x7_SAaxis_CommAffil$CommNames))[i], "network =", round(mean, 1)))
}
cat("\nSchaefer400x17\n")
# Print average S-A rank or each network from schaefer400x17
schaefer400x17_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer400x17_SAaxis_CommAffil.csv")
schaefer400x17_SAaxis_CommAffil <- schaefer400x17_SAaxis_CommAffil[,-1]
for(i in 1:length(levels(as.factor(schaefer400x17_SAaxis_CommAffil$CommNames)))) {
  rows <- which(str_detect(schaefer400x17_SAaxis_CommAffil$CommNames, levels(as.factor(schaefer400x17_SAaxis_CommAffil$CommNames))[i]))
  mean <- mean(schaefer400x17_SAaxis_CommAffil$SA.axis_rank[rows])
  print(paste(levels(as.factor(schaefer400x17_SAaxis_CommAffil$CommNames))[i], "network =", round(mean, 1)))
}

cat("\nGordon333\n")
# Print average S-A rank or each network from gordon
gordon_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/gordon_SAaxis_CommAffil.csv")
gordon_SAaxis_CommAffil <- gordon_SAaxis_CommAffil[,-1]
for(i in 1:length(levels(as.factor(gordon_SAaxis_CommAffil$CommNames)))) {
  rows <- which(str_detect(gordon_SAaxis_CommAffil$CommNames, levels(as.factor(gordon_SAaxis_CommAffil$CommNames))[i]))
  mean <- mean(gordon_SAaxis_CommAffil$SA.axis_rank[rows])
  print(paste(levels(as.factor(gordon_SAaxis_CommAffil$CommNames))[i], "network =", round(mean, 1)))
}
 
```
 
 ** start here
- extract smooths for representative parcels
  1) look at SA ranks and choose 3 parcels per third
  2) extract smooths from their respective devTraj.centered.atlas.metric_df 
  3) plot smooths for each parcel
  
- extract those same parcels from the edge-level analyses. need to figure out how to actually do this
  - want to look at changes in a given parcel's changes to every other parcel
  - maybe include a column to indicate whether a parcel is within-network so we can color the trajectories 
  - also include a column for SA_diff to color it a different way

 

#### **Figure**: Make representative parcels
```{r make_representative_parcels, warning=FALSE, cache=TRUE}
  
# subsets gam.smooths (long_df) to extract specific parcels and creates a new dataframe (to make dev trajectory figures)
# @param SA_parcelnames, A character string indicating which parcels to plot (i.e "SM", "default", etc.; may be different for different atlases)
smooths_repParcels <- function(SA_ranks, atlas_name, metric){
  gam.smooths.centered <- get(paste0("devTraj.centered.", atlas_name, ".", metric, "_df"))
  gam.smooths.ordered <- gam.smooths.centered[order(gam.smooths.centered$SA.axis_rank),]
  parcel_rows <- which(gam.smooths.ordered$SA.axis_rank %in% SA_ranks) # trying to extract all rows that match SA_ranks
  repParcels <- gam.smooths.ordered[parcel_rows,]
  return(repParcels)
}

names(schaefer200x7_SAaxis)[3] <- "label"
# schaefer200x7
## extract row numbers for parcels of interest (somatomotor, default, visual, salient/ventral attention, and frontal parietal networks)
## note that all 7 Network schaefer atlas parcels have been reordered to match 17 network (see schaefer7to17_reordering.Rmd)
## arrange(schaefer200x7_SAaxis, by= SA.axis_rank) 
SM <- which(str_detect(schaefer200x7_SAaxis$label, "SomMot")) # mean SA rank = 40
SM_ranks <- schaefer200x7_SAaxis$SA.axis_rank[SM] # somatomotor is pretty uniform in terms of all increasing; auditory too though there are some U shaped curves
visual <- which(str_detect(schaefer200x7_SAaxis$label, "Vis")) # mean SA rank = 30
visual_ranks <- schaefer200x7_SAaxis$SA.axis_rank[visual]
default <- which(str_detect(schaefer200x7_SAaxis$label, "Default")) # mean SA rank = 155
default_ranks <- schaefer200x7_SAaxis$SA.axis_rank[default]  
attention <- which(str_detect(schaefer200x7_SAaxis$label, "SalVentAttn")) # mean SA rank = 113
attention_ranks <- schaefer200x7_SAaxis$SA.axis_rank[attention]  
frontoparietalControl <- which(str_detect(schaefer200x7_SAaxis$label, "Cont")) # mean SA rank = 144
frontoparietalControl_ranks <- schaefer200x7_SAaxis$SA.axis_rank[frontoparietalControl]  
 
schaefer200x7_parcelRanks <- list(SM_ranks, visual_ranks, default_ranks, attention_ranks, frontoparietalControl_ranks)
repParcels_GBC_schaefer200x7 <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, "schaefer200", "GBC")  
names(repParcels_GBC_schaefer200x7) <- c("SomMot", "visual", "default", "attention", "frontoparietalControl")
repParcels_BNC_schaefer200x7 <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, "schaefer200x7", "BNC")  
names(repParcels_BNC_schaefer200x7) <- c("SomMot", "visual", "default", "attention", "frontoparietalControl")
repParcels_WNC_schaefer200x7 <- lapply(schaefer200x7_parcelRanks, smooths_repParcels, "schaefer200x7", "WNC")  
names(repParcels_WNC_schaefer200x7) <- c("SomMot", "visual", "default", "attention", "frontoparietalControl")
repParcels_schaefer200x7 <- list(repParcels_GBC_schaefer200x7, repParcels_BNC_schaefer200x7, repParcels_WNC_schaefer200x7)
names(repParcels_schaefer200x7) <- c("GBC", "BNC", "WNC")
 

```
 

```{r FigRepresentativeParcels_schaefer200x7, fig.height= 8, fig.width= 12, warning=FALSE, cache=TRUE}

## set up dataframe for making figures
schaefer200x7_SAaxis$SA.axis_rank <- as.numeric(schaefer200x7_SAaxis$SA.axis_rank)
names(schaefer200x7_SAaxis)[3] <- "region"
schaefer200x7_SAaxis_fig.df <- schaefer200x7_SAaxis %>% mutate(SomMot = ifelse(SA.axis_rank %in% SM_ranks, 1, 0)) %>% 
  mutate(default = ifelse(SA.axis_rank %in% default_ranks, 1, 0))  %>%  
  mutate(attention = ifelse(SA.axis_rank %in% attention_ranks, 1, 0)) %>% 
  mutate(visual = ifelse(SA.axis_rank %in% visual_ranks, 1, 0)) %>% 
  mutate(frontoparietalControl = ifelse(SA.axis_rank %in% frontoparietalControl_ranks, 1, 0))
schaefer200x7_SAaxis_fig.df$region <- gsub("Network", "7Network", schaefer200x7_SAaxis_fig.df$region)

 
# schaefer200x7  
## somatomotor parcels: average SA rank = 39.5 
schaefer200x7_GBC_SomMot <- make_repParcel.fig("GBC", "schaefer200x7", "SomMot", "#24A6A8FF") 
schaefer200x7_BNC_SomMot <- make_repParcel.fig("BNC", "schaefer200x7",  "SomMot", "#24A6A8FF")
schaefer200x7_WNC_SomMot <- make_repParcel.fig("WNC", "schaefer200x7",  "SomMot", "#24A6A8FF") 
schaefer200x7_SomMot <- list(schaefer200x7_GBC_SomMot, schaefer200x7_BNC_SomMot, schaefer200x7_WNC_SomMot)
names(schaefer200x7_SomMot) <- c("GBC", "BNC", "WNC")

 
## default parcels: average SA rank = 155
schaefer200x7_GBC_default <- make_repParcel.fig("GBC", "schaefer200x7", "default", "#C73000FF") 
schaefer200x7_BNC_default <- make_repParcel.fig("BNC", "schaefer200x7",  "default", "#C73000FF")
schaefer200x7_WNC_default <- make_repParcel.fig("WNC", "schaefer200x7",  "default", "#C73000FF") 
schaefer200x7_default <- list(schaefer200x7_GBC_default, schaefer200x7_BNC_default, schaefer200x7_WNC_default)
names(schaefer200x7_default) <- c("GBC", "BNC", "WNC")

## frontoparietalControl network parcels: average SA rank = 143  
schaefer200x7_GBC_frontoparietalControl <- make_repParcel.fig("GBC", "schaefer200x7", "frontoparietalControl", "#C73000FF") 
schaefer200x7_BNC_frontoparietalControl <- make_repParcel.fig("BNC", "schaefer200x7",  "frontoparietalControl", "#C73000FF")
schaefer200x7_WNC_frontoparietalControl <- make_repParcel.fig("WNC", "schaefer200x7",  "frontoparietalControl", "#C73000FF") 
schaefer200x7_frontoparietalControl <- list(schaefer200x7_GBC_frontoparietalControl, schaefer200x7_BNC_frontoparietalControl, schaefer200x7_WNC_frontoparietalControl)  
names(schaefer200x7_frontoparietalControl) <- c("GBC", "BNC", "WNC")

## attention network parcels: average SA rank = 113  

schaefer200x7_GBC_attention <- make_repParcel.fig("GBC", "schaefer200x7", "attention", "#EEAC32FF") 
schaefer200x7_BNC_attention <- make_repParcel.fig("BNC", "schaefer200x7",  "attention", "#EEAC32FF")
schaefer200x7_WNC_attention <- make_repParcel.fig("WNC", "schaefer200x7",  "attention", "#EEAC32FF") 
schaefer200x7_attention <- list(schaefer200x7_GBC_attention, schaefer200x7_BNC_attention, schaefer200x7_WNC_attention)
names(schaefer200x7_attention) <- c("GBC", "BNC", "WNC")
 

```
 
 


```{r FigRepresentativeParcels_schaefer200x7_saveOut, fig.height=3, fig.width=3}
 

schaefer200x7_SomMot$GBC
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig3_New/Fig3_GBCDevTrajRep_SM_HCPD.pdf", dpi=1200, width = 5, height = 5)

schaefer200x7_attention$GBC
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig3_New/Fig3_GBCDevTrajRep_Attention_HCPD.pdf", dpi=1200, width = 5, height = 5)

schaefer200x7_default$GBC
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig3_New/Fig3_GBCDevTrajRep_Default_HCPD.pdf", dpi=1200, width = 5, height = 5)



#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Figures/OHBM_2023/GBC_schaefer200_attention.svg", dpi=300, width = 4, height = 4)

schaefer200x7_SomMot$WNC
#ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Figures/OHBM_2023/GBC_schaefer200_SomMot.svg", dpi=300, width = 4, height = 4)


schaefer200x7_default$WNC
 
 
```

 
```{r load_SAaxis_CommAffil, include=FALSE}
gordon_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/gordon_SAaxis_CommAffil.csv")
gordon_SAaxis_CommAffil <- gordon_SAaxis_CommAffil[,-1]
 
arrange(gordon_SAaxis_CommAffil, SA.axis_rank)

devTraj.centered.gordon.GBC_df

schaefer200x7_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer200x7_SAaxis_CommAffil.csv")
schaefer200x7_SAaxis_CommAffil <- schaefer200x7_SAaxis_CommAffil[,-1]
schaefer200x17_SAaxis_CommAffil_WNC <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer200x17_SAaxis_CommAffil_WNC.csv") 
schaefer200x17_SAaxis_CommAffil_WNC <- schaefer200x17_SAaxis_CommAffil_WNC[,-1]
schaefer200x17_SAaxis_CommAffil_BNC.GBC <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer200x17_SAaxis_CommAffil_BNC.GBC.csv") 
schaefer200x17_SAaxis_CommAffil_BNC.GBC <- schaefer200x17_SAaxis_CommAffil_BNC.GBC[,-1]

schaefer400x7_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer400x7_SAaxis_CommAffil.csv")
schaefer400x7_SAaxis_CommAffil <- schaefer400x7_SAaxis_CommAffil[,-1]

schaefer400x17_SAaxis_CommAffil <- read.csv("/cbica/projects/network_replication/atlases/parcellations/parcellations_masked/schaefer400x17_SAaxis_CommAffil.csv")
schaefer400x17_SAaxis_CommAffil <- schaefer400x17_SAaxis_CommAffil[,-1]
 
devTraj.centered.glasser.GBC_df

glasser_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/glasser_SAaxis_SNRmasked.csv")
arrange(glasser_SAaxis, SA.axis_rank)$label
```



### Correlation between fitted GBC at each age with the S-A Axis

```{r GBC_fittedValues_Age_Alignment}

# Region-wise GAM Fitted Value Predictions 
# schaefer200 
dataset="HCPD"
GBC.schaefer200.HCPD <- read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/GBC/GBCschaefer200_demographics_finalsample_covbat.csv", dataset)) 
names(GBC.schaefer200.HCPD) <- gsub('X17Networks', "Networks", names(GBC.schaefer200.HCPD))
GBC.schaefer200.HCPD$sex <- as.factor(GBC.schaefer200.HCPD$sex)
np <- 200
gam.smooths.schaefer <- matrix(data=NA, ncol=7) 
colnames(gam.smooths.schaefer) <- c("age","fitted","se","lower","upper","index","label")
 

for(row in c(1:nrow(schaefer200.parcel.labels))){ #for each schaefer region
  region <- schaefer200.parcel.labels$label[row] 
  GAM.SMOOTH <- gam.smooth.predict(measure = "GBC", atlas = "schaefer200", dataset = "HCPD", 
                                   region = region, smooth_var = "age", covariates = "sex + meanFD_avgSes", 
                                   knots = 3, set_fx = TRUE, increments = np) #run the gam.smooth.predict function
  preddata <- as.data.frame(GAM.SMOOTH[2]) #get predicted.smooth df from function output
  preddata$index <- rep(x=row, np) #region index
  preddata$label <- rep(x=region, np) #label
  gam.smooths.schaefer <- rbind(gam.smooths.schaefer, preddata)
  print(region)
}

gam.smooths.schaefer <- gam.smooths.schaefer[-1,] #remove empty initialization row
gam.smooths.schaefer$label <- as.character(gam.smooths.schaefer$label)
 
write.csv(gam.smooths.schaefer,"/cbica/projects/network_replication/output/HCPD/GBC/GBC_age_predictedfits_schaefer200.csv", row.names = F, quote = F) 
 
gam.smooths.schaefer <- left_join(schaefer200_SAaxis, gam.smooths.schaefer, by="label", sort=F)
# Correlate GBC fitted value predictions with S-A Axis
GBC.schaefer200.corr_values <- gam.smooths.schaefer %>%    
  group_by(age) %>%    
  do(SAcorrelation = cor(as.numeric(.$SA.axis_rank), as.numeric(.$fitted), method=c("spearman"))) %>%  unnest(cols = c(SAcorrelation))
  
```

```{r plot_fittedGBC_correlation}


plot_fittedGBC_corr <- function(atlas_name, metric, dataset) {
  corr_values <- get(paste0(metric, ".", atlas_name, ".", "corr_values" )) 
   
  fig <- ggplot(corr_values, aes(x = age, y = SAcorrelation)) + 
    geom_line(size = 1.5) +
     
    labs(x="\nAge", y="Spatial Alignment of Fitted GBC to the S-A Axis (r)\n") + ggtitle(paste(metric, "-", atlas_name, "in", dataset)) +
    theme_classic() + 
    theme(axis.text = element_text(size = 12, family = "Arial", color = c("black")), axis.title = element_text(size = 12, family = "Arial", color = c("black")), axis.line = element_line(size =.5), axis.ticks = element_line(size = .5)) +
    scale_x_continuous(breaks=c(4, 6, 8, 10, 12, 14, 16, 18, 20, 22), expand = c(0, .1)) 
  return(fig)
}

plot_fittedGBC_corr("schaefer200", "GBC", "HCPD")
```

#### load GAM fitted values
```{r load_gam.fitted, include=FALSE, cache=TRUE}
# GBC load GAMs age fitted (gam.GBC.fitted.atlas)
metric="GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.", metric, ".fitted.", atlases_GBC[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, df_name)))
  print(df_name)
} 

 
# BNC load GAMs age fitted
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".fitted.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, df_name)))
  print(df_name)
} 
 
 
# WNC load GAMs age fitted
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".fitted.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s_covbat.csv", dataset, metric, df_name)))
  print(df_name)
} 
 

```

#### Posterior fitted GBC - sensorimotor-association axis correlations, N=10,000
- derives the posterior fitted GBC correlations to SA axis. Can load output in following chunk. 
```{r load.edit_fits.SAaxis.posteriorcorrs, include=FALSE, eval=FALSE}

atlases_GBC <- "schaefer200" # only doing schaefer200 for now
metric="GBC"
# load posterior derivative correlations to SA-axis (fits.SAaxis.posteriorcorrs_metric$atlas)
load_posterior_fits <- function(atlas_name, metric){
  df_name <- paste0("fits.SAaxis.posteriorcorrs_",metric, ".", atlas_name)
  assign(df_name, readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/SAaxis_posteriorfits_correlation_byage_%3$s_covbat.RData", dataset, metric, atlas_name)))
  posteriorcorrs <- get(df_name)
  colnames(posteriorcorrs) <- sprintf("draw%s",seq(from = 1, to = ncol(posteriorcorrs)))
  gam.fits <- get(paste0("gam.", metric, ".fitted.", atlas_name))
  posteriorcorrs <- cbind(posteriorcorrs, (gam.fits %>% group_by(age) %>% group_keys()))
  assign(df_name, posteriorcorrs, envir = parent.frame())
  print(df_name)
  return(posteriorcorrs)
}
 
 fits.SAaxis.posteriorcorrs_GBC <- lapply(atlases_GBC, load_posterior_fits, "GBC")
names(fits.SAaxis.posteriorcorrs_GBC) <- atlases_GBC
saveRDS(fits.SAaxis.posteriorcorrs_GBC, "/cbica/projects/network_replication/output/HCPD/GBC/GAM/fits.SAaxis.posteriorcorrs_GBC.RData")


# not doing BNC and WNC for now
#fits.SAaxis.posteriorcorrs_BNC <- lapply(atlases, load_posterior_deriv, "BNC")
#names(fits.SAaxis.posteriorcorrs_BNC) <- atlases 
#saveRDS(fits.SAaxis.posteriorcorrs_BNC, "/cbica/projects/network_replication/output/HCPD/BNC/GAM/fits.SAaxis.posteriorcorrs_BNC.RData")

#fits.SAaxis.posteriorcorrs_WNC <- lapply(atlases, load_posterior_deriv, "WNC")
#names(fits.SAaxis.posteriorcorrs_WNC) <- atlases 
#saveRDS(fits.SAaxis.posteriorcorrs_WNC, "/cbica/projects/network_replication/output/HCPD/WNC/GAM/fits.SAaxis.posteriorcorrs_WNC.RData")
 
```

#### load posterior fits
```{r load_fits.SAaxis.posteriorcorrs, include=FALSE, cache=TRUE}


fits.SAaxis.posteriorcorrs_GBC <- readRDS("/cbica/projects/network_replication/output/HCPD/GBC/GAM/fits.SAaxis.posteriorcorrs_GBC.RData") 

#fits.SAaxis.posteriorcorrs_BNC <- readRDS("/cbica/projects/network_replication/output/HCPD/BNC/GAM/fits.SAaxis.posteriorcorrs_BNC.RData")  

#fits.SAaxis.posteriorcorrs_WNC <- readRDS("/cbica/projects/network_replication/output/HCPD/WNC/GAM/fits.SAaxis.posteriorcorrs_WNC.RData" ) 
  
 
```
 

#### Sensorimotor-association axis correlation value at each age: posterior median values + 95% credible interval
- calculates credible intervals. Can load results in following chunk. 
```{r cor.credible.intervals, include=FALSE, eval=FALSE}


function_cor.credible.intervals_fits <- function(atlas_name, metric) {
  fits.SAaxis.posteriorcorrs <- get(paste0("fits.SAaxis.posteriorcorrs_",metric)) 
  fits.SAaxis.posteriorcorrs <- fits.SAaxis.posteriorcorrs[[atlas_name]]
  
  fits.SAaxis.posteriorcorrs <- fits.SAaxis.posteriorcorrs %>% select(contains("draw"))
  fits.SAaxis.mediancorr <- apply(fits.SAaxis.posteriorcorrs, 1, function(x){median(x)})
  cor.credible.intervals <- apply(fits.SAaxis.posteriorcorrs, 1, function(x){quantile(x, probs = c(0.025, 0.975))}) #compute the credible interval for the correlation value at each age based on all draws 
  cor.credible.intervals <- as.data.frame(t(cor.credible.intervals))
 
  gam.der <- get(paste0("gam.", metric, ".fitted.", atlas_name))
  cor.credible.intervals <- cbind(cor.credible.intervals, (gam.der %>% group_by(age) %>% group_keys()))
  cor.credible.intervals <- cbind(cor.credible.intervals, fits.SAaxis.mediancorr)
  colnames(cor.credible.intervals) <- c("lower","upper","age","SA.correlation")
  cor.credible.intervals %>% arrange(desc(SA.correlation)) %>% slice_head()
    

  return(cor.credible.intervals)
}

 
cor.credible.intervals_GBC <- lapply(atlases_GBC, function_cor.credible.intervals_fits, "GBC")
names(cor.credible.intervals_GBC) <- atlases_GBC
saveRDS(cor.credible.intervals_GBC, "/cbica/projects/network_replication/output/HCPD/GBC/GAM/cor.credible.intervals_GBC_fitted.RData")
max(abs(cor.credible.intervals_GBC$schaefer200$SA.correlation))
 
#cor.credible.intervals_BNC <- lapply(atlases, function_cor.credible.intervals, "BNC")
#names(cor.credible.intervals_BNC) <- atlases
#saveRDS(cor.credible.intervals_BNC, "/cbica/projects/network_replication/output/HCPD/BNC/GAM/cor.credible.intervals_BNC_fitted.RData")

 

#cor.credible.intervals_WNC <- lapply(atlases, function_cor.credible.intervals, "WNC")
#names(cor.credible.intervals_WNC) <- atlases
#saveRDS(cor.credible.intervals_WNC, "/cbica/projects/network_replication/output/HCPD/WNC/GAM/cor.credible.intervals_WNC_fitted.RData")

```

 
```{r load_cor.credible.intervals, include=FALSE}
cor.credible.intervals_GBC <- readRDS("/cbica/projects/network_replication/output/HCPD/GBC/GAM/cor.credible.intervals_GBC_fitted.RData")
 
#cor.credible.intervals_BNC <- readRDS("/cbica/projects/network_replication/output/HCPD/BNC/GAM/cor.credible.intervals_BNC.fitted.RData")

#cor.credible.intervals_WNC <- readRDS("/cbica/projects/network_replication/output/HCPD/WNC/GAM/cor.credible.intervals_WNC.fitted.RData")
 
```

 


```{r plot_cred.intervals, include=FALSE, cache=TRUE}
atlases_GBC <- "schaefer200"

plot_cred.intervals <- function(atlas_name, metric) {
  cor.credible.intervals <- get(paste0("cor.credible.intervals_", metric)) 
  cor.credible.intervals <- cor.credible.intervals[[atlas_name]]
  cor.credible.intervals$max.cor.window
  fig <- ggplot(cor.credible.intervals, aes(x = age, y = SA.correlation, ymin = lower, ymax = upper)) + 
    geom_line(size = .5) +
    geom_ribbon(alpha = .2, fill = c("grey60")) + geom_hline(yintercept=-0.6,linetype=2) + 
    labs(x="Age", y="Spatial Alignment of GBC to S-A Axis (r)") + 
    theme_classic() + ylim(-0.62, 0) + 
    theme(axis.text = element_text(size = 24, 
                                   color = c("black")), 
          axis.title = element_text(size = 24, color = c("black")), 
          axis.line = element_line(size =.22), 
          axis.ticks = element_line(size = .22)) +
    scale_x_continuous(breaks=c(4, 6, 8, 10, 12, 14, 16, 18, 20, 22), expand = c(0, .1)) 
  return(fig)
}



SA_metric_corr_GBC <- lapply(atlases_GBC, plot_cred.intervals, "GBC")
names(SA_metric_corr_GBC) <- atlases_GBC

SA_metric_corr_GBC
#SA_metric_corr_BNC <- lapply(atlases, plot_cred.intervals, "BNC")
#names(SA_metric_corr_BNC) <- atlases

#SA_metric_corr_WNC <- lapply(atlases, plot_cred.intervals, "WNC")
#names(SA_metric_corr_WNC) <- atlases
 
```



#### **Figure**: Fitted GBC correlation analysis  
```{r Fig13, fig.height= 6, fig.width= 8, warning=FALSE, cache=TRUE}

plot_grid(SA_metric_corr_GBC$schaefer200, labels = "AUTO")

SA_metric_corr_GBC$schaefer200
 

ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Figures_Illustrator/Fig7/Fig7_HCPD_GBC_ageFittedValues.pdf", dpi=300, width = 6, height = 5)
```


### Temporal Sliding Window Analyses - Magnitude and Direction of Dev Change
#### load GAM Derivatives
```{r load_gam.derivatives, include=FALSE, cache=TRUE}
# GBC load GAMs age derivatives (gam.GBC.derivatives.atlas)
metric="GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.", metric, ".derivatives.", atlases_GBC[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, df_name)))
  print(df_name)
} 

 
# BNC load GAMs age derivatives
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".derivatives.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, df_name)))
  print(df_name)
} 
 
 
# WNC load GAMs age derivatives
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".derivatives.", atlases[i])
  assign(df_name, read.csv(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/%3$s.csv", dataset, metric, df_name)))
  print(df_name)
} 
 

```
#### make sliding window Dfs
```{r make_slidingWindowDfs, include=FALSE, cache=TRUE}
# GBC - makes gam.GBC.derivatives.glasser.fig, gam.GBC.derivatives.gordon.fig, gam.GBC.derivatives.schaefer200.fig, gam.GBC.derivatives.schaefer400.fig   
metric = "GBC"
for(i in c(1:length(atlases_GBC))){
  df_name <- paste0("gam.", metric, ".derivatives.", atlases_GBC[i], ".fig")
  assign(df_name, tempSliding_fig(metric, atlases_GBC[i]))
  print(df_name)
} 
 
    
# BNC - makes gam.BNC.derivatives.gordon.fig, gam.BNC.derivatives.schaefer200x7.fig, gam.BNC.derivatives.schaefer400x7.fig, gam.BNC.derivatives.schaefer200x17.fig, gam.BNC.derivatives.schaefer400x17.fig
metric = "BNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".derivatives.", atlases[i], ".fig")
  assign(df_name, tempSliding_fig(metric, atlases[i]))
  print(df_name)
} 
 
#WNC - makes gam.WNC.derivatives.gordon.fig, gam.WNC.derivatives.schaefer200x7.fig, gam.WNC.derivatives.schaefer400x7.fig, gam.WNC.derivatives.schaefer200x17.fig, gam.WNC.derivatives.schaefer400x17.fig
metric = "WNC"
for(i in c(1:length(atlases))){
  df_name <- paste0("gam.", metric, ".derivatives.", atlases[i], ".fig")
  assign(df_name, tempSliding_fig(metric, atlases[i]))
  print(df_name)
} 
 
 
```

#### **Figure**: Magnitude and Direction of Developmental Change - GBC
```{r Fig10, fig.height= 9, fig.width= 12, warning=FALSE, cache=TRUE}

sliding_window_GBC <- plot_grid(gam.GBC.derivatives.glasser.fig, gam.GBC.derivatives.gordon.fig, gam.GBC.derivatives.schaefer200.fig, gam.GBC.derivatives.schaefer400.fig, labels = "AUTO")
 
sliding_window_GBC 
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/sliding_window_GBC.svg", dpi=300) 

 
```

#### **Figure**: Magnitude and Direction of Developmental Change - BNC
```{r Fig11, fig.height= 9, fig.width= 9, warning=FALSE, cache=TRUE}
sliding_window_BNC <- plot_grid(gam.BNC.derivatives.gordon.fig, gam.BNC.derivatives.schaefer200x7.fig, gam.BNC.derivatives.schaefer400x7.fig, labels = "AUTO")
 
sliding_window_BNC 
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/sliding_window_BNC.svg", dpi=300) 

```

#### **Figure**: Magnitude and Direction of Developmental Change - WNC
```{r Fig12, fig.height= 9, fig.width= 9, warning=FALSE, cache=TRUE}
sliding_window_WNC <- plot_grid(gam.WNC.derivatives.gordon.fig, gam.WNC.derivatives.schaefer200x7.fig, gam.WNC.derivatives.schaefer400x7.fig, labels = "AUTO")   
 

sliding_window_WNC 
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/sliding_window_WNC.svg", dpi=300) 
```


### Temporal Window Analyses: Age-specific correlations between developmental change and the S-A Axis

#### Posterior derivative - sensorimotor-association axis correlations, N=10,000
- derives the posterior derivative correlations to SA axis. Can load output in following chunk. 
```{r load.edit_deriv.SAaxis.posteriorcorrs, include=FALSE, eval=FALSE}

# load posterior derivative correlations to SA-axis (deriv.SAaxis.posteriorcorrs_metric$atlas)
load_posterior_deriv <- function(atlas_name, metric){
  df_name <- paste0("deriv.SAaxis.posteriorcorrs_",metric, ".", atlas_name)""
  assign(df_name, readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/SAaxis_posteriorderivative_correlation_byage_%3$s.RData", dataset, metric, atlas_name)))
  posteriorcorrs <- get(df_name)
  colnames(posteriorcorrs) <- sprintf("draw%s",seq(from = 1, to = ncol(posteriorcorrs)))
  gam.der <- get(paste0("gam.", metric, ".derivatives.", atlas_name))
  posteriorcorrs <- cbind(posteriorcorrs, (gam.der %>% group_by(age) %>% group_keys()))
  assign(df_name, posteriorcorrs, envir = parent.frame())
  print(df_name)
  return(posteriorcorrs)
}
 
 
deriv.SAaxis.posteriorcorrs_GBC <- lapply(atlases_GBC, load_posterior_deriv, "GBC")
names(deriv.SAaxis.posteriorcorrs_GBC) <- atlases_GBC
#saveRDS(deriv.SAaxis.posteriorcorrs_GBC, "/cbica/projects/network_replication/output/HCPD/GBC/GAM/deriv.SAaxis.posteriorcorrs_GBC.RData")

deriv.SAaxis.posteriorcorrs_BNC <- lapply(atlases, load_posterior_deriv, "BNC")
names(deriv.SAaxis.posteriorcorrs_BNC) <- atlases 
#saveRDS(deriv.SAaxis.posteriorcorrs_BNC, "/cbica/projects/network_replication/output/HCPD/BNC/GAM/deriv.SAaxis.posteriorcorrs_BNC.RData")

deriv.SAaxis.posteriorcorrs_WNC <- lapply(atlases, load_posterior_deriv, "WNC")
names(deriv.SAaxis.posteriorcorrs_WNC) <- atlases 
#saveRDS(deriv.SAaxis.posteriorcorrs_WNC, "/cbica/projects/network_replication/output/HCPD/WNC/GAM/deriv.SAaxis.posteriorcorrs_WNC.RData")
  
  
```

#### load posterior derivatives
```{r load_deriv.SAaxis.posteriorcorrs, include=FALSE, cache=TRUE}


deriv.SAaxis.posteriorcorrs_GBC <- readRDS("/cbica/projects/network_replication/output/HCPD/GBC/GAM/deriv.SAaxis.posteriorcorrs_GBC.RData") 

deriv.SAaxis.posteriorcorrs_BNC <- readRDS("/cbica/projects/network_replication/output/HCPD/BNC/GAM/deriv.SAaxis.posteriorcorrs_BNC.RData")  

deriv.SAaxis.posteriorcorrs_WNC <- readRDS("/cbica/projects/network_replication/output/HCPD/WNC/GAM/deriv.SAaxis.posteriorcorrs_WNC.RData" ) 
  

```

#### Age of maximal sensorimotor-association axis correlation: posterior median value + 95% credible interval
- calculates age of max correlation. Can load results in following chunk.
```{r age_maximum_corr_with_SAaxis, include=FALSE, eval=FALSE}


function_age.max.corr <- function(atlas_name, metric) {
  deriv.SAaxis.posteriorcorrs <- get(paste0("deriv.SAaxis.posteriorcorrs_",metric)) 
  deriv.SAaxis.posteriorcorrs <- deriv.SAaxis.posteriorcorrs[[atlas_name]]
  age.max.corr <- paste0("age.max.corr_", metric, ".", atlas_name) 
  assign(age.max.corr, deriv.SAaxis.posteriorcorrs %>% #find the age at which the correlation is largest for each draw
  summarise(across(contains("draw"),
                   .fns = function(x){
                     round(deriv.SAaxis.posteriorcorrs$age[which.max(abs(x))],4)
                   })))
  assign(age.max.corr, t(get(age.max.corr)))  
  age.max.corr.CI <- paste0("age.max.corr.CI_", metric, ".", atlas_name)
  age.max.corr.median <- paste0("age.max.corr.median_", metric, ".", atlas_name)
  age.max.corr.lower <- paste0("age.max.corr.lower_", metric, ".", atlas_name)
  age.max.corr.upper <- paste0("age.max.corr.upper_", metric, ".", atlas_name)
  
  assign(age.max.corr.median, median(get(age.max.corr))) #median age #bayes
  assign(age.max.corr.CI, quantile(get(age.max.corr), probs = c(0.025, 0.975))) #compute the credible interval based on all draws
  assign(age.max.corr.lower, get(age.max.corr.CI)[[1]])
  assign(age.max.corr.upper, get(age.max.corr.CI)[[2]])
  list_age.stats <- list(get(age.max.corr.CI), get(age.max.corr.median), get(age.max.corr.lower), get(age.max.corr.upper))
  names(list_age.stats) <- c("age.max.corr.CI", "age.max.corr.median", "age.max.corr.lower", "age.max.corr.upper")
  return(list_age.stats)
}

age.max.stats_GBC <- lapply(atlases_GBC, function_age.max.corr, "GBC")
names(age.max.stats_GBC) <- atlases_GBC
#saveRDS(age.max.stats_GBC, "/cbica/projects/network_replication/output/HCPD/GBC/GAM/age.max.stats_GBC.RData")

age.max.stats_BNC <- lapply(atlases, function_age.max.corr, "BNC")
names(age.max.stats_BNC) <- atlases 
#saveRDS(age.max.stats_BNC, "/cbica/projects/network_replication/output/HCPD/BNC/GAM/age.max.stats_BNC.RData")

age.max.stats_WNC <- lapply(atlases, function_age.max.corr, "WNC")
names(age.max.stats_WNC) <- atlases 
#saveRDS(age.max.stats_WNC, "/cbica/projects/network_replication/output/HCPD/WNC/GAM/age.max.stats_WNC.RData")
 
```

 
```{r load_age_maximum_corr_with_SAaxis, include=FALSE, cache=TRUE}

age.max.stats_GBC <- readRDS("/cbica/projects/network_replication/output/HCPD/GBC/GAM/age.max.stats_GBC.RData")
age.max.stats_BNC <- readRDS("/cbica/projects/network_replication/output/HCPD/BNC/GAM/age.max.stats_BNC.RData")
age.max.stats_WNC <- readRDS("/cbica/projects/network_replication/output/HCPD/WNC/GAM/age.max.stats_WNC.RData")
```


```{r print_age.max.corr.median, include=FALSE}
# Median Age of maximum correlation between a given connectivity metric and SA-axis
# age.stats_[metric]$[atlas]$age.max.corr.median
      
print_age.max.corr.median <- function(atlas_name, metric) {
  df <- get(paste0("age.max.stats_", metric))
  return(paste("age.max.corr.median", metric, atlas_name, "=", df[[atlas_name]]$age.max.corr.median))
}

lapply(atlases_GBC, print_age.max.corr.median, "GBC")
lapply(atlases, print_age.max.corr.median, "BNC")
lapply(atlases, print_age.max.corr.median, "WNC")
 
```


```{r print_age.max.corr.CI, include=FALSE}
# age.max.corr.CI_metric.atlas

print_age.max.corr.CI <- function(atlas_name, metric) {
  df <- get(paste0("age.max.stats_", metric))
  return(paste("age.max.corr.CI", metric, atlas_name, ":", "2.5% ->",df[[atlas_name]]$age.max.corr.CI[[1]], "; 97.5% ->" ,df[[atlas_name]]$age.max.corr.CI[[2]]))
}

lapply(atlases_GBC, print_age.max.corr.CI, "GBC")
lapply(atlases, print_age.max.corr.CI, "BNC")
lapply(atlases, print_age.max.corr.CI, "WNC")
 
age.max.stats_GBC$schaefer200
 
```

  

save out environment
```{r save_out, include=FALSE, eval=FALSE}
	
#save.image(file='HCPD_devEffectFigures_environment.RData')

```


#### Sensorimotor-association axis correlation value at each age: posterior median values + 95% credible interval
- calculates credible intervals. Can load results in following chunk. 
```{r cor.credible.intervals, include=FALSE, eval=FALSE}


function_cor.credible.intervals <- function(atlas_name, metric) {
  deriv.SAaxis.posteriorcorrs <- get(paste0("deriv.SAaxis.posteriorcorrs_",metric)) 
  deriv.SAaxis.posteriorcorrs <- deriv.SAaxis.posteriorcorrs[[atlas_name]]
  
  deriv.SAaxis.posteriorcorrs <- deriv.SAaxis.posteriorcorrs %>% select(contains("draw"))
  deriv.SAaxis.mediancorr <- apply(deriv.SAaxis.posteriorcorrs, 1, function(x){median(x)})
  cor.credible.intervals <- apply(deriv.SAaxis.posteriorcorrs, 1, function(x){quantile(x, probs = c(0.025, 0.975))}) #compute the credible interval for the correlation value at each age based on all draws 
  cor.credible.intervals <- as.data.frame(t(cor.credible.intervals))
 
  gam.der <- get(paste0("gam.", metric, ".derivatives.", atlas_name))
  cor.credible.intervals <- cbind(cor.credible.intervals, (gam.der %>% group_by(age) %>% group_keys()))
  cor.credible.intervals <- cbind(cor.credible.intervals, deriv.SAaxis.mediancorr)
  colnames(cor.credible.intervals) <- c("lower","upper","age","SA.correlation")
  cor.credible.intervals %>% arrange(desc(SA.correlation)) %>% slice_head()
  age.max.corr.lower <- get(paste0("age.max.stats_", metric))
  age.max.corr.lower <- age.max.corr.lower[[atlas_name]]$age.max.corr.lower 
  age.max.corr.upper <- get(paste0("age.max.stats_", metric))
  age.max.corr.upper <- age.max.corr.upper[[atlas_name]]$age.max.corr.upper
   
  cor.credible.intervals$max.corr.CI <- (cor.credible.intervals$age > age.max.corr.lower & cor.credible.intervals$age < age.max.corr.upper) #add a column that indicates whether each age is included in the age of maximal correlation credible interval (T/F)
  cor.credible.intervals$max.cor.window <- cor.credible.intervals$age*cor.credible.intervals$max.corr.CI #add a column that only includes ages in this interval
  cor.credible.intervals$max.cor.window[cor.credible.intervals$max.cor.window == 0] <- NA
                        
  cor.credible.intervals$zero.corr.CI <- (cor.credible.intervals$lower < 0 & cor.credible.intervals$upper > 0) #add a column that indicates whether the credible interval for the correlation includes 0
  cor.credible.intervals$zero.corr.window <- cor.credible.intervals$age*cor.credible.intervals$zero.corr.CI #add a column that only includes ages in the zero window
cor.credible.intervals$zero.corr.window[cor.credible.intervals$zero.corr.window == 0] <- NA

  return(cor.credible.intervals)
}

 
cor.credible.intervals_GBC <- lapply(atlases_GBC, function_cor.credible.intervals, "GBC")
names(cor.credible.intervals_GBC) <- atlases_GBC
#saveRDS(cor.credible.intervals_GBC, "/cbica/projects/network_replication/output/HCPD/GBC/GAM/cor.credible.intervals_GBC.RData")
 
max(abs(cor.credible.intervals_GBC$schaefer200$SA.correlation))

cor.credible.intervals_GBC$schaefer200[c(which(cor.credible.intervals_GBC$schaefer200$SA.correlation < -0.69)),]

 
cor.credible.intervals_BNC <- lapply(atlases, function_cor.credible.intervals, "BNC")
names(cor.credible.intervals_BNC) <- atlases
#saveRDS(cor.credible.intervals_BNC, "/cbica/projects/network_replication/output/HCPD/BNC/GAM/cor.credible.intervals_BNC.RData")

 

cor.credible.intervals_WNC <- lapply(atlases, function_cor.credible.intervals, "WNC")
names(cor.credible.intervals_WNC) <- atlases
#saveRDS(cor.credible.intervals_WNC, "/cbica/projects/network_replication/output/HCPD/WNC/GAM/cor.credible.intervals_WNC.RData")

```

 
```{r load_cor.credible.intervals, include=FALSE}
cor.credible.intervals_GBC <- readRDS("/cbica/projects/network_replication/output/HCPD/GBC/GAM/cor.credible.intervals_GBC.RData")
 
cor.credible.intervals_BNC <- readRDS("/cbica/projects/network_replication/output/HCPD/BNC/GAM/cor.credible.intervals_BNC.RData")

cor.credible.intervals_WNC <- readRDS("/cbica/projects/network_replication/output/HCPD/WNC/GAM/cor.credible.intervals_WNC.RData")
```

 


```{r plot_cred.intervals, include=FALSE, cache=TRUE}

plot_cred.intervals <- function(atlas_name, metric) {
  cor.credible.intervals <- get(paste0("cor.credible.intervals_", metric)) 
  cor.credible.intervals <- cor.credible.intervals[[atlas_name]]
  cor.credible.intervals$max.cor.window
  fig <- ggplot(cor.credible.intervals, aes(x = age, y = SA.correlation, ymin = lower, ymax = upper)) + 
    geom_line(size = .5) +
    geom_ribbon(alpha = .2, fill = c("grey60")) +
    labs(x="\nAge", y="Developmental Alignment to the Axis (r)\n") + ggtitle(paste(metric, "-", atlas_name)) +
    geom_ribbon(aes(x = max.cor.window, y = SA.correlation), fill = "#009392FF", alpha=0.8) +
    theme_classic() + 
    theme(axis.text = element_text(size = 7, family = "Arial", color = c("black")), axis.title = element_text(size = 7, family = "Arial", color = c("black")), axis.line = element_line(size =.22), axis.ticks = element_line(size = .22)) +
    scale_x_continuous(breaks=c(4, 6, 8, 10, 12, 14, 16, 18, 20, 22), expand = c(0, .1)) 
  return(fig)
}


SA_metric_corr_GBC <- lapply(atlases_GBC, plot_cred.intervals, "GBC")
names(SA_metric_corr_GBC) <- atlases_GBC

SA_metric_corr_BNC <- lapply(atlases, plot_cred.intervals, "BNC")
names(SA_metric_corr_BNC) <- atlases

SA_metric_corr_WNC <- lapply(atlases, plot_cred.intervals, "WNC")
names(SA_metric_corr_WNC) <- atlases

#ggsave(filename = "/cbica/projects/spatiotemp_dev_plasticity/figures/Manuscript_Figures/Neuron/Figure4/Derivative_SAaxis_correlation_plot.pdf", device = "pdf", dpi = 500, width = 3.82 , height = 2.35)
```



#### **Figure**: Temporal sliding window correlation analysis - GBC
```{r Fig13, fig.height= 1, fig.width= 2, warning=FALSE, cache=TRUE}

plot_grid(SA_metric_corr_GBC$glasser, SA_metric_corr_GBC$gordon, SA_metric_corr_GBC$schaefer200, SA_metric_corr_GBC$schaefer400, labels = "AUTO")
 
 
```


#### **Figure**: Temporal sliding window correlation analysis - BNC
```{r Fig14, fig.height= 8, fig.width= 8, warning=FALSE}

plot_grid( SA_metric_corr_BNC$gordon, SA_metric_corr_BNC$schaefer200x7, SA_metric_corr_BNC$schaefer400x7, labels = "AUTO")
 
 
```


#### **Figure**: Temporal sliding window correlation analysis - WNC
```{r Fig15, fig.height= 8, fig.width= 8, warning=FALSE}

plot_grid(SA_metric_corr_WNC$gordon, SA_metric_corr_WNC$schaefer200x7, SA_metric_corr_WNC$schaefer400x7, labels = "AUTO")

  
```
 
 
 
### Surface Plot
```{r make_surface_dfs, include=FALSE, include=FALSE}
 
atlases <- c("glasser", "gordon", "schaefer200x7", "schaefer200x17", "schaefer400x7", "schaefer400x17")
 
# makes SA.diff_glasser, SA.diff_gordon, SA.diff_schaefer200x7, SA.diff_schaefer200x17, SA.diff_schaefer400x7, SA.diff_schaefer400x17 
# gam.edge.age.glasser, gam.edge.age.gordon, gam.edge.age.schaefer200x7, gam.edge.age.schaefer200x17, gam.edge.age.schaefer400x7, gam.edge.age.schaefer400x17
# age_SA.diff_glasser, age_SA.diff_gordon, age_SA.diff_schaefer200x7, age_SA.diff_schaefer200x17, age_SA.diff_schaefer400x7, age_SA.diff_schaefer400x17 
# double_age_SA.diff_glasser, double_age_SA.diff_gordon, double_age_SA.diff_schaefer200x7, double_age_SA.diff_schaefer200x17, double_age_SA.diff_schaefer400x7, double_age_SA.diff_schaefer400x17

for(i in c(1:length(atlases))){
  SA.diff <- paste0("SA.diff", "_", atlases[i])
  assign(SA.diff, read.csv(sprintf("/cbica/projects/network_replication/atlases/edge/SA.diff_%1$s.csv", atlases[i])))
  SA.diff <- get(SA.diff)
  
  gam.edge.age <- paste0("gam.edge.age.", atlases[i])
  assign(gam.edge.age, readRDS(sprintf("/cbica/projects/network_replication/output/%1$s/%2$s/GAM/GAMresults.%2$s.age.%3$s_covbat.RData", dataset, "edge", atlases[i])))
  gam.edge.age <- get(gam.edge.age)
  
  age_SA.diff <- paste0("age_SA.diff_", atlases[i])
  assign(age_SA.diff, cbind(gam.edge.age, SA.diff))
  age_SA.diff <- get(age_SA.diff)
  age_SA.diff <- sig_parcels(age_SA.diff) 

  # make a double df for symmetry - parcel1 and parcel2.SA.vec repeated in opposite ordering (see lines 500-510 in Adam's Edge-level-Age.md)
  age_SA.diff2 <- paste0("age_SA.diff_", atlases[i], "2")
  assign(age_SA.diff2, age_SA.diff)  
  age_SA.diff2 <- get(age_SA.diff2)
  age_SA.diff2$parcel1.SA.vec <- age_SA.diff$parcel2.SA.vec
  age_SA.diff2$parcel2.SA.vec <- age_SA.diff$parcel1.SA.vec
  
  # "stacked" df
  double_age_SA.diff <- paste0("double_age_SA.diff_", atlases[i])
  assign(double_age_SA.diff, rbind(age_SA.diff2,age_SA.diff)) 
  print(paste0("double_age_SA.diff_", atlases[i], " finished"))
} 
 
  
```

 
```{r model_surface, fig.height= 12, fig.width= 8}
# model the surface
 

surface_plots <- lapply(atlases, make_surface_plot)
names(surface_plots) <- atlases
 
#plot_grid(surface_plots$glasser, surface_plots$gordon, surface_plots$schaefer200x7, surface_plots$schaefer400x7, labels = "AUTO")

surface_plots$schaefer200x7
ggsave("/Users/audluo/Library/CloudStorage/Box-Box/Box_PhD_Land/PennLINC/network_replication/Writing/Manuscript/Figures/Fig6_New/Fig6_EdgeSurfacePlot_HCPD.pdf", dpi=300, width = 5, height = 5)
```

 
  

### SA-axis Figure
```{r Fig_SA.axis, fig.height= 10, fig.width= 17, warning=FALSE, include=FALSE}

schaefer200_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer200x7_SAaxis_SNRmasked.csv")
schaefer200_SAaxis$SA.axis_rank <- as.numeric(schaefer200_SAaxis$SA.axis_rank)
names(schaefer200_SAaxis)[3] <- "region"

 
SAaxis_fig <- ggplot() + geom_brain(data=schaefer200_SAaxis, 
                      atlas=schaefer7_200, 
                      mapping=aes(fill=SA.axis_rank), 
                      show.legend=TRUE) + paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(schaefer200_SAaxis$SA.axis_rank), max(schaefer200_SAaxis$SA.axis_rank)), oob = squish) + theme_void()
 
SAaxis_fig 
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/SAaxis_fig.svg", dpi=300)

 
###
schaefer400_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/schaefer400x17_SAaxis_SNRmasked.csv")
schaefer400_SAaxis$SA.axis_rank <- as.numeric(schaefer400_SAaxis$SA.axis_rank)
names(schaefer400_SAaxis)[3] <- "region"

schaefer400_SAaxis$region<- gsub(x = schaefer400_SAaxis$region, pattern = "17Networks_RH_", replacement = "")
schaefer400_SAaxis <- schaefer400_SAaxis[-which(grepl("17Networks_LH_", schaefer400_SAaxis$region)),]

 

SAaxis_fig <- ggplot() + geom_brain(data=schaefer400_SAaxis, 
                      atlas=schaefer17_400, 
                      mapping=aes(fill=SA.axis_rank), 
                      show.legend=TRUE, 
                      hemi = "right") + paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(schaefer400_SAaxis$SA.axis_rank), max(schaefer400_SAaxis$SA.axis_rank)), oob = squish) + theme_void()
 
SAaxis_fig 
#ggsave("/cbica/projects/network_replication/output/Figures/Flux/SAaxis_fig.svg", dpi=300)


SAaxis_fig <- ggplot() + geom_brain(data=schaefer400_SAaxis, 
                      atlas=schaefer7_400, 
                      mapping=aes(fill=SA.axis_rank), 
                      show.legend=TRUE, 
                      hemi = "right") + paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(schaefer400x7_SAaxis$SA.axis_rank), max(schaefer400x7_SAaxis$SA.axis_rank)), oob = squish) + theme_void()
 

###

gordon_SAaxis <- read.csv("/cbica/projects/network_replication/SAaxis/gordon_SAaxis_SNRmasked.csv")
 
gordon_SAaxis$SA.axis_rank <- as.numeric(gordon_SAaxis$SA.axis_rank)
names(gordon_SAaxis)[3] <- "region"

gordon_SAaxis$region<- gsub(x = gordon_SAaxis$region, pattern = "17Networks_RH_", replacement = "")
gordon_SAaxis <- gordon_SAaxis[-which(grepl("17Networks_LH_", gordon_SAaxis$region)),]

 

SAaxis_fig <- ggplot() + geom_brain(data=gordon_SAaxis, 
                      atlas=gordon, 
                      mapping=aes(fill=SA.axis_rank), 
                      show.legend=TRUE, 
                      hemi = "right") + paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1, limits = c(min(gordon_SAaxis$SA.axis_rank), max(gordon_SAaxis$SA.axis_rank)), oob = squish) + theme_void()



schaefer_ggseg <- schaefer7_400$data$region[c(!is.na(schaefer7_400$data$region))]
schaefer_ggseg <- schaefer_ggseg[-c(which(duplicated(schaefer7_400$data$region[c(!is.na(schaefer7_400$data$region))])))]
 
setdiff(schaefer_ggseg, gsub("Net", "7Net", schaefer400x7_SAaxis$label)) 
schaefer_ggseg
xcp <- read.csv('/cbica/projects/network_replication/atlases/parcellations/schaefer400_7Network_regionlist.csv', header=F)
nrow(xcp)
setdiff(xcp$V1, gsub("7Networks_", "",schaefer_ggseg))
```

 


