---
title: "HCP-D Sample Selection"
author: "Audrey Luo"
date: "2022-11-30"
output: html_document
---
# Sample Selection process
1) original sample: N=652, ages 5-21, 5716 scans total
2) exclude participants with medical conditions affecting brain function, gross neurological abnormalities: N=631, 5527 scans
3) include passing T1 QC: all scans in dataset have survived T1 QC already 
4) include meanFD < 0.3: N=629, 5165 scans 
5) include scans with at least 7 minutes of scan time: N=625, 5159 scans (final sample), 337 females
Age: mean=14.5, SD=4.1

Race:
-  white = 395 - 63.2%
-  asian = 48 - 7.7%%
-  black = 69 - 11%
-  other (native american) = 3 - 0.48%
-  missing = 15 - 2.4%
-  mixed = 94 - 15%

# Sample Selection for sensitivity analysis (rest only)
5) include scans with at least 6 minutes of rest-only scan time (lowered threshold due to fewer total scans available after selecting for rest-only): N=611, 2324 scans, 328 females 
Notes:
- mean FD is averaged across the scans in a given session
  
## 1) original sample: N=652, ages 5-22 
```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(magrittr)
library(reshape)
library(reshape2)
library(MASS)
library(stargazer)
library(cifti)
library(ggplot2)
library(ggpubr)
 
```

## 1) original sample
```{r qc_setup}
demographics <- read.csv("/cbica/projects/network_replication/input/HCPD/sample_selection/hcpd_demographics.csv")


# load and concatenate xcp QC information for all subjects
participants <- gsub("HCD", "sub-", demographics$src_subject_id)
collated_HCPD.xcp <- read.csv("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_xcp_qc.csv")
collated_HCPD.xcp$sub <- paste0("sub-", collated_HCPD.xcp$sub)
 
# identify variants -- will eventually be removed due to short scan time. 
# variants: sub-0577358 and sub-1529756 have different number of volumes for their runs (253 instead of 478 -- less than 6 minutes of scan time) and missing task scans. keep variants.
#which(collated_HCPD.xcp$sub == "motionDVCorrFinal") 
#which(collated_HCPD.xcp$sub == "0577358") 
#which(collated_HCPD.xcp$sub == "1529756")
#  sub-0577358 and sub-1529756: c(2280:2297, 6078:6101)
 
collated_HCPD.xcp[c(2280:2297, 6078:6101),]
# fix variants' formatting
for (i in c(1:nrow(collated_HCPD.xcp))) {
  if (str_detect(collated_HCPD.xcp$dir[i], "VARIANT")) { 
    collated_HCPD.xcp$dir[i] <- collated_HCPD.xcp$run[i]
    collated_HCPD.xcp$run[i] <- collated_HCPD.xcp$space[i]
    collated_HCPD.xcp$space[i] <- collated_HCPD.xcp$den[i]
    collated_HCPD.xcp$den[i] <- collated_HCPD.xcp$meanFD[i]
    collated_HCPD.xcp$meanFD[i] <- collated_HCPD.xcp$relMeansRMSMotion[i]
    #collated_HCPD.xcp[i, 1] <- paste0(collated_HCPD.xcp[i, 1], "VARIANT")
  }
}
collated_HCPD.xcp <- collated_HCPD.xcp[-c(2287, 2289, 2291, 2293, 2295, 2297,6079,6081,6083, 6085, 6087, 6089, 6091, 6093, 6095, 6097, 6099, 6101),]
  
  
toDelete <- seq(2, nrow(collated_HCPD.xcp), 2)
collated_HCPD.xcp <- collated_HCPD.xcp[-c(toDelete),]
 
length(unique(collated_HCPD.xcp$sub)) # 652 participants before head motion QC  
    
```

## 2) exclude participants with medical conditions affecting brain function, gross neurological abnormalities
```{r medical_exclusion}

length(which(demographics$ex_vd2_dev_muscular_dystrophy =="")) # 499 answered "Y" for muscular dystrophy; 152 for "" (no answer). Y=Yes according to dictionary. something odd here

# cancer/leukemia
cancer <- demographics$src_subject_id[c(which(demographics$medhis_2e == 1))] # HCD0641341

# lead poisoning
lead<- demographics$src_subject_id[c(which(demographics$medhis_2k==1))] # "HCD0392144" "HCD0641341"
 
# sickle cell anemia
sickle <- demographics$src_subject_id[c(which(demographics$medhis_2p==1))] # HCD0641341
 
# very bad headaches 
headaches <- demographics$src_subject_id[c(which(demographics$medhis_2q==1))] # HCD0478356" "HCD0526644" "HCD0628854" "HCD0641341" "HCD0804545" "HCD1411935" "HCD1522338" "HCD1617450" "HCD1787677" "HCD2220428" "HCD2256651" "HCD2383456" "HCD2568670" "HCD2581763" "HCD2761967" "HCD2832863"
 
# head injury
head_injury <- demographics$src_subject_id[c(which(demographics$medhis_6i_times>0))] # 53 participants
#demographics$src_subject_id[c(which(demographics$ph_neuro9 ==1))] # same 53 participants 
 
# overdose
#demographics$src_subject_id[c(which(demographics$medhis_6o ==1))] # none

# accidental poisoning
poisoning <- demographics$src_subject_id[c(which(demographics$medhis_6q ==1))] # "HCD0529751" "HCD2855875"
 
# multiple sclerosis
multiple_sclerosis <- demographics$src_subject_id[c(which(demographics$ms ==1))]  # "HCD0641341" "HCD1617450"

# seizure
seizure_ph9 <- demographics$src_subject_id[c(which(demographics$ph_9 ==1))]  # "HCD0360838" "HCD0478356" - each participant had one seizure
epilepsy_cfmh <- demographics$src_subject_id[c(which(demographics$cfmh_chd_seizure ==1))] # "HCD0641341" "HCD1277149" (not sure why these participants didn't endorse ph_9 -- 'ever went to doctor/ER for seizure')
  
# brain injury
brain_injury <- demographics$src_subject_id[c(which(demographics$seq1c_2 ==1))] # 14 participants 

# problems with heart
heart <- demographics$src_subject_id[c(which(demographics$q17_b14 ==1))] # 8 participants 

# cerebral palsy
#demographics$src_subject_id[c(which(demographics$cfmh_chd_cerpalsy ==1))] # HCD0641341
 

# knocked unconscious
unconscious <- demographics$src_subject_id[c(which(demographics$medhis_6j == 1))]
#unique(c(cancer, lead, sickle, headaches, head_injury, poisoning, multiple_sclerosis, seizure_ph9, epilepsy_cfmh, brain_injury, heart))

medical_exclusion <- unique(c(cancer, lead, sickle, poisoning, multiple_sclerosis, seizure_ph9, epilepsy_cfmh, brain_injury))
 
  
demographics_medExclusion <- demographics[-c(which(demographics$src_subject_id %in% medical_exclusion)),]
 
collated_HCPD.xcp_medExclusion <- collated_HCPD.xcp[-c(which(paste0("HCD", gsub("sub-", "", collated_HCPD.xcp$sub)) %in% medical_exclusion)),]

length(unique(collated_HCPD.xcp_medExclusion$sub)) # N=631
```

## 3) include passing T1 QC (HCP-D dataset only includes scans that passed T1 QC)
## 4) include meanFD < 0.3
```{r meanFD, cache=TRUE}

meanFD_exclude <- collated_HCPD.xcp_medExclusion[c(which(collated_HCPD.xcp_medExclusion$meanFD > 0.3)),] # 362 runs with meanFD > 0.3
 

collated_HCPD.xcp_headMotion <- collated_HCPD.xcp_medExclusion %>% filter(meanFD < 0.3) 

length(unique(collated_HCPD.xcp_headMotion$sub)) # 2 additional participants excluded by meanFD > 0.3, N=629 after excluding meanFD >= 0.3
nrow(collated_HCPD.xcp_headMotion) #5165 scans

# write.csv(collated_HCPD.xcp_headMotion, "/cbica/projects/network_replication/input/HCPD/sample_selection/collated_HCPD.xcp_headMotion_20221224.csv")
```


## 5) include scans with at least 7 minutes of scan time
```{r scan_time}
# Calculate scan time for each subject 

# load cubids summary and files csv
CUBIDS_summary <- read.csv("/cbica/projects/network_replication/input/HCPD/CUBIDS_csvs/HCPD_summary_20221201.csv")
CUBIDS_summary <- CUBIDS_summary[,-c(1:4)]

fMRIinclude <- collated_HCPD.xcp_headMotion %>% mutate(KeyGroup = paste0("datatype-func_direction-", dir, "_run-0", run, "_suffix-bold_task-", task))

# edit KeyGroup for variants
fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "0577358")))] <- paste0("acquisition-VARIANTNumVolumes_",fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "0577358")))])
fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "1529756")))] <- paste0("acquisition-VARIANTNumVolumes_",fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "1529756")))])
  
fMRIinclude_CUBIDS <- merge(fMRIinclude, CUBIDS_summary[,c(2, 17, 22)], by ="KeyGroup")
  
 

fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS %>% arrange(sub) %>% mutate(ScanTimeMinutes = NumVolumes*RepetitionTime/60) # sort dataframe by subject
fMRIinclude_CUBIDS_ScanTime <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))

# variants can be included (total scan time > 7 min)
fMRIinclude_CUBIDS_ScanTime[c(which(str_detect(fMRIinclude_CUBIDS_ScanTime$sub, "0577358"))),]
fMRIinclude_CUBIDS_ScanTime[c(which(str_detect(fMRIinclude_CUBIDS_ScanTime$sub, "1529756"))),]
 
range(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total)
 
subject_scanTime_exclude <- fMRIinclude_CUBIDS_ScanTime$sub[c(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total < 7))] # exclude participants with less than 7 min of scan time
  
fMRIinclude_CUBIDS_scanTime <- fMRIinclude_CUBIDS[-c(which(fMRIinclude_CUBIDS$sub %in% subject_scanTime_exclude)),]  
HCPD_FinalSample_CUBIDS <- fMRIinclude_CUBIDS_scanTime
length(unique(HCPD_FinalSample_CUBIDS$sub)) # N=625 (excluded 4 participants)
nrow(HCPD_FinalSample_CUBIDS) # 5159 scans

# saveRDS(HCPD_FinalSample_CUBIDS, "/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_20221226.RData")
 

fMRIinclude_CUBIDS <- readRDS("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_20221226.RData") 
 
fMRIinclude_CUBIDS_ScanTime <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 
max(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) # 42 minutes and 40 seconds
fMRIinclude_CUBIDS_NumVols <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(NumVols_Total = sum(NumVolumes))
max(fMRIinclude_CUBIDS_NumVols$NumVols_Total) # 3200 volumes

# sensitivity analysis: rest only
fMRIinclude_CUBIDS_restOnly <- fMRIinclude_CUBIDS[c(which(fMRIinclude_CUBIDS$task=="rest")),] 
dim(fMRIinclude_CUBIDS_restOnly) #2324 scans
length(unique(fMRIinclude_CUBIDS_restOnly$sub)) # N=611
```
 

# Final Demographics Dataframe
```{r final_participant_list}

HCPD_FinalSample_CUBIDS <- readRDS("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_20221226.RData")
 
final_participants <- data.frame(unique(HCPD_FinalSample_CUBIDS$sub))
names(final_participants) <- "sub" 
demographics <- demographics %>% mutate(sub = gsub("HCD", "sub-", src_subject_id))
final_demographics <- merge(demographics, final_participants, by = "sub")
 

## include average of relMeansRMSMotion and meanFD across the acquisitions included in calculating connectivity matrix 
# for each subject, take average relMeansRMSMotion and meanFD
subject <- c()
ses <- c()
avg_relMeansRMSMotion_vec <- c()
avg_meanFD_vec <- c()
for(i in c(1:length(unique(HCPD_FinalSample_CUBIDS$sub)))){
  indices <- which(HCPD_FinalSample_CUBIDS$sub == unique(HCPD_FinalSample_CUBIDS$sub)[i])
  avg_RMS <- mean(as.numeric(HCPD_FinalSample_CUBIDS$relMeansRMSMotion[indices]))
  avg_meanFD <- mean(as.numeric(HCPD_FinalSample_CUBIDS$meanFD[indices]))
  subject <- append(subject, unique(HCPD_FinalSample_CUBIDS$sub)[i])
  ses <- append(ses,HCPD_FinalSample_CUBIDS$ses[indices[1]])
  avg_relMeansRMSMotion_vec <- append(avg_relMeansRMSMotion_vec, avg_RMS)
  avg_meanFD_vec <- append(avg_meanFD_vec, avg_meanFD)
}  

HCPD_avgMotion <- data.frame(cbind(subject, ses, avg_meanFD_vec, avg_relMeansRMSMotion_vec))
names(HCPD_avgMotion) <- c("sub", "ses", "meanFD_avgSes", "relMeansRMSMotion_avgSes")
HCPD_avgMotion$meanFD_avgSes <- as.numeric(HCPD_avgMotion$meanFD_avgSes)
HCPD_avgMotion$relMeansRMSMotion_avgSes <- as.numeric(HCPD_avgMotion$relMeansRMSMotion_avgSes)
final_dem_df <- merge(final_demographics, HCPD_avgMotion, by="sub")
   
# write.csv(final_dem_df, "/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_demographics_finalsample_20221226.csv")
final_dem_df_hcpd <- read.csv("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_demographics_finalsample_20221226.csv")

unique(final_dem_df_hcpd$race)
length(which(final_dem_df_hcpd$race=="Hawaiian or Pacific Islander"))/nrow(final_dem_df_hcpd)
# white = 395 - 63.2%
# asian = 48 - 7.7%%
# black = 69 - 11%
# other (native american) = 3 - 0.48%
# missing = 15 - 2.4%
# mixed = 94 - 15%

sd(final_dem_df_hcpd$interview_age/12) # mean=14.5, SD=4.1
length(which(final_dem_df$sex=="F")) # 337 females
```


# Final CIFTI File list (for creating connectivity matrices)
```{r ciftiFile_list, include=FALSE, cache=TRUE}
  
HCPD_FinalSample_CUBIDS <- readRDS("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_20221226.RData")
 
atlases <- c("Glasser", "Gordon", "Schaefer217", "Schaefer417")
subject_list <- list()
ptseries_filenames <- list()
task_list <- list()
direction_list <- list()
run_list <- list()
atlas_list <- list()
 
for (i in c(1:nrow(HCPD_FinalSample_CUBIDS))) {
  for (j in c(1:length(atlases))){
  atlas <- atlases[j]
  subject <- HCPD_FinalSample_CUBIDS$sub[i]
  task <- HCPD_FinalSample_CUBIDS$task[i]
  direction <- HCPD_FinalSample_CUBIDS$dir[i]
  run <- HCPD_FinalSample_CUBIDS$run[i]
  task_list <- append(task, task_list)
  direction_list <- append(direction, direction_list)
  run_list <- append(run, run_list)
  atlas_list <- append(atlas, atlas_list)
  subject_list <- append(subject, subject_list)
  if (subject == "sub-1529756" | subject == "sub-0577358") {
  file <- paste0(subject, "_ses-V1_task-", task, "_acq-VARIANTNumVolumes_dir-", direction, "_run-", run, "_space-fsLR_atlas-", atlas, "_den-91k_timeseries.ptseries.nii")
  } else {
  file <- paste0(subject, "_ses-V1_task-", task, "_dir-", direction, "_run-", run, "_space-fsLR_atlas-", atlas, "_den-91k_timeseries.ptseries.nii")

  }
  ptseries_filenames <- append(file, ptseries_filenames)
  #print(paste(task, direction, atlas))
  }
  print(paste(subject, "done", i, "/", nrow(HCPD_FinalSample_CUBIDS)))
}

  
filenamesDF <- as.data.frame(do.call(rbind, ptseries_filenames))
subject_namesDF <- as.data.frame(do.call(rbind, subject_list))
task_namesDF <- as.data.frame(do.call(rbind, task_list))
direction_namesDF <- as.data.frame(do.call(rbind, direction_list))
run_namesDF <- as.data.frame(do.call(rbind, run_list))
atlas_namesDF <- as.data.frame(do.call(rbind, atlas_list))
  
file_paths <- as.data.frame(cbind(subject_namesDF, task_namesDF, direction_namesDF, run_namesDF, atlas_namesDF, filenamesDF))
names(file_paths) <- c("subject", "task", "direction", "run", "atlas", "filenames")
 
file_paths <- file_paths %>% mutate(path = paste0("/cbica/projects/network_replication/input/HCPD/hcpd_xcp/", subject, "/", filenames)) %>% mutate(sub_task_direction_run = paste0(subject, "_", task, "_", direction, "_", run))
HCPD_FinalSample_CUBIDS <- HCPD_FinalSample_CUBIDS %>% mutate(sub_task_direction_run = paste0(sub, "_", task, "_", dir, "_", run))
file_paths_restOnly <- file_paths[which(file_paths$task == "rest"),]

file_paths_FINAL <- merge(file_paths, HCPD_FinalSample_CUBIDS[, c(1, ncol(HCPD_FinalSample_CUBIDS))], by = "sub_task_direction_run") 
file_paths_restOnly_FINAL <- merge(file_paths_restOnly, HCPD_FinalSample_CUBIDS[, c(1, ncol(HCPD_FinalSample_CUBIDS))], by = "sub_task_direction_run")
 
length(unique(file_paths_FINAL$sub_task_direction_run)) # 5159 scans 
length(unique(file_paths_FINAL$subject)) #N=625

length(unique(file_paths_restOnly_FINAL$sub_task_direction_run)) # 2324 scans
length(unique(file_paths_restOnly_FINAL$subject)) #N=611
  
HCPD_qc_filenames_atlases <- list(HCPD_FinalSample_CUBIDS, file_paths_FINAL) 
HCPD_qc_filenames_atlases_restOnly <- list(HCPD_FinalSample_CUBIDS[c(which(HCPD_FinalSample_CUBIDS$task=="rest")),], file_paths_restOnly_FINAL) 
 
# saveRDS(HCPD_qc_filenames_atlases, "/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_20221227.RData")
# saveRDS(HCPD_qc_filenames_atlases_restOnly, "/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_restOnly_20221227.RData")
 
```



# Sensitivity Analysis: Final demographics for rest only
- include participants with at least 6 minutes of rest-only scan time
```{r}

HCPD_qc_filenames_atlases_restOnly <- readRDS("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_restOnly_20221227.RData")

### Include participants with >= 6 minutes of resting state fMRI
fMRIinclude_CUBIDS_ScanTime_restOnly <- HCPD_qc_filenames_atlases_restOnly[[1]] %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
 
range(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total)
fMRIinclude_CUBIDS_ScanTime_restOnly$sub[c(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total < 6))]
length(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total >= 6)) # 611


final_participants_restOnly <- data.frame(fMRIinclude_CUBIDS_ScanTime_restOnly$sub[c(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total >= 6))])
names(final_participants_restOnly) <- "sub" 
 

max(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total) #25.5 minutes

fMRIinclude_CUBIDS_NumVols_restOnly <- HCPD_qc_filenames_atlases_restOnly[[1]] %>% group_by(sub) %>% summarise(NumVolsTotal = sum(NumVolumes))
max(fMRIinclude_CUBIDS_NumVols_restOnly$NumVolsTotal) #1912 volumes


HCPD_FinalSample_CUBIDS_restOnly <- HCPD_qc_filenames_atlases_restOnly[[1]] 
HCPD_FinalSample_CUBIDS_restOnly <- merge(HCPD_FinalSample_CUBIDS_restOnly, final_participants_restOnly)

names(HCPD_qc_filenames_atlases_restOnly[[2]])[2] <- "sub"
HCPD_qc_filenames_atlases_restOnly_final <- merge(HCPD_qc_filenames_atlases_restOnly[[2]], final_participants_restOnly)
HCPD_qc_filenames_atlases_restOnly_final <- list(HCPD_FinalSample_CUBIDS_restOnly, HCPD_qc_filenames_atlases_restOnly_final)
dim(HCPD_qc_filenames_atlases_restOnly_final[[1]]) #2324 scans
#saveRDS(HCPD_qc_filenames_atlases_restOnly_final,"/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_restOnly_20230203.RData")
 
 
demographics <- demographics %>% mutate(sub = gsub("HCD", "sub-", src_subject_id))
final_demographics_restOnly <- merge(demographics, final_participants_restOnly, by = "sub")
 

## include average of relMeansRMSMotion and meanFD across the acquisitions included in calculating connectivity matrix 
# for each subject, take average relMeansRMSMotion and meanFD
subject <- c()
ses <- c()
avg_relMeansRMSMotion_vec <- c()
avg_meanFD_vec <- c()
for(i in c(1:length(unique(HCPD_FinalSample_CUBIDS_restOnly$sub)))){
  indices <- which(HCPD_FinalSample_CUBIDS_restOnly$sub == unique(HCPD_FinalSample_CUBIDS_restOnly$sub)[i])
  avg_RMS <- mean(as.numeric(HCPD_FinalSample_CUBIDS_restOnly$relMeansRMSMotion[indices]))
  avg_meanFD <- mean(as.numeric(HCPD_FinalSample_CUBIDS_restOnly$meanFD[indices]))
  subject <- append(subject, unique(HCPD_FinalSample_CUBIDS_restOnly$sub)[i])
  ses <- append(ses,HCPD_FinalSample_CUBIDS_restOnly$ses[indices[1]])
  avg_relMeansRMSMotion_vec <- append(avg_relMeansRMSMotion_vec, avg_RMS)
  avg_meanFD_vec <- append(avg_meanFD_vec, avg_meanFD)
}  
 

HCPD_avgMotion <- data.frame(cbind(subject, ses, avg_meanFD_vec, avg_relMeansRMSMotion_vec))
names(HCPD_avgMotion) <- c("sub", "ses", "meanFD_avgSes", "relMeansRMSMotion_avgSes")
HCPD_avgMotion$meanFD_avgSes <- as.numeric(HCPD_avgMotion$meanFD_avgSes)
HCPD_avgMotion$relMeansRMSMotion_avgSes <- as.numeric(HCPD_avgMotion$relMeansRMSMotion_avgSes)
final_dem_restOnly_df <- merge(final_demographics_restOnly, HCPD_avgMotion, by="sub")
   
# write.csv(final_dem_restOnly_df, "/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_demographics_finalsample_restOnly_20230103.csv")
 
final_dem_restOnly_df <- read.csv("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_demographics_finalsample_restOnly_20230103.csv")

length(which(final_dem_restOnly_df$sex=="F")) # 329 females

 
```


# Variants
```{r}

HCPD_FinalSample_withCUBIDS <- readRDS("/cbica/projects/network_replication/input/HCPD/sample_selection/HCPD_FinalSample_withCUBIDS_20221226.RData")  

HCPD_FinalSample_withCUBIDS[c(which(str_detect(HCPD_FinalSample_withCUBIDS$sub, "0577358") | str_detect(HCPD_FinalSample_withCUBIDS$sub, "1529756"))),] # 9 scans

```


# Extras
## Figures
Distribution of scan time per participant (N=629) -- before excluding for scan time
```{r numVolumes_fig_setup, include=FALSE, cache=TRUE, fig.height=6, fig.width=6}

CUBIDS_summary <- read.csv("/cbica/projects/network_replication/input/HCPD/CUBIDS_csvs/HCPD_summary_20221201.csv")
CUBIDS_summary <- CUBIDS_summary[,-c(1:4)]

fMRIinclude <- collated_HCPD.xcp_headMotion %>% mutate(KeyGroup = paste0("datatype-func_direction-", dir, "_run-", run, "_suffix-bold_task-", task))

 
# edit KeyGroup for variants
fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "0577358")))] <- paste0("acquisition-VARIANTNumVolumes_",fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "0577358")))])
fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "1529756")))] <- paste0("acquisition-VARIANTNumVolumes_",fMRIinclude$KeyGroup[c(which(str_detect(fMRIinclude$sub, "1529756")))])
  
fMRIinclude_CUBIDS <- merge(fMRIinclude, CUBIDS_summary[,c(2, 17, 22)], by ="KeyGroup")
 
 

fMRIinclude_CUBIDS <- fMRIinclude_CUBIDS %>% arrange(sub) %>% mutate(ScanTimeMinutes = NumVolumes*RepetitionTime/60) # sort dataframe by subject
fMRIinclude_CUBIDS_ScanTime <- fMRIinclude_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))

  
length(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total == max(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total))) #454
length(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total < max(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total) & fMRIinclude_CUBIDS_ScanTime$ScanTime_Total >= 15)) # 152
length(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total < 15 & fMRIinclude_CUBIDS_ScanTime$ScanTime_Total >= 10)) # 4
length(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total < 10)) # 19
length(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total == min(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total))) # 1
 
 
ScanTime_fig_HCPD <- ggplot(fMRIinclude_CUBIDS_ScanTime, aes(x=ScanTime_Total)) +
  geom_histogram(position="identity", alpha=0.5, bins=40, colour = "#24A6A8FF", fill = "#24A6A8FF") + 
  theme_classic(base_size=16) +  
  annotate(geom="text", x=7, y=450, label="Total N = 648", color="black", fontface="bold", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=350, label="Tasks: Carit, Guessing, Emotion, Rest \nTR = 800ms with \nNumVol=290, 270, 168, and 478", color="black", fontface="bold", size=5, hjust=0) +
  annotate(geom="text", x=7, y=250, label="Max Scan Time 42.7 min: N = 454", color="black", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=220, label="15 min <= Scan Time < 42.7 min: N = 152", color="black", size=5, hjust=0) +
  annotate(geom="text", x=7, y=190, label="10 min <= Scan Time < 15 min: N = 4", color="black", size=5, hjust=0) +
  annotate(geom="text", x=7, y=160, label="Scan Time < 10 min: N = 19", color="black", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=110, label="Minimum Scan Time 2.24 min: N = 1", color="black", size=5 , hjust=0) + 
  ggtitle("Histogram of Total Scan Time (in Minutes): \n HCP-D")
 

#rest only
fMRIinclude_CUBIDS_restOnly <- fMRIinclude_CUBIDS %>% filter(task=="rest")
fMRIinclude_CUBIDS_ScanTime_restOnly <- fMRIinclude_CUBIDS_restOnly %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
length(unique(fMRIinclude_CUBIDS_restOnly$sub))

length(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total == max(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total))) #532
length(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total < max(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total) & fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total >= 15)) # 42
length(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total < 15 & fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total >= 10)) # 29
length(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total < 10)) # 8
length(which(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total == min(fMRIinclude_CUBIDS_ScanTime_restOnly$ScanTime_Total))) # 8
 
 
ScanTime_fig_HCPD_restOnly <- ggplot(fMRIinclude_CUBIDS_ScanTime_restOnly, aes(x=ScanTime_Total)) +
  geom_histogram(position="identity", alpha=0.5, bins=25, colour = "#24A6A8FF", fill = "#24A6A8FF") + 
  theme_classic(base_size=16) +  
  annotate(geom="text", x=7, y=450, label="Total N = 630", color="black", fontface="bold", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=350, label="Rest Only \nTR = 800ms with NumVol=478", color="black", fontface="bold", size=5, hjust=0) +
  annotate(geom="text", x=7, y=250, label="Max Scan Time 25.5 min: N = 532", color="black", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=220, label="15 min <= Scan Time < 25.5 min: N = 42", color="black", size=5, hjust=0) +
  annotate(geom="text", x=7, y=190, label="10 min <= Scan Time < 15 min: N = 29", color="black", size=5, hjust=0) +
  annotate(geom="text", x=7, y=160, label="Scan Time < 10 min: N = 8", color="black", size=5, hjust=0) + 
  annotate(geom="text", x=7, y=110, label="Minimum Scan Time 6.37 min: N = 8", color="black", size=5 , hjust=0) + 
  ggtitle("Histogram of Total Scan Time \nRest Only (in Minutes): \nHCP-D")
 

 
# number of participants with all task and rest runs -- 2 guessing, 2 carit, 1 emotion, 4 rest
length(which(fMRIinclude_CUBIDS_ScanTime$ScanTime_Total > 42)) # Participants with all task and rest runs available: N = 454 
 
fMRIinclude_scans <- fMRIinclude_CUBIDS %>% group_by(sub) %>% count(task, sort=TRUE)

# need to count up how many people are missing rest, carit, guessing, and emotion
 
 
missing_rest_scans <- setdiff(unique(fMRIinclude_scans$sub), fMRIinclude_scans$sub[which(fMRIinclude_scans$task == "rest")])
missing_rest_rows <- cbind(missing_rest_scans, rep("rest", length(missing_rest_scans)), rep(0, length(missing_rest_scans)))

missing_carit_scans <- setdiff(unique(fMRIinclude_scans$sub), fMRIinclude_scans$sub[which(fMRIinclude_scans$task == "carit")])
missing_carit_rows <- cbind(missing_carit_scans, rep("carit", length(missing_carit_scans)), rep(0, length(missing_carit_scans)))


missing_guessing_scans <- setdiff(unique(fMRIinclude_scans$sub), fMRIinclude_scans$sub[which(fMRIinclude_scans$task == "guessing")])
missing_guessing_rows <- cbind(missing_guessing_scans, rep("guessing", length(missing_guessing_scans)), rep(0, length(missing_guessing_scans)))

missing_emotion_scans <- setdiff(unique(fMRIinclude_scans$sub), fMRIinclude_scans$sub[which(fMRIinclude_scans$task == "emotion")])
missing_emotion_rows <- cbind(missing_emotion_scans, rep("emotion", length(missing_emotion_scans)), rep(0, length(missing_emotion_scans)))



fMRIinclude_scans_ALL <- as.data.frame(rbind(missing_rest_rows, missing_carit_rows, missing_guessing_rows, missing_emotion_rows))
names(fMRIinclude_scans_ALL) <- names(fMRIinclude_scans)
fMRIinclude_scans_ALL$n <- as.integer(fMRIinclude_scans_ALL$n)

fMRIinclude_scans_ALL <- rbind(fMRIinclude_scans, fMRIinclude_scans_ALL)
 
scans_per_task_fig <- ggplot(fMRIinclude_scans_ALL, aes(x=n, color=task, fill=task)) +
  geom_bar(alpha=0.5, position="dodge", bins=5, width=0.5) + 
  theme_classic() +
  ggtitle("Numbers of task or rest runs per participant") +
  annotate(geom="text", x=2, y=650, label="Total scans for carit and guessing = 2 \n Total scans for emotion = 1 \n Total scans for rest = 4", color="black", fontface="bold") +
  ylim(0, 750)
# most people have the right number of scans 
```

```{r ScanTime_fig_HCPD, cache=TRUE, fig.height=5, fig.width=5}

ScanTime_fig_HCPD
```

```{r ScanTime_fig_restOnly_HCPD, cache=TRUE, fig.height=4, fig.width=5}
 
ScanTime_fig_HCPD_restOnly

```
 

```{r scatterplot_meanFD_RMSmotion, fig.height=4, fig.width=4}
 
ggplot(collated_HCPD.xcp, aes(x=as.numeric(meanFD), y=as.numeric(relMeansRMSMotion))) + 
  geom_point(alpha = 0.7, size = 2, color = '#88419D') + 
  theme(axis.text.x=element_text(size=32), axis.title.x=element_text(size=28), axis.title.y=element_text(size=28)) + 
  ggtitle("MeanFD vs relMeansRMSMotion in HCP-D") + 
  labs(x="MeanFD", y="RelMeansRMSMotion", shape = "", color = "") + 
  theme_classic() +
  stat_cor(method = "spearman",size = 4, r.digits = 3)
```

 

 

```{r scans_per_task_fig, include=FALSE, cache=TRUE}
(scans_per_task_fig <- ggplot(fMRIinclude_scans_ALL, aes(x=n, color=task, fill=task)) +
  geom_bar(alpha=0.5, position="dodge", bins=5, width=0.5) + 
  theme_classic() +
  ggtitle("HCP-D: Numbers of task or rest runs per participant") +
  annotate(geom="text", x=2, y=650, label="Total scans for carit and guessing = 2 \n Total scans for emotion = 1 \n Total scans for rest = 4", color="black", fontface="bold") +
  ylim(0, 750))

```

 
## Mean FD thresholds (no T1 QA applied!)
- included only age 5-22
```{r}

# checking how many subjects would be excluded with different meanFD filters (pre-QC). If BAS1 is missing or gets excluded by QC, then use FLU1
length(which(collated_HCPD.xcp$meanFD > 0.2)) # 1249 scans excluded
meanFD_02 <- collated_HCPD.xcp %>% filter(meanFD <= 0.2)
meanFD_02_casted <- dcast(meanFD_02[,c(1,3)], sub~task)
length(unique(meanFD_02$sub)) #624 subjects included
 
length(which(collated_HCPD.xcp$meanFD > 0.3)) # 373 scans excluded
meanFD_03 <- collated_HCPD.xcp %>% filter(meanFD <= 0.3)
meanFD_03_casted <- dcast(meanFD_03[,c(1,3)], sub~task)
length(unique(meanFD_03$sub)) #648 subjects included
 
length(which(collated_HCPD.xcp$meanFD > 0.4)) # 141 scans
meanFD_04 <- collated_HCPD.xcp %>% filter(meanFD <= 0.4)
meanFD_04_casted <- dcast(meanFD_04[,c(1,3)], sub~task)
length(unique(meanFD_04$sub)) # 649 subjects included


CUBIDS_summary <- read.csv("/cbica/projects/network_replication/input/HCPD/CUBIDS_csvs/HCPD_summary_20221201.csv")
CUBIDS_summary <- CUBIDS_summary[,-c(1:4)]
   
meanFD_02 <- meanFD_02 %>% mutate(KeyGroup = paste0("datatype-func_direction-", dir, "_run-", run, "_suffix-bold_task-", task))
meanFD_02_CUBIDS <- merge(meanFD_02, CUBIDS_summary[,c(2, 17,22)], by ="KeyGroup") 
meanFD_02_CUBIDS <- meanFD_02_CUBIDS %>% arrange(sub) %>% mutate(ScanTimeMinutes = NumVolumes*RepetitionTime/60) # sort dataframe by subject

meanFD_03 <- meanFD_03 %>% mutate(KeyGroup = paste0("datatype-func_direction-", dir, "_run-", run, "_suffix-bold_task-", task))
meanFD_03_CUBIDS <- merge(meanFD_03, CUBIDS_summary[,c(2, 17,22)], by ="KeyGroup") 
meanFD_03_CUBIDS <- meanFD_03_CUBIDS %>% arrange(sub) %>% mutate(ScanTimeMinutes = NumVolumes*RepetitionTime/60) # sort dataframe by subject

meanFD_04 <- meanFD_04 %>% mutate(KeyGroup = paste0("datatype-func_direction-", dir, "_run-", run, "_suffix-bold_task-", task))
meanFD_04_CUBIDS <- merge(meanFD_04, CUBIDS_summary[,c(2, 17,22)], by ="KeyGroup") 
meanFD_04_CUBIDS <- meanFD_04_CUBIDS %>% arrange(sub) %>% mutate(ScanTimeMinutes = NumVolumes*RepetitionTime/60) # sort dataframe by subject

meanFD_02_ScanTime <- meanFD_02_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
meanFD_03_ScanTime <- meanFD_03_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))
meanFD_04_ScanTime <- meanFD_04_CUBIDS %>% group_by(sub) %>% summarise(ScanTime_Total = sum(ScanTimeMinutes))

length(which(meanFD_02_ScanTime$ScanTime_Total >= 4)) #604
length(which(meanFD_02_ScanTime$ScanTime_Total >= 10)) #566
length(which(meanFD_02_ScanTime$ScanTime_Total >= 15)) #546

length(which(meanFD_03_ScanTime$ScanTime_Total >= 4)) # 646
length(which(meanFD_03_ScanTime$ScanTime_Total >= 10)) #629
length(which(meanFD_03_ScanTime$ScanTime_Total >= 15)) #626

length(which(meanFD_04_ScanTime$ScanTime_Total >= 4)) #649
length(which(meanFD_04_ScanTime$ScanTime_Total >= 10)) #633
length(which(meanFD_04_ScanTime$ScanTime_Total >= 15)) #633

 
```

 
